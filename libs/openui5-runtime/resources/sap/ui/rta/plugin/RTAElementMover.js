/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/dt/plugin/ElementMover','sap/ui/dt/OverlayUtil','sap/ui/dt/ElementUtil','sap/ui/fl/Utils','sap/ui/rta/Utils','sap/ui/rta/command/CommandFactory','sap/ui/rta/plugin/Plugin','sap/ui/dt/OverlayRegistry','sap/ui/rta/util/BindingsExtractor'],function(E,O,a,F,U,C,P,b,B){"use strict";var R=E.extend("sap.ui.rta.plugin.RTAElementMover",{metadata:{library:"sap.ui.rta",properties:{commandFactory:{type:"any",defaultValue:C},movableTypes:{type:"string[]",defaultValue:["sap.ui.core.Element"]}},associations:{},events:{}}});R.prototype.init=function(){this.oBasePlugin=new P({commandFactory:this.getCommandFactory()});};R.prototype.exit=function(){this.oBasePlugin.destroy();};R.prototype.setCommandFactory=function(c){this.setProperty("commandFactory",c);this.oBasePlugin.setCommandFactory(c);};function i(o){var v=false,d=o.getDesignTimeMetadata(),p=o.getParentElementOverlay(),c;if(!d||!p){return false;}var r=o.getRelevantContainer();var e=sap.ui.dt.OverlayRegistry.getOverlay(r);if(!U.getRelevantContainerDesigntimeMetadata(o)){return false;}var m=this._getMoveAction(o);if(m&&m.changeType){c=o.getRelevantContainer();v=this.oBasePlugin.hasChangeHandler(m.changeType,c);}if(v){v=this.oBasePlugin.hasStableId(o)&&this.oBasePlugin.hasStableId(p)&&this.oBasePlugin.hasStableId(e);}return v;}function h(A,e,r){var o=A.getDesignTimeMetadata();var m=o.getAction("move",e);if(!m){return false;}return this.oBasePlugin.hasChangeHandler(m.changeType,r);}E.prototype._getMoveAction=function(o){var p,c=o.getParentAggregationOverlay();if(c){p=c.getDesignTimeMetadata();}return p?p.getAction("move",o.getElementInstance()):undefined;};E.prototype.isMovableType=function(e){return true;};R.prototype.checkMovable=function(o){return i.call(this,o);};R.prototype.checkTargetZone=function(A){var t=E.prototype.checkTargetZone.call(this,A);if(!t){return false;}var m=this.getMovedOverlay();var M=m.getElementInstance();var T=A.getParent();var o=m.getRelevantContainer();var c=T.getElementInstance();var v=A.getDesignTimeMetadata().getRelevantContainerForPropagation(M);v=v?v:c;if(!o||!v||!P.prototype.hasStableId(T)||o!==v){return false;}if(m.getParent().getElementInstance()!==c){var d=B.getBindings(M,M.getModel());if(Object.keys(d).length>0&&c.getBindingContext()){var s=U.getEntityTypeByPath(M.getModel(),M.getBindingContext().getPath());var e=U.getEntityTypeByPath(c.getModel(),c.getBindingContext().getPath());if(!(s===e)){return false;}}}return h.call(this,A,M,v);};R.prototype.buildMoveCommand=function(){var m=this.getMovedOverlay();var p=m.getParentAggregationOverlay();var M=m.getElementInstance();var s=this._getSource();var r=m.getRelevantContainer();var t=O.getParentInformation(m);var S=s.index;var T=t.index;var c=this._compareSourceAndTarget(s,t);if(c){return undefined;}delete s.index;delete t.index;var o=this.getCommandFactory().getCommandFor(r,"Move",{movedElements:[{element:M,sourceIndex:S,targetIndex:T}],source:s,target:t},p.getDesignTimeMetadata());return o;};return R;},true);
