/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/rta/plugin/Plugin",'sap/ui/dt/ElementUtil','sap/ui/dt/OverlayRegistry','sap/ui/rta/Utils','sap/ui/fl/Utils','sap/ui/core/StashedControlSupport','sap/ui/dt/ElementDesignTimeMetadata'],function(q,P,E,O,U,F,S,a){"use strict";function _(s,o){var p,r=o.getRelevantContainer(!s),R=O.getOverlay(r);if(s){p=o.getParentElementOverlay();}else{p=o;}return{relevantContainerOverlay:R,parentOverlay:p,relevantContainer:r,parent:p.getElementInstance()};}function b(p,C){return C.sParentAggregationName;}function c(o,s){var I=E.getAggregation(o,s).filter(function(C){var m=O.getOverlay(C);if(o.getVisible&&!o.getVisible()){return C.getVisible&&sap.ui.rta.plugin.Plugin.prototype.hasStableId(m);}return C.getVisible&&!C.getVisible()&&sap.ui.rta.plugin.Plugin.prototype.hasStableId(m);});var l=S.getStashedControls(o.getId());return I.concat(l);}var d=true,e=false;function f(r,m,p,s,C){var n=[];var l;var o;if(m.addODataProperty){var t=m.aggregation;var D=m.addODataProperty.designTimeMetadata;l=D.getAggregationDescription(t,p);if(l){o=s?l.singular:l.plural;n.push(o);}}if(m.reveal){Object.keys(m.reveal.types).forEach(function(u){var v=m.reveal.types[u];l=v.designTimeMetadata.getName(p);if(l){o=s?l.singular:l.plural;n.push(o);}});}var N=n.reduce(function(u,v){if(u.indexOf(v)===-1){u.push(v);}return u;},[]);var T=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");if(N.length===1){o=N[0];}else if(C){o=C;}else{o=T.getText("MULTIPLE_CONTROL_NAME");}return T.getText(r,o);}function g(){return{designTimeMetadata:new a({data:{name:{singular:function(){return sap.uxap.i18nModel.getResourceBundle().getText("SECTION_CONTROL_NAME");},plural:function(){return sap.uxap.i18nModel.getResourceBundle().getText("SECTION_CONTROL_NAME_PLURAL");}},actions:{reveal:{changeType:"unstashControl",getAggregationName:b}}}}),action:{changeType:"unstashControl",getAggregationName:b}};}var A=P.extend("sap.ui.rta.plugin.additionalElements.AdditionalElementsPlugin",{metadata:{library:"sap.ui.rta",properties:{analyzer:"object",dialog:"object",commandFactory:"object"},associations:{},events:{}},getContextMenuTitle:function(o,l){var p=_(o,l);var m=this._getActions(o,l);return f("CTX_ADD_ELEMENTS",m,p.parent,d);},isAvailable:function(o,l){return this._isEditable(l,o);},isEnabled:function(o,l){var p;if(o){p=l.getParentElementOverlay();if(p&&this.hasStableId(p)){return true;}else{return false;}}var m=this._getActions(o,l);if(m.reveal&&m.reveal.elements.length===0&&!m.addODataProperty){return false;}return true;},_getRevealActions:function(s,o){var p=_(s,o);var r=this._getTypes(r,p,s,o);return r;},_getTypes:function(r,p,s,o){var l=[p.parentOverlay];var R=o.getRelevantContainer(!s);if(R!==p.parent){l=E.findAllSiblingsInContainer(p.parent,R).map(function(n){return O.getOverlay(n);});}var m;if(s){m=[o.getParentAggregationOverlay().getAggregationName()];}else{m=p.parentOverlay.getAggregationOverlays().filter(function(n){return!n.getDesignTimeMetadata().isIgnored(p.parent);}).map(function(n){return n.getAggregationName();});}r=m.reduce(this._getRevealActionFromAggregations.bind(this,l),{});return r;},_getRevealActionFromAggregations:function(p,l,s){var I=p.reduce(function(m,o){return o?m.concat(c(o.getElementInstance(),s)):m;},[]);var C=function(t,o){var T=o.getMetadata().getName();if(!t[T]){if(T==="sap.ui.core._StashedControl"){t[T]=g();}else{var m=O.getOverlay(o);if(m){var D=m.getDesignTimeMetadata();var r=D&&D.getAction("reveal",o);if(r&&r.changeType){if(r.changeOnRelevantContainer){o=m.getRelevantContainer();}if(this.hasChangeHandler(r.changeType,o)){if(!r.getAggregationName){r.getAggregationName=b;}t[T]={designTimeMetadata:D,action:r};}}}}}return t;};var t=I.reduce(C.bind(this),{});I=I.filter(function(o){return!!t[o.getMetadata().getName()];});if(I.length>0&&Object.keys(t).length>0){l[s]={reveal:{elements:I,types:t}};}return l;},_getAddODataPropertyActions:function(s,o){var p=_(s,o);var D=p.parentOverlay.getDesignTimeMetadata();var l=D.getAggregationAction("addODataProperty",p.parent);var C=p.parent;var m=function(n,r){if(r){if(r.changeOnRelevantContainer){C=p.relevantContainer;}if(r.changeType&&this.hasChangeHandler(r.changeType,C)){n[r.aggregation]={addODataProperty:{designTimeMetadata:D,action:r}};}return n;}};if(l&&l.length>0){return l.reduce(m.bind(this),{});}},_getActions:function(s,o){var r=this._getRevealActions(s,o);var m=this._getAddODataPropertyActions(s,o);var l=q.extend(true,r,m);var n=Object.keys(l);if(n.length===0){return{};}else if(n.length>1){q.sap.log.error("reveal or addODataProperty action defined for more than 1 aggregation, that is not yet possible");}var p=n[0];l[p].aggregation=p;return l[p];},_hasRevealActionsOnChildren:function(o){var r=this._getRevealActions(false,o);return!!r&&Object.keys(r).length>0;},showAvailableElements:function(o,l,I,C){var m=l[0];var p=_(o,m);var s=o&&m.getElementInstance();var n=[];var r=this._getActions(o,m);if(r.reveal){n.push(this.getAnalyzer().enhanceInvisibleElements(p.parent,r));}if(r.addODataProperty){r.addODataProperty.relevantContainer=m.getRelevantContainer(!o);n.push(this.getAnalyzer().getUnboundODataProperties(p.parent,r.addODataProperty));}if(r.aggregation||C){this._setDialogTitle(r,p.parent,C);}return Promise.resolve().then(function(){if(r.addODataProperty){return U.isServiceUpToDate(p.parent);}}).then(function(){if(r.addODataProperty){this.getDialog()._oCustomFieldButton.setVisible(true);return U.isCustomFieldAvailable(p.parent);}else{this.getDialog()._oCustomFieldButton.setVisible(false);}}.bind(this)).then(function(t){if(t){this._oCurrentFieldExtInfo=t;this.getDialog().setCustomFieldEnabled(true);this.getDialog().detachEvent('openCustomField',this._onOpenCustomField,this);this.getDialog().attachEvent('openCustomField',null,this._onOpenCustomField,this);}}.bind(this)).then(i.bind(null,n)).then(function(t){this.getDialog().setElements(t);return this.getDialog().open().then(function(){this._createCommands(o,m,p,s,r.designTimeMetadata,r,I);}.bind(this)).catch(function(u){if(u instanceof Error){throw u;}});}.bind(this)).catch(function(t){if(t instanceof Error){throw t;}else{q.sap.log.info("Service not up to date, skipping add dialog","sap.ui.rta");}});},_setDialogTitle:function(m,p,C){var D=f("HEADER_ADDITIONAL_ELEMENTS",m,p,e,C);this.getDialog().setTitle(D);if(C){this.getDialog()._oList.setNoDataText(this.getDialog()._oTextResources.getText("MSG_NO_FIELDS",C.toLowerCase()));}},_onOpenCustomField:function(o){var C=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");var H=(C&&C.hrefForExternal({target:{semanticObject:"CustomField",action:"develop"},params:{businessContexts:this._oCurrentFieldExtInfo.BusinessContexts,serviceName:this._oCurrentFieldExtInfo.ServiceName,serviceVersion:this._oCurrentFieldExtInfo.ServiceVersion,entityType:this._oCurrentFieldExtInfo.EntityType}}));U.openNewWindow(H);},_createCommands:function(s,o,p,l,D,m,I){var n=this.getDialog().getSelectedElements();if(n.length>0){var C=this.getCommandFactory().getCommandFor(p.parent,"composite");n.forEach(function(r){var t;switch(r.type){case"invisible":t=this._createRevealCommandForInvisible(r,m,p,l);C.addCommand(t);t=this._createMoveCommandForInvisible(r,m,p,l,I);if(t){C.addCommand(t);}else{q.sap.log.warning("No move action configured for "+p.parent.getMetadata().getName()+", aggregation: "+m.aggregation,"sap.ui.rta");}break;case"odata":var u=p.parentOverlay.getAggregationOverlay(m.aggregation);var v=u.getDesignTimeMetadata();var w=v.getAction("addODataProperty",p.parent);var x=w.changeHandlerSettings;var R;if(x&&x.content){R=x.content.requiredLibraries;}if(R){var y=this._createCommandForAddLibrary(p,m,R,v);C.addCommand(y);}t=this._createCommandsForOData(r,m,p,l,I);C.addCommand(t);break;default:q.sap.log.error("Can't create command for untreated element.type "+r.type);}},this);this.fireElementModified({"command":C});}},_createCommandsForOData:function(s,m,p,o,I){var l=p.parentOverlay.getAggregationOverlay(m.aggregation);var n=l.getDesignTimeMetadata();var r=n.getAction("addODataProperty",p.parent);var C=r.changeHandlerSettings;var t;if(C&&C.key){t=C.key.oDataServiceVersion;}var R=p.parent;if(r.changeOnRelevantContainer){R=p.relevantContainer;}var u=U.getIndex(p.parent,o,m.aggregation,n.getData().getIndex);return this.getCommandFactory().getCommandFor(p.parent,"addODataProperty",{newControlId:U.createFieldLabelId(R,s.entityType,s.bindingPath),index:I!==undefined?I:u,bindingString:s.bindingPath,parentId:p.parent.getId(),oDataServiceVersion:t},n);},_createCommandForAddLibrary:function(p,m,r,o){var C=F.getAppComponentForControl(p.relevantContainer);var M=C.getManifest();var R=M["sap.app"].id;return this.getCommandFactory().getCommandFor(p.publicParent,"addLibrary",{reference:R,requiredLibraries:r,appComponent:C},o);},_createRevealCommandForInvisible:function(s,m,p,o){var r=s.element;var t=r.getMetadata().getName();var T=m.reveal.types[t];var D=T.designTimeMetadata;if(D.getAction("reveal").changeOnRelevantContainer){return this.getCommandFactory().getCommandFor(r,"reveal",{revealedElementId:r.getId(),directParent:p.parent},D);}else{return this.getCommandFactory().getCommandFor(r,"reveal",{},D);}},_createMoveCommandForInvisible:function(s,m,p,o,I){var r=s.element;var R=O.getOverlay(r);var t=r.getMetadata().getName();var l;if(R){l=R.getParentAggregationOverlay().getAggregationName();}else{var T=m.reveal.types[t];l=T.action.getAggregationName(p.parent,r);}var n=j(r,p,R);var u=p.parent;var v=U.getIndex(p.parent,o,l);var w=U.getIndex(n,r,l)-1;v=I!==undefined?I:k(n,u,w,v);var C;if(v!==w||p.parent!==r.getParent()){var x=O.getOverlay(r)?O.getOverlay(r).getParentAggregationOverlay():p.relevantContainerOverlay;var y=x.getDesignTimeMetadata();C=this.getCommandFactory().getCommandFor(p.relevantContainer,"move",{movedElements:[{element:r,sourceIndex:w,targetIndex:v}],source:{publicParent:p.relevantContainer,parent:n,aggregation:l},target:{publicParent:p.relevantContainer,parent:u,aggregation:l}},y);}return C;},_isEditable:function(o,l){if(l===undefined||l===null){return h.call(this,o,true)||h.call(this,o,false);}else{return h.call(this,o,l);}}});function h(o,l){var m=false;var r=U.getRelevantContainerDesigntimeMetadata(o);if(!r){return false;}var n=this._getActions(l,o);var p=_(l,o);if(n.addODataProperty){var s=n.addODataProperty.action;m=s&&s.aggregation===o.getParentAggregationOverlay().getAggregationName();}if(!m&&n.reveal){m=true;}if(!m&&!l){m=this._hasRevealActionsOnChildren(o)||this.checkAggregationsOnSelf(p.parentOverlay,"addODataProperty");}if(m){return this.hasStableId(o);}else{return false;}}function i(p){return Promise.all(p).then(function(l){var m=l[0]||[];if(m&&l[1]){m=m.concat(l[1]);}return m;});}function j(r,p,R){var o;if(R){o=R.getParentElementOverlay().getElementInstance();}if(!o&&r.sParentId){o=sap.ui.getCore().byId(r.sParentId);}else if(!o){o=p.parent;}return o;}function k(s,t,l,T){if(s===t&&l<T&&l>-1){return T-1;}return T;}return A;});
