/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/base/ManagedObject','sap/ui/rta/command/Stack','sap/ui/fl/FlexControllerFactory','sap/ui/fl/Utils','sap/ui/rta/ControlTreeModifier'],function(M,C,F,a,R){"use strict";var L=M.extend("sap.ui.rta.command.LREPSerializer",{metadata:{library:"sap.ui.rta",associations:{"rootControl":{type:"sap.ui.core.Control"}},properties:{"commandStack":{type:"object"}},aggregations:{}}});L.prototype.setCommandStack=function(c){this.setProperty("commandStack",c);c.attachCommandExecuted(function(e){this.handleCommandExecuted(e);}.bind(this));};L.prototype.handleCommandExecuted=function(e){var p=e.getParameters();var c=this.getCommandStack().getSubCommands(p.command);if(p.undo){var f;c.forEach(function(o){var b=o.getPreparedChange();var A=o.getAppComponent();f=F.createForControl(A);if(o instanceof sap.ui.rta.command.FlexCommand){var g=R.bySelector(b.getSelector(),A);f.removeFromAppliedChangesOnControl(b,A,g);}f.deleteChange(b);});}else{var d=[];c.forEach(function(o){if(o instanceof sap.ui.rta.command.FlexCommand){var A=o.getAppComponent();var f=F.createForControl(A);f.addPreparedChange(o.getPreparedChange(),A);}else if(o instanceof sap.ui.rta.command.AppDescriptorCommand){d.push(o.createAndStore());}});return Promise.all(d);}};L.prototype.saveCommands=function(){var r=sap.ui.getCore().byId(this.getRootControl());if(!r){throw new Error("Can't save commands without root control instance!");}var f=F.createForControl(r);return f.saveAll().then(function(){var c=a.getComponentClassName(sap.ui.getCore().byId(this.getRootControl())).replace(".Component","");var r=sap.ui.getCore().byId(this.getRootControl());var A=a.getAppVersionFromManifest(a.getAppComponentForControl(r).getManifest());f=F.create(c,A);return f.saveAll();}.bind(this)).then(function(){jQuery.sap.log.info("UI adaptation successfully transfered changes to layered repository");this.getCommandStack().removeAllCommands();}.bind(this));};return L;},true);
