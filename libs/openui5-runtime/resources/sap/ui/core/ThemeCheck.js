/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/Device','sap/ui/Global','sap/ui/base/Object','sap/ui/thirdparty/URI','jquery.sap.script'],function(q,D,G,B,U){"use strict";var m=150;var T=B.extend("sap.ui.core.ThemeCheck",{constructor:function(C){this._oCore=C;this._iCount=0;this._CUSTOMCSSCHECK=/\.sapUiThemeDesignerCustomCss/i;this._CUSTOMID="sap-ui-core-customcss";this._customCSSAdded=false;this._themeCheckedForCustom=null;this._sFallbackTheme=null;this._mThemeFallback={};},getInterface:function(){return this;},fireThemeChangedEvent:function(o){c(this);d.apply(this,[true]);if(!o&&!this._sThemeCheckId){this._oCore.fireThemeChanged({theme:this._oCore.getConfiguration().getTheme()});}}});T.themeLoaded=false;T.checkStyle=function(i,l){var s=document.getElementById(i);try{var n=false,L=false,S=false,I=false;n=!s;L=!!(s&&(s.getAttribute("data-sap-ui-ready")==="true"||s.getAttribute("data-sap-ui-ready")==="false"));try{S=!!(s&&s.sheet&&s.sheet.href===s.href&&s.sheet.cssRules&&s.sheet.cssRules.length>0);}catch(e){if(e.name!=='SecurityError'&&e.name!=='InvalidAccessError'){throw e;}}I=!!(s&&s.innerHTML&&s.innerHTML.length>0);var r=n||S||I||L;if(l){q.sap.log.debug("ThemeCheck: "+i+": "+r+" (noLinkElement: "+n+", sheet: "+S+", innerHtml: "+I+", linkElementFinishedLoading: "+L+")");}return r;}catch(e){if(l){q.sap.log.error("ThemeCheck: "+i+": Error during check styles '"+i+"'",e);}}return false;};function c(t){T.themeLoaded=false;if(t._sThemeCheckId){q.sap.clearDelayedCall(t._sThemeCheckId);t._sThemeCheckId=null;t._iCount=0;t._sFallbackTheme=null;t._mThemeFallback={};}}function a(t){var l=t._oCore.getLoadedLibraries();var s=t._oCore.getConfiguration().getTheme();var p=t._oCore._getThemePath("sap.ui.core",s)+"custom.css";var r=true;var f=[];if(!!t._customCSSAdded&&t._themeCheckedForCustom===s){l[t._CUSTOMID]={};}function e(h){var S="sap-ui-theme-"+h;var i=T.checkStyle(S,true);r=r&&i;if(r){if(t._themeCheckedForCustom!=s){if(b(t,h)){var C=p;var L=t._oCore._getLibraryCssQueryParams(l["sap.ui.core"]);if(L){C+=L;}q.sap.includeStyleSheet(C,t._CUSTOMID);t._customCSSAdded=true;q.sap.log.warning("ThemeCheck delivered custom CSS needs to be loaded, Theme not yet applied");t._themeCheckedForCustom=s;r=false;return false;}else{var j=q("LINK[id='"+t._CUSTOMID+"']");if(j.length>0){j.remove();q.sap.log.debug("Custom CSS removed");}t._customCSSAdded=false;}}}if(i&&!t._mThemeFallback[h]){var o=document.getElementById(S);if(o&&o.getAttribute("data-sap-ui-ready")==="false"){f.push(h);}}}q.each(l,e);if(f.length>0){if(!t._sFallbackTheme){t._sFallbackTheme=g(l);}if(t._sFallbackTheme){f.forEach(function(h){var S="sap-ui-theme-"+h;var o=document.getElementById(S);q.sap.log.warning("Custom theme '"+s+"' could not be loaded for library '"+h+"'. "+"Falling back to its base theme '"+t._sFallbackTheme+"'.");t._oCore._updateThemeUrl(o,t._sFallbackTheme);t._mThemeFallback[h]=true;});r=false;}}if(!r){q.sap.log.warning("ThemeCheck: Theme not yet applied.");}else{t._themeCheckedForCustom=s;}return r;}function g(l){function e(L){var s="sapThemeMetaData-UI5-"+L.replace(/\./g,"-");var h=document.documentElement;h.classList.add(s);var f=window.getComputedStyle(h).getPropertyValue("background-image");h.classList.remove(s);var i=/\(["']?data:text\/plain;utf-8,(.*?)['"]?\)/i.exec(f);if(!i||i.length<2){return null;}var M=i[1];if(M.charAt(0)!=="{"&&M.charAt(M.length-1)!=="}"){try{M=decodeURI(M);}catch(j){}}M=M.replace(/\\"/g,'"');M=M.replace(/%20/g," ");try{return JSON.parse(M);}catch(j){return null;}}for(var L in l){if(l.hasOwnProperty(L)){var t=e(L);if(t&&t.Extends&&t.Extends[0]){return t.Extends[0];}}}return null;}function b(t,l){var f=q.sap.domById("sap-ui-theme-"+l);if(!f){return false;}var s=window.getComputedStyle(f,':after');var h=s?s.getPropertyValue('content'):null;if(!h&&D.browser.safari){var j=document.documentElement;j.classList.add("sapUiThemeDesignerCustomCss");h=window.getComputedStyle(j,":after").getPropertyValue("content");j.classList.remove("sapUiThemeDesignerCustomCss");}if(h&&h!=="none"){try{if(h[0]==="'"||h[0]==='"'){h=h.substring(1,h.length-1);}return h==="true";}catch(e){q.sap.log.error("Custom check: Error parsing JSON string for custom.css indication.",e);}}var r;try{if(f.sheet&&f.sheet.cssRules){r=f.sheet.cssRules;}}catch(e){if(e.name!=='SecurityError'&&e.name!=='InvalidAccessError'){throw e;}}if(!r||r.length==0){q.sap.log.warning("Custom check: Failed retrieving a CSS rule from stylesheet "+l);return false;}for(var i=0;(i<2&&i<r.length);i++){if(t._CUSTOMCSSCHECK.test(r[i].selectorText)){return true;}}return false;}function d(f){this._iCount++;var e=this._iCount>m;if(!a(this)&&!e){var i;if(this._iCount<=100){i=2;}else if(this._iCount<=110){i=500;}else{i=1000;}this._sThemeCheckId=q.sap.delayedCall(i,this,d);}else if(!f){c(this);T.themeLoaded=true;this._oCore.fireThemeChanged({theme:this._oCore.getConfiguration().getTheme()});if(e){q.sap.log.warning("ThemeCheck: max. check cycles reached.");}}else{T.themeLoaded=true;}}return T;});
