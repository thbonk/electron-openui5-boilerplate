/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/BindingParser','sap/ui/base/ManagedObject','sap/ui/core/XMLTemplateProcessor','sap/ui/model/BindingMode','sap/ui/model/CompositeBinding','sap/ui/model/Context'],function(q,B,M,X,a,C,b){'use strict';var u={},N="http://schemas.sap.com/sapui5/extension/sap.ui.core.template/1",x="sap.ui.core.util.XMLPreprocessor",p=[x],P=x+"/insertFragment",s=x+"/getResolvedBinding",c=x+".process",v={},W=M.extend("sap.ui.core.util._with",{metadata:{properties:{any:"any"},aggregations:{child:{multiple:false,type:"sap.ui.core.util._with"}}}}),R=W.extend("sap.ui.core.util._repeat",{metadata:{aggregations:{list:{multiple:true,type:"n/a",_doesNotRequireFactory:true}}},updateList:function(){}});function d(w,S,i,j){function k(n){if(!j){j=w.getBinding("any");if(j instanceof C){j=j.getBindings();if(i!==undefined){j=j[i];}}}return Array.isArray(j)?j[n]:j;}function m(o){return o instanceof b?o.getPath():o.getModel().resolve(o.getPath(),o.getContext());}return{getInterface:function(n,o){var t,y,z;if(typeof n==="string"){o=n;n=undefined;}k();if(Array.isArray(j)){if(n>=0&&n<j.length){y=j[n];}else{throw new Error("Invalid index of part: "+n);}}else if(n!==undefined){throw new Error("Not the root formatter of a composite binding");}else if(o){y=j;}else{throw new Error("Missing path");}if(o){z=y.getModel();if(o.charAt(0)!=='/'){t=y instanceof b?y:z.createBindingContext(y.getPath(),y.getContext());}y=z.createBindingContext(o,t);if(!y){throw new Error("Model could not create binding context synchronously: "+z);}}return d(null,S,undefined,y);},getModel:function(n){var o=k(n);return o&&o.getModel();},getPath:function(n){var o=k(n);return o&&m(o);},getSetting:function(n){if(n==="bindingContexts"||n==="models"){throw new Error("Illegal argument: "+n);}return S[n];}};}function g(w,o,S,j){function k(I,i){var F=I.formatter;I.mode=a.OneTime;if(F&&F.requiresIContext===true){I.formatter=F.bind(null,d(w,S,i));}I.parameters=I.parameters||{};I.parameters.scope=j;}try{k(o);if(o.parts){o.parts.forEach(k);}w.bindProperty("any",o);return w.getBinding("any")?w.getAny():u;}finally{w.unbindProperty("any",true);}}function e(E,L){return E.namespaceURI===N&&l(E)===L;}function l(E){return E.localName||E.baseName;}function r(E){var m=E.getAttribute("template:require");if(m){q.sap.require.apply(q.sap,m.split(" "));}}function f(E){var A,o=E.attributes,t="<"+E.nodeName,i,n;for(i=0,n=o.length;i<n;i+=1){A=o.item(i);t+=" "+A.name+'="'+A.value+'"';}return t+(E.childNodes.length?">":"/>");}function h(E,i){i.visitNode(E);}return{plugIn:function(V,n,L){var o=v[n];if(V!==null&&typeof V!=="function"||V===h){throw new Error("Invalid visitor: "+V);}if(!n||n===N||n==="sap.ui.core"||n.indexOf(" ")>=0){throw new Error("Invalid namespace: "+n);}q.sap.log.debug("Plug-in visitor for namespace '"+n+"', local name '"+L+"'",V,x);if(L){n=n+" "+L;o=v[n]||o;}v[n]=V;return o||h;},visitNodeWrapper:h,process:function(o,V,S){var j=V.caller,D=q.sap.log.isLoggable(q.sap.log.Level.DEBUG,x),k=D,m=V.name,F={},t,w=0,y={},z=V._supportInfo,A=q.sap.log.isLoggable(q.sap.log.Level.WARNING,x);function E(i){return{getContext:function(n){var h1,i1,j1;n=n||"";if(n[0]==="{"){throw new Error("Must be a simple path, not a binding: "+n);}h1=B.simpleParser("{"+n+"}");i1=i.getModel(h1.model);if(!i1){throw new Error("Unknown model '"+h1.model+"': "+n);}j1=i1.resolve(h1.path,i.getBindingContext(h1.model));if(!j1){throw new Error("Cannot resolve path: "+n);}return i1.createBindingContext(j1);},getResult:function(n,h1){var i1=O(n,h1,i,true);if(i1===u){throw new Error("Binding not ready: "+n);}return i1;},getSettings:function(){return S;},getViewInfo:function(){return q.extend(true,{},V);},insertFragment:function(n,h1){Q(n,h1,i);},visitAttributes:function(n){d1(n,i);},visitChildNodes:function(n){e1(n,i);},visitNode:function(n){f1(n,i);},"with":function(n,h1){var i1,j1=false,t,k1=new W();if(!h1){i.setChild(k1);}for(t in n){i1=n[t];j1=true;k1.setModel(i1.getModel(),t);k1.bindObject({model:t,path:i1.getPath()});}return j1||h1?E(k1):this;}};}function G(i){if(D){q.sap.log.debug(K()+Array.prototype.slice.call(arguments,1).join(" "),i&&f(i),x);}}function H(i){if(D){q.sap.log.debug(K()+"Finished","</"+i.nodeName+">",x);}}function I(i,n){i=i+f(n);q.sap.log.error(i,j,x);throw new Error(j+": "+i);}function J(h1){var i1=h1.childNodes,j1,k1=[],i,n,l1=false;for(i=0,n=i1.length;i<n;i+=1){j1=i1.item(i);if(j1.nodeType===1){k1.push(j1);}}if(!k1.length||!e(k1[0],"then")){return null;}for(i=1,n=k1.length;i<n;i+=1){j1=k1[i];if(l1){I("Expected </"+h1.prefix+":if>, but instead saw ",j1);}if(e(j1,"else")){l1=true;}else if(!e(j1,"elseif")){I("Expected <"+h1.prefix+":elseif> or <"+h1.prefix+":else>, but instead saw ",k1[i]);}}return k1;}function K(){return(w<10?"[ ":"[")+w+"] ";}function L(t){return t&&t.charAt(0)==="."?q.sap.getObject(t.slice(1),undefined,y):q.sap.getObject(t);}function O(i,n,h1,i1,j1){var k1;q.sap.measure.average(s,"",p);k1=B.complexParser(i,y,i1,true,true)||i;if(k1.functionsNotFound){if(i1){g1(n,'Function name(s)',k1.functionsNotFound.join(", "),'not found');}q.sap.measure.end(s);return u;}if(typeof k1==="object"){k1=g(h1,k1,S,y);if(i1&&k1===u){g1(n,'Binding not ready');}}else if(j1){j1();}q.sap.measure.end(s);return k1;}function Q(i,n,h1){var i1,j1=m;h1.$mFragmentContexts=h1.$mFragmentContexts||{};if(h1.$mFragmentContexts[i]){I("Cyclic reference to fragment '"+i+"' ",n);}w++;G(n,"fragmentName =",i);h1.$mFragmentContexts[i]=true;m=i;q.sap.measure.average(P,"",p);i1=F[i];if(!i1){i1=X.loadTemplate(i,"fragment");F[i]=i1;}i1=n.ownerDocument.importNode(i1,true);q.sap.measure.end(P);r(i1);if(i1.namespaceURI==="sap.ui.core"&&l(i1)==="FragmentDefinition"){T(i1,h1,n);}else{n.parentNode.insertBefore(i1,n);f1(i1,h1);}n.parentNode.removeChild(n);m=j1;h1.$mFragmentContexts[i]=false;H(n);w--;}function T(i,n,h1){var i1;h1=h1||i;e1(i,n);while((i1=i.firstChild)){h1.parentNode.insertBefore(i1,h1);}}function U(i,n){var h1=g1.bind(null,i,'Constant test condition'),i1,j1=i.getAttribute("test"),k1;try{k1=O(j1,i,n,true,h1);if(k1===u){k1=false;}}catch(ex){g1(i,'Error in formatter:',ex);k1=undefined;}i1=!!k1&&k1!=="false";if(D){if(typeof k1==="string"){k1=JSON.stringify(k1);}else if(k1===undefined){k1="undefined";}else if(Array.isArray(k1)){k1="[object Array]";}G(i,"test ==",k1,"-->",i1);}return i1;}function Y(i,n,h1){var i1=n.value,j1;try{j1=O(i1,i,h1,false);if(j1===u){G(i,'Binding not ready for attribute',n.name);}else if(j1===undefined){G(i,"Removed attribute",n.name);i.removeAttribute(n.name);}else{if(D&&j1!==n.value){G(i,n.name,"=",j1);}n.value=j1;}}catch(ex){G(i,'Error in formatter:',ex);}}function Z(i,n){var t=i.getAttribute("name"),h1,i1,j1=i.getAttribute("value");if(!t||t.length<=1||t.lastIndexOf(".")!==0){I("Missing proper relative name in ",i);}t=t.slice(1);h1=L(j1);if(!h1){I("Invalid value in ",i);}i1=y[t];y[t]=h1;T(i,n);i.parentNode.removeChild(i);y[t]=i1;}function $(i,n){var t=i.getAttribute("name"),h1=u,i1;try{h1=O(t,i,n,true);if(h1!==u&&h1!==t){G(i,"name =",h1);}}catch(ex){g1(i,'Error in formatter:',ex);}var k1=sap.ui.require("sap/ui/core/CustomizingConfiguration");if(h1!==u&&k1){i1=k1.getViewExtension(m,h1,V.componentId);if(i1&&i1.className==="sap.ui.core.Fragment"&&i1.type==="XML"){Q(i1.fragmentName,i,n);return true;}}return false;}function _(i,n){var h1=i.getAttribute("fragmentName"),i1;try{i1=O(h1,i,n,true);}catch(ex){g1(i,'Error in formatter:',ex);return;}if(i1!==u){Q(i1,i,n);}}function a1(i,n){var h1=J(i),i1,j1;w++;if(h1){j1=i;i1=h1.shift();do{if(U(j1,n)){break;}j1=i1=h1.shift();}while(j1&&l(j1)==="elseif");}else if(U(i,n)){i1=i;}if(i1){T(i1,n,i);}i.parentNode.removeChild(i);H(i);w--;}function b1(n,h1){var i1=n.getAttribute("list")||"",j1=B.complexParser(i1,y,false,true,true),k1,l1,m1,n1,o1=n.getAttribute("var");if(o1===""){I("Missing variable name for ",n);}if(!j1){I("Missing binding for ",n);}if(j1.functionsNotFound){g1(n,'Function name(s)',j1.functionsNotFound.join(", "),'not found');}n1=new R();h1.setChild(n1);j1.mode=a.OneTime;n1.bindAggregation("list",j1);l1=n1.getBinding("list");n1.unbindAggregation("list",true);m1=j1.model;if(!l1){I("Missing model '"+m1+"' in ",n);}k1=l1.getContexts(j1.startIndex,j1.length);o1=o1||m1;n1.setModel(l1.getModel(),o1);w++;G(n,"Starting");k1.forEach(function(p1,i){var q1=(i===k1.length-1)?n:n.cloneNode(true);n1.setBindingContext(p1,o1);G(n,o1,"=",p1.getPath());T(q1,n1,n);});H(n);w--;n.parentNode.removeChild(n);}function c1(i,n){var h1,i1,j1,k1,l1=i.getAttribute("helper"),m1,n1=i.getAttribute("path"),o1,p1=i.getAttribute("var");if(p1===""){I("Missing variable name for ",i);}j1=new W();n.setChild(j1);h1=B.simpleParser("{"+n1+"}");p1=p1||h1.model;if(l1||p1){i1=n.getModel(h1.model);if(!i1){I("Missing model '"+h1.model+"' in ",i);}o1=i1.resolve(h1.path,n.getBindingContext(h1.model));if(!o1){I("Cannot resolve path for ",i);}m1=i1.createBindingContext(o1);if(l1){k1=L(l1);if(typeof k1!=="function"){I("Cannot resolve helper for ",i);}m1=k1(m1);}if(m1 instanceof b){i1=m1.getModel();o1=m1.getPath();}else if(m1!==undefined){if(typeof m1!=="string"||m1===""){I("Illegal helper result '"+m1+"' in ",i);}o1=m1;}j1.setModel(i1,p1);j1.bindObject({model:p1,path:o1});}else{j1.bindObject(n1);}w++;G(i,p1,"=",o1);if(j1.getBindingContext(p1)===n.getBindingContext(p1)){g1(i,'Set unchanged path:',o1);j1=n;}T(i,j1);i.parentNode.removeChild(i);H(i);w--;}function d1(n,h1){var i,i1,j1=n.attributes;for(i=j1.length-1;i>=0;i-=1){i1=j1.item(i);if(z){z({context:undefined,env:{caller:"visitAttributes",before:{name:i1.name,value:i1.value}}});}Y(n,i1,h1);if(z){z({context:undefined,env:{caller:"visitAttributes",after:{name:i1.name,value:i1.value}}});}}}function e1(h1,i1){var i,j1=h1.childNodes,n=j1.length,k1=new Array(n);for(i=0;i<n;i+=1){k1[i]=j1.item(i);}j1=null;for(i=0;i<n;i+=1){f1(k1[i],i1);}}function f1(n,i){var h1,i1;if(n.nodeType!==1){return;}if(z){z({context:n,env:{caller:"visitNode",before:{name:n.tagName}}});}if(n.namespaceURI===N){switch(l(n)){case"alias":Z(n,i);return;case"if":a1(n,i);return;case"repeat":b1(n,i);return;case"with":c1(n,i);return;default:I("Unexpected tag ",n);}}else if(n.namespaceURI==="sap.ui.core"){switch(l(n)){case"ExtensionPoint":if($(n,i)){return;}break;case"Fragment":if(n.getAttribute("type")==="XML"){_(n,i);return;}break;}}else{h1=v[n.namespaceURI+" "+l(n)]||v[n.namespaceURI];if(h1){w++;G(n,"Calling visitor");i1=h1(n,E(i));if(i1!==undefined){I("Unexpected return value from visitor for ",n);}H(n);w--;return;}}d1(n,i);e1(n,i);if(z){z({context:n,env:{caller:"visitNode",after:{name:n.tagName}}});}}function g1(i){if(A){if(!k){k=true;q.sap.log.warning("Warning(s) during processing of "+j,null,x);}q.sap.log.warning(K()+Array.prototype.slice.call(arguments,1).join(" "),i&&f(i),x);}}q.sap.measure.average(c,"",p);S=S||{};if(D){G(undefined,"Start processing",j);if(S.bindingContexts instanceof b){G(undefined,"undefined =",S.bindingContexts);}else{for(t in S.bindingContexts){G(undefined,t,"=",S.bindingContexts[t]);}}}if(z){z({context:o,env:{caller:"view",viewinfo:q.extend(true,{},V),settings:q.extend(true,{},S),clone:o.cloneNode(true),type:"template"}});}r(o);f1(o,new W({models:S.models,bindingContexts:S.bindingContexts}));G(undefined,"Finished processing",j);q.sap.measure.end(c);return o;}};},true);
