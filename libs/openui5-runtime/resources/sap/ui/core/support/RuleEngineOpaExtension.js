/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global",'sap/ui/base/Object',"sap/base/util/UriParameters","sap/ui/thirdparty/jquery","sap/ui/support/RuleAnalyzer","sap/ui/support/library"],function(q,B,U,Q,R,l){"use strict";var E=B.extend("sap.ui.core.support.RuleEngineOpaExtension",{metadata:{publicMethods:["getAssertions"]},onAfterInit:function(){var L=sap.ui.getCore().getLoadedLibraries()["sap.ui.support"],d=Q.Deferred();if(!L){sap.ui.require(["sap/ui/support/Bootstrap"],function(b){b.initSupportRules(["true","silent"],{onReady:function(){d.resolve();}});});}else{d.resolve();}return d.promise();},getAssertions:function(){var s=function(){return new U(window.location.href).get('sap-skip-rules-issues')=='true';};var g=function(){var o=window.parent;o._$files=o._$files||[];return o;};return{noRuleFailures:function(o){var r=Q.Deferred(),o=o[0]||{},f=o["failOnAnyIssues"],a=o["failOnHighIssues"],b=o.rules,p=o.preset,e=o.executionScope;R.analyze(e,b||p).then(function(){var c=R.getAnalysisHistory(),d={issues:[]};if(c.length){d=c[c.length-1];}var i=d.issues.reduce(function(j,k){j[k.severity.toLowerCase()]+=1;return j;},{high:0,medium:0,low:0});var h=d.issues.length===0;if(a){h=i.high===0;}else if(f===false||a===false){h=true;}if(s()){h=true;}r.resolve({result:h,message:"Support Assistant issues found: [High: "+i.high+", Medium: "+i.medium+", Low: "+i.low+"]",expected:"0 high 0 medium 0 low",actual:i.high+" high "+i.medium+" medium "+i.low+" low"});});return r.promise();},getFinalReport:function(){var r=Q.Deferred(),h=R.getFormattedAnalysisHistory(),a=R.getAnalysisHistory(),t=a.reduce(function(d,e){return d+e.issues.length;},0),b=t===0,m="Support Assistant Analysis History",c=m;if(b){m+=" - no issues found";}else if(s()){b=true;m+=' - issues are found. To see them remove the "sap-skip-rules-issues=true" URI parameter';}r.resolve({result:b,message:m,actual:c,expected:h});return r.promise();},getReportAsFileInFormat:function(o){var c,h,o=o[0]||{},r=Q.Deferred(),H=o["historyFormat"],f=o["fileName"];switch(H){case l.HistoryFormats.Abap:if(!f){f="abap-report.json";}h=R.getFormattedAnalysisHistory(H);break;case l.HistoryFormats.String:if(!f){f="string-report.json";}h=R.getFormattedAnalysisHistory(H);break;default:if(!f){f="report.json";}h=R.getAnalysisHistory();}c=g();c._$files.push({name:f,content:JSON.stringify(h)});r.resolve({result:true,message:"Support Assistant Analysis History was stored in window._$files with following name "+f,actual:true,expected:true});return r.promise();}};}});return E;});
