/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','./Opa','./OpaPlugin','./PageObjectFactory','sap/ui/base/Object','sap/ui/Device','./launchers/iFrameLauncher','./launchers/componentLauncher','sap/ui/core/routing/HashChanger','./matchers/Matcher','./matchers/AggregationFilled','./matchers/PropertyStrictEquals','./pipelines/MatcherPipeline','./pipelines/ActionPipeline','./_ParameterValidator','./_LogCollector','sap/ui/thirdparty/URI','sap/ui/base/EventProvider'],function($,O,a,P,U,D,f,c,H,M,A,b,d,e,_,g,h,E){"use strict";var l=$.sap.log.getLogger("sap.ui.test.Opa5",g.DEFAULT_LEVEL_FOR_OPA_LOGGERS),p=new a(f._sLogPrefix),o=new e(),F="OpaFrame",v=new _({errorPrefix:"sap.ui.test.Opa5#waitFor"}),C=["visible","viewNamespace","viewName","autoWait"].concat(O._aConfigValuesForWaitFor),i=["check","error","success"].concat(O._aConfigValuesForWaitFor),j=[],k=new E();O._extractAppParams=function(){var B=[/opa.*/,/hidepassed/,/noglobals/,/notrycatch/,/coverage/,/module/,/filter/];var w={};var x=new h().search(true);for(var y in x){var z=false;for(var G=0;G<B.length;G++){if(y.match(B[G])){l.debug("Skipping uri parameter: "+y+" as blacklisted with pattern: "+B[G]);z=true;break;}}if(!z){w[y]=O._parseParam(x[y]);}}return w;};var r=function(T,w){for(var K in w){if(T.hasOwnProperty(K)&&w.hasOwnProperty(K)){if(typeof T[K]=="object"&&typeof w[K]=="object"){r(T[K],w[K]);}else{delete T[K];}}}return T;};var m=O._extractAppParams();var n=U.extend("sap.ui.test.Opa5",$.extend({},O.prototype,{constructor:function(){O.apply(this,arguments);}}));function s(S,T){var w=this;if(S&&typeof S!=="string"){S=S.toString();}var x=new h(S);x.search($.extend(x.search(true),O.config.appParams));var y=u();y.success=function(){q(x.toString());};this.waitFor(y);var z=u();z.check=f.hasLaunched;z.timeout=T||80;z.errorMessage="unable to load the IFrame with the url: "+S;w.waitFor(z);var L=u();L.success=function(){w._loadExtensions(f.getWindow());};return this.waitFor(L);}n.prototype.iStartMyUIComponent=function iStartMyUIComponent(w){var x=this;var y=false;w=w||{};var z=u();z.success=function(){var G=new h();G.search($.extend(G.search(true),O.config.appParams));window.history.replaceState({},"",G.toString());};this.waitFor(z);var S=u();S.success=function(){var G=jQuery.sap.getModulePath("sap.ui.test.OpaCss",".css");$.sap.includeStyleSheet(G);H.getInstance().setHash(w.hash||"");c.start(w.componentConfig).then(function(){y=true;});};this.waitFor(S);var B=u();B.errorMessage="Unable to load the component with the name: "+w.name;B.check=function(){return y;};if(w.timeout){B.timeout=w.timeout;}x.waitFor(B);var L=u();L.success=function(){x._loadExtensions(window);};return this.waitFor(L);};n.prototype.iTeardownMyUIComponent=function iTeardownMyUIComponent(){var w=u();w.success=function(){c.teardown();};this.waitFor(w);var x=u();x.success=function(){var y=new h();y.search(r(y.search(true),O.config.appParams));window.history.replaceState({},"",y.toString());};this.waitFor(x);};n.prototype.iTeardownMyApp=function(){var w=this;var x=u();x.success=function(){w._unloadExtensions(f.getWindow()||window);};this.waitFor(x);var y=u();y.success=function(){if(f.hasLaunched()){this.iTeardownMyAppFrame();}else if(c.hasLaunched()){this.iTeardownMyUIComponent();}else{var z="A teardown was called but there was nothing to tear down use iStartMyComponent or iStartMyAppInAFrame";l.error(z,"Opa");throw new Error(z);}}.bind(this);return this.waitFor(y);};n.iStartMyAppInAFrame=s;n.prototype.iStartMyAppInAFrame=s;function t(){var w=u();w.success=function(){f.teardown();};return this.waitFor(w);}n.iTeardownMyAppFrame=t;n.prototype.iTeardownMyAppFrame=t;n.prototype.waitFor=function(w){var x=w.actions,y=O._createFilteredConfig(C),z;w=$.extend({},y,w);w.actions=x;v.validate({validationInfo:n._validationInfo,inputToValidate:w});var B=w.check,G=null,I=w.success,R,J;z=O._createFilteredOptions(i,w);z.check=function(){var p=n.getPlugin();R=p.getFilterdControls(w,G);if(f.hasLaunched()&&$.isArray(R)){var K=[];R.forEach(function(L){K.push(L);});R=K;}if(R===a.FILTER_FOUND_NO_CONTROLS){return false;}if(B){return this._executeCheck(B,R);}return true;};z.success=function(){var W=O._getWaitForCounter();if(x&&(R||!J)){o.process({actions:x,control:R});}if(!I){return;}var K=[];if(R){K.push(R);}if(W.get()===0){I.apply(this,K);return;}var L=u();L.autoWait=w.autoWait;L.success=function(){I.apply(this,K);};this.waitFor(L);};return O.prototype.waitFor.call(this,z);};n.getPlugin=function(){return f.getPlugin()||p;};n.getJQuery=function(){return f.getJQuery();};n.getWindow=function(){return f.getWindow();};n.getUtils=function(){return f.getUtils();};n.getHashChanger=function(){return f.getHashChanger();};n.extendConfig=function(w){O.extendConfig(w);O.extendConfig({appParams:m});};n.resetConfig=function(){O.resetConfig();O.extendConfig({viewNamespace:"",arrangements:new n(),actions:new n(),assertions:new n(),visible:true,autoWait:false,_stackDropCount:1});O.extendConfig({appParams:m});};n.emptyQueue=O.emptyQueue;n.stopQueue=O.stopQueue;n.getContext=O.getContext;n.matchers={};n.matchers.Matcher=M;n.matchers.AggregationFilled=A;n.matchers.PropertyStrictEquals=b;n.createPageObjects=function(w){return P.create(w,n);};n.prototype._executeCheck=function(w,x){var y=[];x&&y.push(x);l.debug("Opa is executing the check: "+w);var R=w.apply(this,y);l.debug("Opa check was "+R);return R;};n.resetConfig();function q(S){var I=$.sap.getModulePath("sap.ui.test.OpaCss",".css");$.sap.includeStyleSheet(I);return f.launch({frameId:F,source:S});}function u(){return{viewName:null,controlType:null,id:null,searchOpenDialogs:false,autoWait:false};}$(function(){if($("#"+F).length){q();}$("body").addClass("sapUiBody");$("html").height("100%");});n._validationInfo=$.extend({_stack:"string",viewName:"string",viewNamespace:"string",visible:"bool",matchers:"any",actions:"any",id:"any",controlType:"any",searchOpenDialogs:"bool",autoWait:"bool"},O._validationInfo);n._getEventProvider=function(){return k;};n.prototype._loadExtensions=function(w){var x=this;var y=O.config.extensions?O.config.extensions:[];var z=$.when($.map(y,function(B){var G;var I=$.Deferred();w.sap.ui.require([B],function(J){G=new J();G.name=B;x._executeExtensionOnAfterInit(G,w).done(function(){n._getEventProvider().fireEvent('onExtensionAfterInit',{extension:G,appWindow:w});x._addExtension(G);I.resolve();}).fail(function(K){l.error(new Error("Error during extension init: "+K),"Opa");I.resolve();});});return I.promise();}));return this._schedulePromiseOnFlow(z);};n.prototype._unloadExtensions=function(w){var x=this;var y=$.when($.map(this._getExtensions(),function(z){var B=$.Deferred();n._getEventProvider().fireEvent('onExtensionBeforeExit',{extension:z});x._executeExtensionOnBeforeExit(z,w).done(function(){B.resolve();}).fail(function(G){l.error(new Error("Error during extension init: "+G),"Opa");B.resolve();});return B.promise();}));this._schedulePromiseOnFlow(y);};n.prototype._addExtension=function(w){j.push(w);};n.prototype._getExtensions=function(){return j;};n.prototype._executeExtensionOnAfterInit=function(w,x){var y=$.Deferred();var z=w.onAfterInit;if(z){z.bind(x)().done(function(){y.resolve();}).fail(function(B){y.reject(new Error("Error while waiting for extension: "+w.name+" to init, details: "+B));});}else{y.resolve();}return y.promise();};n.prototype._executeExtensionOnBeforeExit=function(w,x){var y=$.Deferred();var z=w.onBeforeExit;if(z){z.bind(x)().done(function(){y.resolve();}).fail(function(B){y.reject(new Error("Error while waiting for extension: "+w.name+" to exit, details: "+B));});}else{y.resolve();}return y.promise();};return n;},true);
