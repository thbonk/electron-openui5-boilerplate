/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/test/Opa','sap/ui/test/OpaPlugin','sap/ui/test/PageObjectFactory','sap/ui/base/Object','sap/ui/test/launchers/iFrameLauncher','sap/ui/test/launchers/componentLauncher','sap/ui/core/routing/HashChanger','sap/ui/test/matchers/Matcher','sap/ui/test/matchers/AggregationFilled','sap/ui/test/matchers/PropertyStrictEquals','sap/ui/test/pipelines/ActionPipeline','sap/ui/test/_ParameterValidator','sap/ui/test/_OpaLogger','sap/ui/thirdparty/URI','sap/ui/base/EventProvider','sap/ui/qunit/QUnitUtils','sap/ui/test/autowaiter/_autoWaiter',"sap/ui/dom/includeStylesheet","sap/ui/thirdparty/jquery"],function(O,a,P,U,f,c,H,M,A,b,d,_,e,g,E,Q,h,i,$){"use strict";var l=e.getLogger("sap.ui.test.Opa5"),p=new a(),o=new d(),F="OpaFrame",v=new _({errorPrefix:"sap.ui.test.Opa5#waitFor"}),C=["visible","viewNamespace","viewName","autoWait"].concat(O._aConfigValuesForWaitFor),j=["check","error","success"].concat(O._aConfigValuesForWaitFor),k=[],m=new E();O._extractAppParams=function(){var B=[/^opa((?!(Frame)).*)$/,/hidepassed/,/noglobals/,/notrycatch/,/coverage/,/module/,/filter/];var w={};var x=new g().search(true);Object.keys(x).forEach(function(y){var z=false;B.forEach(function(D){if(!z&&y.match(D)){l.debug("Skipping uri parameter: "+y+" as blacklisted with pattern: "+D);z=true;}});if(!z){w[y]=O._parseParam(x[y]);}});return w;};var n=O._extractAppParams();var q=U.extend("sap.ui.test.Opa5",$.extend({},O.prototype,{constructor:function(){O.apply(this,arguments);}}));function s(){var w=this;var x={};var y=["source","timeout","autoWait","width","height"];if(arguments.length===1&&$.isPlainObject(arguments[0])){x=arguments[0];}else{var V=arguments;y.forEach(function(G,I){x[G]=V[I];});}if(x.source&&typeof x.source!=="string"){x.source=x.source.toString();}var z=new g(x.source?x.source:'');z.search($.extend(z.search(true),O.config.appParams));var B=u();B.success=function(){r({source:z.toString(),width:x.width||O.config.frameWidth,height:x.height||O.config.frameHeight});};this.waitFor(B);var D=u();D.check=f.hasLaunched;D.timeout=x.timeout||80;D.errorMessage="unable to load the IFrame with the url: "+x.source;w.waitFor(D);var L=u();L.success=function(){w._loadExtensions(f.getWindow());};this.waitFor(L);var W=u();W.autoWait=x.autoWait||false;W.timeout=x.timeout||80;return this.waitFor(W);}q.prototype.iStartMyUIComponent=function iStartMyUIComponent(w){var x=this;var y=false;w=w||{};var z=u();z.success=function(){var D=new g();D.search($.extend(D.search(true),O.config.appParams));window.history.replaceState({},"",D.toString());};this.waitFor(z);var S=u();S.success=function(){var D=sap.ui.require.toUrl("sap/ui/test/OpaCss")+".css";i(D);H.getInstance().setHash(w.hash||"");c.start(w.componentConfig).then(function(){y=true;});};this.waitFor(S);var B=u();B.errorMessage="Unable to load the component with the name: "+w.name;B.check=function(){return y;};if(w.timeout){B.timeout=w.timeout;}x.waitFor(B);var L=u();L.success=function(){x._loadExtensions(window);};this.waitFor(L);var W=u();W.autoWait=w.autoWait||false;W.timeout=w.timeout||80;return this.waitFor(W);};q.prototype.iTeardownMyUIComponent=function iTeardownMyUIComponent(){var w=u();w.success=function(){c.teardown();};var x=u();x.success=function(){var y=new g();y.search(n);window.history.replaceState({},"",y.toString());};return $.when(this.waitFor(w),this.waitFor(x));};q.prototype.iTeardownMyApp=function(){var w=this;var x=u();x.success=function(){w._unloadExtensions(q.getWindow());};var y=u();y.success=function(){if(f.hasLaunched()){this.iTeardownMyAppFrame();}else if(c.hasLaunched()){this.iTeardownMyUIComponent();}else{var z="A teardown was called but there was nothing to tear down use iStartMyComponent or iStartMyAppInAFrame";l.error(z,"Opa");throw new Error(z);}}.bind(this);return $.when(this.waitFor(x),this.waitFor(y));};q.iStartMyAppInAFrame=s;q.prototype.iStartMyAppInAFrame=s;function t(){var w=u();w.success=function(){f.teardown();};return this.waitFor(w);}q.iTeardownMyAppFrame=t;q.prototype.iTeardownMyAppFrame=t;q.prototype.hasAppStartedInAFrame=function(){return f.hasLaunched();};q.prototype.hasUIComponentStarted=function(){return c.hasLaunched();};q.prototype.hasAppStarted=function(){return f.hasLaunched()||c.hasLaunched();};q.prototype.waitFor=function(w){var x=w.actions,y=O._createFilteredConfig(C),z;w=$.extend({},y,w);w.actions=x;v.validate({validationInfo:q._validationInfo,inputToValidate:w});var B=w.check,D=null,G=w.success,R,I;z=O._createFilteredOptions(j,w);z.check=function(){var J=!!w.actions||w.autoWait;var K=q._getAutoWaiter();K.extendConfig(w.autoWait);if(J&&K.hasToWait()){return false;}var p=q.getPlugin();var L=$.extend({},w,{interactable:J});R=p._getFilteredControls(L,D);if(f.hasLaunched()&&$.isArray(R)){var N=[];R.forEach(function(S){N.push(S);});R=N;}if(R===a.FILTER_FOUND_NO_CONTROLS){l.debug("Matchers found no controls so check function will be skipped");return false;}if(B){return this._executeCheck(B,R);}return true;};z.success=function(){var W=O._getWaitForCounter();if(x&&(R||!I)){o.process({actions:x,control:R});}if(!G){return;}var J=[];if(R){J.push(R);}if(W.get()===0){l.timestamp("opa.waitFor.success");l.debug("Execute success handler");G.apply(this,J);return;}var K=u();if($.isPlainObject(w.autoWait)){K.autoWait=$.extend({},w.autoWait);}else{K.autoWait=w.autoWait;}K.success=function(){G.apply(this,J);};this.waitFor(K);};return O.prototype.waitFor.call(this,z);};q.getPlugin=function(){return f.getPlugin()||p;};q.getJQuery=function(){return f.getJQuery()||$;};q.getWindow=function(){return f.getWindow()||window;};q.getUtils=function(){return f.getUtils()||Q;};q.getHashChanger=function(){return f.getHashChanger()||H.getInstance();};q._getAutoWaiter=function(){return f._getAutoWaiter()||h;};q.extendConfig=function(w){O.extendConfig(w);O.extendConfig({appParams:n});q._getAutoWaiter().extendConfig(w.autoWait);};q.resetConfig=function(){O.resetConfig();O.extendConfig({viewNamespace:"",arrangements:new q(),actions:new q(),assertions:new q(),visible:true,autoWait:false,_stackDropCount:1});O.extendConfig({appParams:n});};q.getTestLibConfig=function(T){return O.config.testLibs&&O.config.testLibs[T]?O.config.testLibs[T]:{};};q.emptyQueue=O.emptyQueue;q.stopQueue=O.stopQueue;q.getContext=O.getContext;q.matchers={};q.matchers.Matcher=M;q.matchers.AggregationFilled=A;q.matchers.PropertyStrictEquals=b;q.createPageObjects=function(w){return P.create(w,q);};q.prototype._executeCheck=function(w,x){var y=[];x&&y.push(x);l.debug("Executing OPA check function on controls "+x);l.debug("Check function is:\n"+w);var R=w.apply(this,y);l.debug("Result of check function is: "+R||"not defined or null");return R;};q.prototype.iWaitForPromise=function(w){var x={viewName:null,controlType:null,id:null,searchOpenDialogs:false,autoWait:false};return O.prototype._schedulePromiseOnFlow.call(this,w,x);};q.resetConfig();function r(w){var I=sap.ui.require.toUrl("sap/ui/test/OpaCss")+".css";i(I);var x=$.extend({},w,{frameId:F,opaLogLevel:O.config.logLevel});return f.launch(x);}function u(){return{viewName:null,controlType:null,id:null,searchOpenDialogs:false,autoWait:false};}$(function(){if($("#"+F).length){r();}$("body").addClass("sapUiBody");$("html").height("100%");});q._validationInfo=$.extend({_stack:"string",viewName:"string",viewNamespace:"string",visible:"bool",matchers:"any",actions:"any",id:"any",controlType:"any",searchOpenDialogs:"bool",autoWait:"any"},O._validationInfo);q._getEventProvider=function(){return m;};q.prototype._loadExtensions=function(w){var x=this;var y=O.config.extensions?O.config.extensions:[];var z=$.when($.map(y,function(B){var D;var G=$.Deferred();w.sap.ui.require([B],function(I){D=new I();D.name=B;x._executeExtensionOnAfterInit(D,w).done(function(){q._getEventProvider().fireEvent('onExtensionAfterInit',{extension:D,appWindow:w});x._addExtension(D);G.resolve();}).fail(function(J){l.error(new Error("Error during extension init: "+J),"Opa");G.resolve();});});return G.promise();}));return this.iWaitForPromise(z);};q.prototype._unloadExtensions=function(w){var x=this;var y=$.when($.map(this._getExtensions(),function(z){var B=$.Deferred();q._getEventProvider().fireEvent('onExtensionBeforeExit',{extension:z});x._executeExtensionOnBeforeExit(z,w).done(function(){B.resolve();}).fail(function(D){l.error(new Error("Error during extension init: "+D),"Opa");B.resolve();});return B.promise();}));this.iWaitForPromise(y);};q.prototype._addExtension=function(w){k.push(w);};q.prototype._getExtensions=function(){return k;};q.prototype._executeExtensionOnAfterInit=function(w,x){var D=$.Deferred();var y=w.onAfterInit;if(y){y.bind(x)().done(function(){D.resolve();}).fail(function(z){D.reject(new Error("Error while waiting for extension: "+w.name+" to init, details: "+z));});}else{D.resolve();}return D.promise();};q.prototype._executeExtensionOnBeforeExit=function(w,x){var D=$.Deferred();var y=w.onBeforeExit;if(y){y.bind(x)().done(function(){D.resolve();}).fail(function(z){D.reject(new Error("Error while waiting for extension: "+w.name+" to exit, details: "+z));});}else{D.resolve();}return D.promise();};return q;});
