/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/Device','./_LogCollector','./_ParameterValidator','sap/ui/thirdparty/URI'],function($,D,_,a,U){"use strict";var l=$.sap.log.getLogger("sap.ui.test.Opa",_.DEFAULT_LEVEL_FOR_OPA_LOGGERS),L=_.getInstance(),q=[],c={},t=-1,i,d,b,v=new a({errorPrefix:"sap.ui.test.Opa#waitFor"});function e(C,m,d){if(window["sap-ui-debug"]){m.timeout=m.debugTimeout;}var s=new Date();n();function n(){var r;L.getAndClearLog();try{r=C();}catch(E){d.reject(m,E);throw E;}if(r.result){f(d);return;}var p=(new Date()-s)/1000;if(m.timeout===0||m.timeout>p){t=setTimeout(n,m.pollingInterval);return;}if(m.error){try{m.error(m,r.arguments);}finally{d.reject(m);}return;}d.reject(m);}}function f(m){if(q.length===0){m.resolve();return true;}var n=q.shift();t=setTimeout(function(){e(n.callback,n.options,m);},O.config.executionDelay);}function g(w,n){var N=w.get();if(N){var m=q.splice(q.length-N,N);m.forEach(function(p){p.options._nestedIn=n;});q=m.concat(q);}}function h(m){m=(m||0)+2;if(D.browser.mozilla){m=m-1;}var E=new Error(),s=E.stack;if(!s){try{throw E();}catch(n){s=n.stack;}}if(!s){return"";}s=s.split("\n");s.splice(0,m);return s.join("\n");}function j(m){var r="\nCallstack:\n";if(m._stack){r+=m._stack;delete m._stack;}else{r+="Unknown";}if(m._nestedIn){r+=j(m._nestedIn);delete m._nestedIn;}return r;}var O=function(m){this.and=this;$.extend(this,m);};O.config={};O.extendConfig=function(m){["actions","assertions","arrangements"].forEach(function(A){if(!m[A]){return;}Object.keys(O.config[A]).forEach(function(K){if(!m[A][K]){m[A][K]=O.config[A][K];}});});O.config=$.extend(true,O.config,m,o);};O._parseParam=function(p){var V=parseInt(p,10);return(typeof V==='number'&&isNaN(V))?p:V;};O._extractOpaUriParams=function(){var p='opa';var P={};var u=new U().search(true);for(var s in u){if(s.indexOf(p)==0){P[s.substr(p.length,1).toLowerCase()+s.substr(p.length+1)]=this._parseParam(u[s]);}}return P;};var o=O._extractOpaUriParams();var k=0;var I=D.browser.safari&&!D.browser.phantomJS;if(D.browser.msie||D.browser.edge||I){k=50;}O.resetConfig=function(){O.config=$.extend({arrangements:new O(),actions:new O(),assertions:new O(),timeout:15,pollingInterval:400,debugTimeout:0,_stackDropCount:0,executionDelay:k},o);};O.getContext=function(){return c;};O.emptyQueue=function emptyQueue(){if(b){throw new Error("Opa is emptying its queue. Calling Opa.emptyQueue() is not supported at this time.");}b=true;d=$.Deferred();i=false;f(d);return d.promise().fail(function(m,E){q=[];var s,n="";if(m.errorMessage){n=m.errorMessage+"\n";}if(i){n+=m.stoppedManually?"Queue was stopped manually":"QUnit timeout";s={_stack:h(1)};}else if(!E){n+="Opa timeout";}else if(E){var p=E.toString();if(E.stack){p+="\n"+E.stack;}n+="Exception thrown by the testcode:'"+p+"'";}if(!s){s=m;}var r=L.getAndClearLog();if(r){n+="\nThis is what Opa logged:\n"+r;}if(!(E&&E.stack)){n+=j(s);}l.error(n,"Opa");m.errorMessage=n;}).always(function(){t=-1;d=null;b=false;});};O.stopQueue=function stopQueue(){O._stopQueue(true);};O._stopQueue=function(s){q=[];if(!d){l.warning("stopQueue was called before emptyQueue, queued tests have never been executed","Opa");}else{if(t!==-1){clearTimeout(t);}i=true;d.reject({stoppedManually:s});}};O.resetConfig();O.prototype={getContext:O.getContext,waitFor:function(m){var n=$.Deferred(),F=O._createFilteredConfig(O._aConfigValuesForWaitFor);m=$.extend({},F,m);this._validateWaitFor(m);m._stack=h(1+m._stackDropCount);delete m._stackDropCount;n.promise(this);q.push({callback:function(){var r=true;if(m.check){try{r=m.check.apply(this,arguments);}catch(E){n.reject(m,E);throw E;}}if(i){return{result:true,arguments:arguments};}if(r){if(m.success){var w=O._getWaitForCounter();try{m.success.apply(this,arguments);}finally{g(w,m);}}n.resolve();return{result:true,arguments:arguments};}return{result:false,arguments:arguments};}.bind(this),options:m});return this;},extendConfig:O.extendConfig,emptyQueue:O.emptyQueue,_validateWaitFor:function(p){v.validate({validationInfo:O._validationInfo,inputToValidate:p});},_schedulePromiseOnFlow:function(p){var P=false;var m;p.done(function(){P=true;}).fail(function(r){m="Error while waiting for promise scheduled on flow"+(r?", details: "+r:"");});var n={viewName:null,controlType:null,id:null,searchOpenDialogs:false,autoWait:false};n.check=function(){if(m){throw new Error(m);}return P;};return this.waitFor(n);}};O._createFilteredOptions=function(A,s){var F={};A.forEach(function(K){var C=s[K];if(C===undefined){return;}F[K]=C;});return F;};O._createFilteredConfig=function(A){return O._createFilteredOptions(A,O.config);};O._getWaitForCounter=function(){var Q=q.length;return{get:function(){var m=q.length-Q;return Math.max(m,0);}};};O._aConfigValuesForWaitFor=["errorMessage","timeout","debugTimeout","pollingInterval","_stackDropCount"];O._validationInfo={error:"func",check:"func",success:"func",timeout:"numeric",debugTimeout:"numeric",pollingInterval:"numeric",_stackDropCount:"numeric",errorMessage:"string"};return O;},true);
