/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/Device','./_LogCollector','./_ParameterValidator'],function($,D,_,a){"use strict";var l=$.sap.log.getLogger("sap.ui.test.Opa",_.DEFAULT_LEVEL_FOR_OPA_LOGGERS),L=_.getInstance(),q=[],c={},t=-1,i,d,b,v=new a({errorPrefix:"sap.ui.test.Opa#waitFor"});function e(C,o,d){if(window["sap-ui-debug"]){o.timeout=300;}var k=new Date();m();function m(){var r;L.getAndClearLog();try{r=C();}catch(n){d.reject(o,n);throw n;}if(r.result){f(d);return;}var p=new Date()-k;p/=1000;var P=Math.round(p%60);if(o.timeout>P){t=setTimeout(m,o.pollingInterval);return;}if(o.error){try{o.error(o,r.arguments);}finally{d.reject(o);}return;}d.reject(o);}}function f(k){if(q.length===0){k.resolve();return true;}var m=q.shift();t=setTimeout(function(){e(m.callback,m.options,k);},O.config.executionDelay);}function g(w,n){var N=w.get();if(N){var k=q.splice(q.length-N,N);k.forEach(function(m){m.options._nestedIn=n;});q=k.concat(q);}}function h(k){k=(k||0)+2;if(D.browser.mozilla){k=k-1;}var o=new Error(),m=o.stack;if(!m){try{throw o();}catch(n){m=n.stack;}}if(!m){return"";}m=m.split("\n");m.splice(0,k);return m.join("\n");}function j(o){var r="\nCallstack:\n";if(o._stack){r+=o._stack;delete o._stack;}else{r+="Unknown";}if(o._nestedIn){r+=j(o._nestedIn);delete o._nestedIn;}return r;}var O=function(k){this.and=this;$.extend(this,k);};O.config={};O.extendConfig=function(o){["actions","assertions","arrangements"].forEach(function(A){if(!o[A]){return;}Object.keys(O.config[A]).forEach(function(k){if(!o[A][k]){o[A][k]=O.config[A][k];}});});O.config=$.extend(O.config,o);};var E,s=$.sap.getUriParameters().get("opaExecutionDelay");if(s){E=parseInt(s,10);}if(!E){var I=D.browser.safari&&!D.browser.phantomJS;if(D.browser.msie||D.browser.edge||I){E=50;}else{E=0;}}O.resetConfig=function(){O.config={arrangements:new O(),actions:new O(),assertions:new O(),executionDelay:E,timeout:15,pollingInterval:400,_stackDropCount:0};};O.getContext=function(){return c;};O.emptyQueue=function emptyQueue(){if(b){throw new Error("Opa is emptying its queue. Calling Opa.emptyQueue() is not supported at this time.");}b=true;d=$.Deferred();i=false;f(d);return d.promise().fail(function(o,k){q=[];var S,m="";if(o.errorMessage){m=o.errorMessage+"\n";}if(i){m+=o.stoppedManually?"Queue was stopped manually":"QUnit timeout";S={_stack:h(1)};}else if(!k){m+="Opa timeout";}else if(k){var n=k.toString();if(k.stack){n+="\n"+k.stack;}m+="Exception thrown by the testcode:'"+n+"'";}if(!S){S=o;}var p=L.getAndClearLog();if(p){m+="\nThis is what Opa logged:\n"+p;}if(!(k&&k.stack)){m+=j(S);}l.error(m,"Opa");o.errorMessage=m;}).always(function(){t=-1;d=null;b=false;});};O.stopQueue=function stopQueue(){O._stopQueue(true);};O._stopQueue=function(S){q=[];if(!d){l.warning("stopQueue was called before emptyQueue, queued tests have never been executed","Opa");}else{if(t!==-1){clearTimeout(t);}i=true;d.reject({stoppedManually:S});}};O.resetConfig();O.prototype={getContext:O.getContext,waitFor:function(o){var k=$.Deferred(),F=O._createFilteredConfig(O._aConfigValuesForWaitFor);o=$.extend({},F,o);this._validateWaitFor(o);o._stack=h(1+o._stackDropCount);delete o._stackDropCount;k.promise(this);q.push({callback:function(){var r=true;if(o.check){try{r=o.check.apply(this,arguments);}catch(m){k.reject(o,m);throw m;}}if(i){return{result:true,arguments:arguments};}if(r){if(o.success){var w=O._getWaitForCounter();try{o.success.apply(this,arguments);}finally{g(w,o);}}k.resolve();return{result:true,arguments:arguments};}return{result:false,arguments:arguments};}.bind(this),options:o});return this;},extendConfig:O.extendConfig,emptyQueue:O.emptyQueue,_validateWaitFor:function(p){v.validate({validationInfo:O._validationInfo,inputToValidate:p});}};O._createFilteredOptions=function(A,S){var F={};A.forEach(function(k){var C=S[k];if(C===undefined){return;}F[k]=C;});return F;};O._createFilteredConfig=function(A){return O._createFilteredOptions(A,O.config);};O._getWaitForCounter=function(){var Q=q.length;return{get:function(){var k=q.length-Q;return Math.max(k,0);}};};O._aConfigValuesForWaitFor=["errorMessage","timeout","pollingInterval","_stackDropCount"];O._validationInfo={error:"func",check:"func",success:"func",timeout:"numeric",pollingInterval:"numeric",_stackDropCount:"numeric",errorMessage:"string"};return O;},true);
