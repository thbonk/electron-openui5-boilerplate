/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/Device','./_LogCollector','./_ParameterValidator','sap/ui/thirdparty/URI'],function($,D,_,a,U){"use strict";var l=$.sap.log.getLogger("sap.ui.test.Opa",_.DEFAULT_LEVEL_FOR_OPA_LOGGERS),L=_.getInstance(),q=[],c={},t=-1,i,d,b,v=new a({errorPrefix:"sap.ui.test.Opa#waitFor"});function e(C,p,d){if(window["sap-ui-debug"]){p.timeout=p.debugTimeout;}var s=new Date();r();function r(){L.getAndClearLog();var R=C();if(R.error){d.reject(p);return;}if(R.result){f(d);return;}var P=(new Date()-s)/1000;if(p.timeout===0||p.timeout>P){t=setTimeout(r,p.pollingInterval);return;}j("Opa timeout",p);if(p.error){try{p.error(p,R.arguments);}finally{d.reject(p);}return;}d.reject(p);}}function f(p){if(q.length===0){p.resolve();return true;}var r=q.shift();t=setTimeout(function(){e(r.callback,r.options,p);},O.config.executionDelay);}function g(w,N){var p=w.get();if(p){var r=q.splice(q.length-p,p);r.forEach(function(s){s.options._nestedIn=N;});q=r.concat(q);}}function h(E){var s=E.toString();if(E.stack){s+="\n"+E.stack;}var p="Exception thrown by the testcode:'"+s+"'";return p;}function j(E,p,r){var s=L.getAndClearLog();if(s){E+="\nThis is what Opa logged:\n"+s;}if(!r&&p._stack){E+=m(p);}if(p.errorMessage){p.errorMessage+="\n"+E;}else{p.errorMessage=E;}l.error(p.errorMessage,"Opa");}function k(p){p=(p||0)+2;if(D.browser.mozilla){p=p-1;}var E=new Error(),s=E.stack;if(!s){try{throw E();}catch(r){s=r.stack;}}if(!s){return"";}s=s.split("\n");s.splice(0,p);return s.join("\n");}function m(p){var r="\nCallstack:\n";if(p._stack){r+=p._stack;delete p._stack;}else{r+="Unknown";}if(p._nestedIn){r+=m(p._nestedIn);delete p._nestedIn;}return r;}var O=function(p){this.and=this;$.extend(this,p);};O.config={};O.extendConfig=function(p){["actions","assertions","arrangements"].forEach(function(A){if(!p[A]){return;}Object.keys(O.config[A]).forEach(function(K){if(!p[A][K]){p[A][K]=O.config[A][K];}});});O.config=$.extend(true,O.config,p,o);};O._parseParam=function(p){var V=parseInt(p,10);return(typeof V==='number'&&isNaN(V))?p:V;};O._extractOpaUriParams=function(){var p='opa';var P={};var u=new U().search(true);for(var s in u){if(s.indexOf(p)==0){P[s.substr(p.length,1).toLowerCase()+s.substr(p.length+1)]=this._parseParam(u[s]);}}return P;};var o=O._extractOpaUriParams();var n=0;var I=D.browser.safari&&!D.browser.phantomJS;if(D.browser.msie||D.browser.edge||I){n=50;}O.resetConfig=function(){O.config=$.extend({arrangements:new O(),actions:new O(),assertions:new O(),timeout:15,pollingInterval:400,debugTimeout:0,_stackDropCount:0,executionDelay:n},o);};O.getContext=function(){return c;};O.emptyQueue=function emptyQueue(){if(b){throw new Error("Opa is emptying its queue. Calling Opa.emptyQueue() is not supported at this time.");}b=true;d=$.Deferred();i=false;f(d);return d.promise().fail(function(p){q=[];if(i){var E=p.stoppedManually?"Queue was stopped manually":"QUnit timeout";p._stack=k(1);j(E,p);}}).always(function(){t=-1;d=null;b=false;});};O.stopQueue=function stopQueue(){O._stopQueue(true);};O._stopQueue=function(s){q=[];if(!d){l.warning("stopQueue was called before emptyQueue, queued tests have never been executed","Opa");}else{if(t!==-1){clearTimeout(t);}i=true;d.reject({stoppedManually:s});}};O.resetConfig();O.prototype={getContext:O.getContext,waitFor:function(p){var r=$.Deferred(),F=O._createFilteredConfig(O._aConfigValuesForWaitFor);p=$.extend({},F,p);this._validateWaitFor(p);p._stack=k(1+p._stackDropCount);delete p._stackDropCount;var s=$.extend({},this);r.promise(s);q.push({callback:function(){var C=true;if(p.check){try{C=p.check.apply(this,arguments);}catch(E){var u="Failure in Opa check function\n"+h(E);j(u,p,E.stack);r.reject(p);return{result:false,error:true,arguments:arguments};}}if(i){return{result:true,arguments:arguments};}if(C){if(p.success){var w=O._getWaitForCounter();try{p.success.apply(this,arguments);}catch(E){var u="Failure in Opa success function\n"+h(E);j(u,p,E.stack);r.reject(p);return{result:false,error:true,arguments:arguments};}finally{g(w,p);}}r.resolve();return{result:true,arguments:arguments};}return{result:false,arguments:arguments};}.bind(this),options:p});return s;},extendConfig:O.extendConfig,emptyQueue:O.emptyQueue,_validateWaitFor:function(p){v.validate({validationInfo:O._validationInfo,inputToValidate:p});},_schedulePromiseOnFlow:function(p){var P=false;var r;p.done(function(){P=true;}).fail(function(u){r="Error while waiting for promise scheduled on flow"+(u?", details: "+u:"");});var s={viewName:null,controlType:null,id:null,searchOpenDialogs:false,autoWait:false};s.check=function(){if(r){throw new Error(r);}return P;};return this.waitFor(s);}};O._createFilteredOptions=function(A,s){var F={};A.forEach(function(K){var C=s[K];if(C===undefined){return;}F[K]=C;});return F;};O._createFilteredConfig=function(A){return O._createFilteredOptions(A,O.config);};O._getWaitForCounter=function(){var Q=q.length;return{get:function(){var p=q.length-Q;return Math.max(p,0);}};};O._aConfigValuesForWaitFor=["errorMessage","timeout","debugTimeout","pollingInterval","_stackDropCount"];O._validationInfo={error:"func",check:"func",success:"func",timeout:"numeric",debugTimeout:"numeric",pollingInterval:"numeric",_stackDropCount:"numeric",errorMessage:"string"};return O;},true);
