/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./_MetadataConverter"],function(q,_){"use strict";var V,m="sap.ui.model.odata.v4.lib._V2MetadataConverter",e="http://schemas.microsoft.com/ado/2007/06/edmx",M="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata",v={"creatable":{"property":"Insertable","term":"@Org.OData.Capabilities.V1.InsertRestrictions"},"deletable":{"property":"Deletable","term":"@Org.OData.Capabilities.V1.DeleteRestrictions"},"deletable-path":{"property":"Deletable","term":"@Org.OData.Capabilities.V1.DeleteRestrictions"},"field-control":{"term":"@com.sap.vocabularies.Common.v1.FieldControl"},"heading":{"term":"@com.sap.vocabularies.Common.v1.Heading"},"label":{"term":"@com.sap.vocabularies.Common.v1.Label"},"precision":{"term":"@Org.OData.Measures.V1.Scale"},"quickinfo":{"term":"@com.sap.vocabularies.Common.v1.QuickInfo"},"requires-filter":{"property":"RequiresFilter","term":"@Org.OData.Capabilities.V1.FilterRestrictions"},"searchable":{"property":"Searchable","term":"@Org.OData.Capabilities.V1.SearchRestrictions"},"text":{"term":"@com.sap.vocabularies.Common.v1.Text"},"updatable":{"property":"Updatable","term":"@Org.OData.Capabilities.V1.UpdateRestrictions"},"updatable-path":{"property":"Updatable","term":"@Org.OData.Capabilities.V1.UpdateRestrictions"}},a={"bday":{TermName:"Contact"},"city":{Path:"adr",TermName:"Contact",V4Attribute:"locality"},"country":{Path:"adr",TermName:"Contact"},"familyname":{Path:"n",TermName:"Contact",V4Attribute:"surname"},"givenname":{Path:"n",TermName:"Contact",V4Attribute:"given"},"honorific":{Path:"n",TermName:"Contact",V4Attribute:"prefix"},"middlename":{Path:"n",TermName:"Contact",V4Attribute:"additional"},"name":{TermName:"Contact",V4Attribute:"fn"},"nickname":{TermName:"Contact"},"note":{TermName:"Contact"},"org":{TermName:"Contact"},"org-role":{TermName:"Contact",V4Attribute:"role"},"org-unit":{TermName:"Contact",V4Attribute:"orgunit"},"photo":{TermName:"Contact"},"pobox":{Path:"adr",TermName:"Contact"},"region":{Path:"adr",TermName:"Contact"},"street":{Path:"adr",TermName:"Contact"},"suffix":{Path:"n",TermName:"Contact"},"title":{TermName:"Contact"},"zip":{Path:"adr",TermName:"Contact",V4Attribute:"code"},"class":{TermName:"Event"},"dtend":{TermName:"Event"},"dtstart":{TermName:"Event"},"duration":{TermName:"Event"},"fbtype":{TermName:"Event"},"location":{TermName:"Event"},"status":{TermName:"Event"},"transp":{TermName:"Event"},"wholeday":{TermName:"Event"},"body":{TermName:"Message"},"from":{TermName:"Message"},"received":{TermName:"Message"},"sender":{TermName:"Message"},"subject":{TermName:"Message"},"completed":{TermName:"Task"},"due":{TermName:"Task"},"percent-complete":{TermName:"Task",V4Attribute:"percentcomplete"},"priority":{TermName:"Task"}},s="http://www.sap.com/Protocols/SAPData",A={"DataServices":{"Schema":{__processor:_.processAlias}}},S={"NavigationProperty":{__processor:H},"Property":{__processor:I}},f={"DataServices":{__processor:r,"Schema":{__postProcessor:p,__processor:_.processSchema,__include:[_.oAnnotationsConfig],"Association":{__processor:h,"End":{__processor:j},"ReferentialConstraint":{__processor:D,"Dependent":{__processor:t,"PropertyRef":{__processor:E}},"Principal":{__processor:C,"PropertyRef":{__processor:E}}}},"ComplexType":{__processor:o,__include:[S]},"EntityContainer":{__processor:u,"AssociationSet":{__processor:k,"End":{__processor:l}},"EntitySet":{__processor:w},"FunctionImport":{__processor:z,"Parameter":{__processor:B}}},"EntityType":{__processor:x,__include:[S],"Key":{"PropertyRef":{__processor:y}}}}}};function c(N,O,P){var Q=O.annotatable.path,R=O.convertedV2Annotations[Q]||{},T,U=N.attributes,W=O.annotatable.parent.path,X=O.convertedV2Annotations[W]||{},i,n=U.length;if(P==="EntityType"){J(R,"label",N.getAttributeNS(s,"label"));}else{for(i=0;i<n;i++){T=U[i];if(T.namespaceURI!==s){continue;}if(P==="EntitySet"){b(N,T,R,O);}else if(P==="Property"&&T.localName==="semantics"){g(T,X);}else if(P==="Property"){d(T,R);}}if(P==="EntitySet"&&N.getAttributeNS(s,"searchable")!=="true"){J(R,"searchable",false);}}if(Object.keys(R).length>0){O.convertedV2Annotations[Q]=R;}if(Object.keys(X).length>0){O.convertedV2Annotations[W]=X;}}function b(i,n,N,O){var P;switch(n.localName){case"creatable":case"deletable":case"updatable":if(n.value==="false"){J(N,n.localName,false);}break;case"deletable-path":case"updatable-path":P=n.localName.slice(0,9);if(i.getAttributeNS(s,P)){J(N,n.localName,false);q.sap.log.warning("Inconsistent metadata in '"+O.url+"'","Use either 'sap:"+P+"' or 'sap:"+P+"-path'"+" at entity set '"+O.annotatable.path+"'",m);}else{J(N,n.localName,{$Path:n.value});}break;case"label":N["@com.sap.vocabularies.Common.v1.Label"]=n.value;break;case"pageable":if(n.value==="false"){N["@Org.OData.Capabilities.V1.SkipSupported"]=false;N["@Org.OData.Capabilities.V1.TopSupported"]=false;}break;case"requires-filter":if(n.value==="true"){J(N,n.localName,true);}break;case"topable":if(n.value==="false"){N["@Org.OData.Capabilities.V1.TopSupported"]=false;}break;default:}}function d(i,n){switch(i.localName){case"heading":case"label":case"quickinfo":J(n,i.localName,i.value);break;case"field-control":case"precision":case"text":J(n,i.localName,{$Path:i.value});break;case"aggregation-role":if(i.value==="dimension"){n["@com.sap.vocabularies.Analytics.v1.Dimension"]=true;}else if(i.value==="measure"){n["@com.sap.vocabularies.Analytics.v1.Measure"]=true;}break;case"display-format":if(i.value==="NonNegative"){n["@com.sap.vocabularies.Common.v1.IsDigitSequence"]=true;}else if(i.value==="UpperCase"){n["@com.sap.vocabularies.Common.v1.IsUpperCase"]=true;}break;case"visible":if(i.value==="false"){n["@com.sap.vocabularies.UI.v1.Hidden"]=true;n["@com.sap.vocabularies.Common.v1.FieldControl"]={$EnumMember:"com.sap.vocabularies.Common.v1.FieldControlType/Hidden"};}break;default:}}function g(i,n){var N,P,O,Q=i.value;if(a[Q]){P={"$Path":i.ownerElement.getAttribute("Name")};N=V.getOrCreateObject(n,"@com.sap.vocabularies.Communication.v1."+a[Q].TermName);if(a[Q].Path){O=V.getOrCreateObject(N,a[Q].Path);O[a[Q].V4Attribute||Q]=P;N[a[Q].Path]=O;}else{N[a[Q].V4Attribute||Q]=P;}}}function p(i,R,n){if(n.schema.$Annotations){V.mergeAnnotations(n.convertedV2Annotations,n.schema.$Annotations);}else if(Object.keys(n.convertedV2Annotations).length>0){n.schema.$Annotations=n.convertedV2Annotations;}n.convertedV2Annotations={};}function h(i,n){var N=n.namespace+i.getAttribute("Name");n.associations[N]=n.association={referentialConstraint:null,roles:{}};}function j(i,n){var N=i.getAttribute("Role");n.association.roles[N]={multiplicity:i.getAttribute("Multiplicity"),propertyName:undefined,typeName:V.resolveAlias(i.getAttribute("Type"),n)};}function k(i,n){var N={associationName:V.resolveAlias(i.getAttribute("Association"),n),ends:[]};n.associationSet=N;n.associationSets.push(N);}function l(i,n){n.associationSet.ends.push({entitySetName:i.getAttribute("EntitySet"),roleName:i.getAttribute("Role")});}function o(i,n){F(i,n,{"$kind":"ComplexType"});}function r(i,n){if(i.getAttributeNS(M,"DataServiceVersion")!=="2.0"){throw new Error(n.url+" is not a valid OData V2 metadata document");}}function t(i,n){var N=n.association.referentialConstraint;n.constraintRole=N.dependent={roleName:i.getAttribute("Role")};}function u(i,n){var Q=n.namespace+i.getAttribute("Name");n.result[Q]=n.entityContainer={"$kind":"EntityContainer"};if(i.getAttributeNS(M,"IsDefaultEntityContainer")==="true"){n.defaultEntityContainer=Q;}V.annotatable(n,Q);}function w(i,n){var N=i.getAttribute("Name");n.entityContainer[N]=n.entitySet={$kind:"EntitySet",$Type:V.resolveAlias(i.getAttribute("EntityType"),n)};V.annotatable(n,N);c(i,n,"EntitySet");}function x(i,n){var T={$kind:"EntityType"};F(i,n,T);V.processAttributes(i,T,{"Abstract":V.setIfTrue,"BaseType":function(N){return N?V.resolveAlias(N,n):undefined;}});c(i,n,"EntityType");}function y(i,n){var N=i.getAttribute("Name");V.getOrCreateArray(n.type,"$Key").push(N);}function z(i,n){var N=i.getAttributeNS(M,"HttpMethod"),O=N==="POST"?"Action":"Function",P={$kind:O},Q=i.getAttribute("Name"),R=n.namespace+Q,T={$kind:O+"Import"},U=i.getAttribute("ReturnType"),W;T["$"+O]=R;V.processAttributes(i,T,{"EntitySet":V.setValue});if(U){P.$ReturnType=W={};G(U,W,n,i);}if(i.getAttributeNS(s,"action-for")){q.sap.log.warning("Unsupported 'sap:action-for' at FunctionImport '"+Q+"', removing this FunctionImport",undefined,m);}else{n.entityContainer[Q]=T;n.result[R]=[P];}n.function=P;V.annotatable(n,T);}function B(i,n){var N=n.function,P={$Name:i.getAttribute("Name")};V.processFacetAttributes(i,P);G(i.getAttribute("Type"),P,n,i);V.getOrCreateArray(N,"$Parameter").push(P);V.annotatable(n,P);}function C(i,n){var N=n.association.referentialConstraint;n.constraintRole=N.principal={roleName:i.getAttribute("Role")};}function D(i,n){n.association.referentialConstraint={};}function E(i,n){n.constraintRole.propertyRef=i.getAttribute("Name");}function F(i,n,T){var Q=n.namespace+i.getAttribute("Name");n.result[Q]=n.type=T;V.annotatable(n,Q);}function G(T,P,i,n){var N=V.rCollection.exec(T);if(N){P.$isCollection=true;T=N[1];}if(T.indexOf(".")<0){T="Edm."+T;}switch(T){case"Edm.DateTime":P.$v2Type=T;if(n.getAttributeNS(s,"display-format")==="Date"){T="Edm.Date";delete P.$Precision;}else{T="Edm.DateTimeOffset";}break;case"Edm.Float":P.$v2Type=T;T="Edm.Single";break;case"Edm.Time":P.$v2Type=T;T="Edm.TimeOfDay";break;default:T=V.resolveAlias(T,i);}P.$Type=T;}function H(i,n){var N=i.getAttribute("Name"),P={$kind:"NavigationProperty"};n.type[N]=P;n.navigationProperties.push({associationName:V.resolveAlias(i.getAttribute("Relationship"),n),fromRoleName:i.getAttribute("FromRole"),property:P,propertyName:N,toRoleName:i.getAttribute("ToRole")});}function I(i,n){var N=i.getAttribute("Name"),P={"$kind":"Property"};V.processFacetAttributes(i,P);G(i.getAttribute("Type"),P,n,i);n.type[N]=P;V.annotatable(n,N);c(i,n,"Property");}function J(i,n,N){var O=v[n],P;if(N===null||N===""){return;}if(O.property){P=i[O.term]||{};P[O.property]=N;}else{P=N;}i[O.term]=P;}function K(i){var n=i.defaultEntityContainer,N;if(n){i.result.$EntityContainer=n;}else{N=Object.keys(i.result).filter(function(Q){return i.result[Q].$kind==="EntityContainer";});if(N.length===1){i.result.$EntityContainer=N[0];}}}function L(i){i.navigationProperties.forEach(function(n){var N=i.associations[n.associationName],O=N.referentialConstraint,P=n.property,T=N.roles[n.toRoleName];P.$Type=T.typeName;T.propertyName=n.propertyName;if(T.multiplicity==="1"){P.$Nullable=false;}if(T.multiplicity==="*"){P.$isCollection=true;}if(O&&O.principal.roleName===n.toRoleName){P.$ReferentialConstraint={};P.$ReferentialConstraint[O.dependent.propertyRef]=O.principal.propertyRef;}});i.associationSets.forEach(function(n){var N=i.associations[n.associationName],O=i.entityContainer;function P(Q,R){var T=O[Q.entitySetName],U=N.roles[R.roleName];if(U.propertyName){T.$NavigationPropertyBinding=T.$NavigationPropertyBinding||{};T.$NavigationPropertyBinding[U.propertyName]=R.entitySetName;}}P(n.ends[0],n.ends[1]);P(n.ends[1],n.ends[0]);});}V=q.extend({},_,{convertXMLMetadata:function(i,U){var n,N;q.sap.measure.average("convertXMLMetadata","",m);N=i.documentElement;if(N.localName!=="Edmx"||N.namespaceURI!==e){throw new Error(U+" is not a valid OData V2 metadata document");}n={"aliases":{},"annotatable":null,"association":null,"associations":{},"associationSet":null,"associationSets":[],"constraintRole":null,"convertedV2Annotations":{},"defaultEntityContainer":null,"entityContainer":null,"entitySet":null,"function":null,"namespace":null,"navigationProperties":[],"processFacetAttributes":V.processFacetAttributes,"processTypedCollection":G,"schema":null,"type":null,"result":{"$Version":"4.0"},"url":U};V.traverse(N,n,A);V.traverse(N,n,f);K(n);L(n);q.sap.measure.end("convertXMLMetadata");return n.result;},mergeAnnotations:function(i,n){var N;for(N in i){if(N in n){n[N]=q.extend(i[N],n[N]);}else{n[N]=i[N];}}},processFacetAttributes:function(i,R){V.processAttributes(i,R,{"DefaultValue":V.setValue,"MaxLength":function(n){return n==="Max"?undefined:V.setNumber(n);},"Nullable":V.setIfFalse,"Precision":V.setNumber,"Scale":V.setNumber,"Unicode":V.setIfFalse});if(i.getAttribute("FixedLength")==="false"){R.$Scale="variable";}}});return V;},false);
