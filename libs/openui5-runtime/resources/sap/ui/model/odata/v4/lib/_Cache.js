/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./_Helper","./_SyncPromise"],function(q,_,a){"use strict";var r=/^[^-\d(][^(]*/,b=/^([^(]*)(\(.*\))$/;function c(m,p,i,D){if(i.$count!==undefined){s(m,p,i,i.$count+D);}}function f(A,v,j,E){var i;for(i=j;i<E;i++){A[i]=v;}}function g(i){return i.$count!==undefined?i.$count:Infinity;}function d(R,p){return p===""||R===p||R.indexOf(p+"/")===0;}function e(o,j,E,G,D){var k=o.sQueryString?"&":"?",l=E-j,p,R=o.sResourcePath+o.sQueryString+k+"$skip="+j+"&$top="+l;p=Promise.all([o.oRequestor.request("GET",R,G,undefined,undefined,D),o.fetchTypes()]).then(function(m){var n,t,u,i,v,w=m[0],x=w.value.length;C.computeCount(w);o.sContext=w["@odata.context"];t=w["@odata.count"];if(t){o.iLimit=parseInt(t,10);s(o.mChangeListeners,"",o.aElements,o.iLimit);}for(i=0;i<x;i++){u=w.value[i];o.aElements[j+i]=u;o.calculateKeyPredicates(u,m[1]);v=u["@$ui5.predicate"];if(v){o.aElements.$byPredicate[v]=u;}}if(x<l){n=Math.min(g(o.aElements),j+x);o.aElements.length=n;if(!t&&n>0&&!o.aElements[n-1]){n=undefined;}s(o.mChangeListeners,"",o.aElements,n);o.iLimit=n;}})["catch"](function(i){f(o.aElements,undefined,j,E);throw i;});o.bSentReadRequest=true;f(o.aElements,p,j,E);}function s(m,p,i,v){if(typeof v==="string"){v=parseInt(v,10);}_.updateCache(m,p,i,{$count:v});}function C(R,i,F,Q,j){this.bActive=true;this.mChangeListeners={};this.fnFetchType=F;this.mPatchRequests={};this.mPostRequests={};this.oRequestor=R;this.bSortExpandSelect=j;this.setQueryOptions(Q);this.sResourcePath=i;this.bSentReadRequest=false;this.oTypePromise=undefined;}C.prototype._delete=function(G,E,p,i){var j=p.split("/"),D=j.pop(),k=j.join("/"),t=this;return this.fetchValue(G,k).then(function(v){var o=D?v[D]:v,H,T=o["@$ui5.transient"];if(T===true){throw new Error("No 'delete' allowed while waiting for server response");}if(T){t.oRequestor.removePost(T,o);return Promise.resolve();}if(o["$ui5.deleting"]){throw new Error("Must not delete twice: "+E);}o["$ui5.deleting"]=true;H={"If-Match":o["@odata.etag"]};E+=t.oRequestor.buildQueryString(t.mQueryOptions,true);return t.oRequestor.request("DELETE",E,G,H)["catch"](function(l){if(l.status!==404){delete o["$ui5.deleting"];throw l;}}).then(function(){if(Array.isArray(v)){if(v[D]!==o){D=v.indexOf(o);}if(D==="-1"){delete v[-1];}else{if(o["@$ui5.predicate"]){delete v.$byPredicate[o["@$ui5.predicate"]];}v.splice(D,1);}c(t.mChangeListeners,k,v,-1);t.iLimit-=1;i(Number(D),v);}else{if(D){v[D]=null;}else{o["$ui5.deleted"]=true;}i();}});});};C.prototype.addByPath=function(m,p,i){if(i){if(!m[p]){m[p]=[i];}else if(m[p].indexOf(i)<0){m[p].push(i);}}};C.prototype.calculateKeyPredicates=function(R,t){var o=this.oRequestor;function v(I,p){var i,k,l;I.$byPredicate={};for(i=0;i<I.length;i++){k=I[i];j(k,p);l=k["@$ui5.predicate"];if(l){I.$byPredicate[k["@$ui5.predicate"]]=k;}}}function j(i,p){var T=t[p];if(T&&i){i["@$ui5.predicate"]=o.getKeyPredicate(T,i);Object.keys(i).forEach(function(k){var l=i[k],m=p+"/"+k;if(Array.isArray(l)){v(l,m);}else{j(l,m);}});}}j(R,this.sResourcePath);};C.prototype.checkActive=function(){var E;if(!this.bActive){E=new Error("Response discarded: cache is inactive");E.canceled=true;throw E;}};C.prototype.create=function(G,p,i,E,j,k){var l,t=this;function m(){t.removeByPath(t.mPostRequests,i,E);delete l[-1];j();}function n(){E["@$ui5.transient"]=true;}function o(u){E["@$ui5.transient"]=u;return a.resolve(p).then(function(v){v+=t.oRequestor.buildQueryString(t.mQueryOptions,true);t.addByPath(t.mPostRequests,i,E);return t.oRequestor.request("POST",v,u,null,E,n,m).then(function(R){delete E["@$ui5.transient"];c(t.mChangeListeners,i,l,1);t.removeByPath(t.mPostRequests,i,E);_.updateCacheAfterPost(t.mChangeListeners,_.buildPath(i,"-1"),E,R,_.getSelectForPath(t.mQueryOptions,i));t.fetchTypeFor(i).then(function(T){E["@$ui5.predicate"]=t.oRequestor.getKeyPredicate(T,E);});},function(w){if(w.canceled){throw w;}if(k){k(w);}return o(u==="$auto"||u==="$direct"?"$parked."+u:u);});});}E=E?JSON.parse(JSON.stringify(E)):{};l=this.fetchValue("$cached",i).getResult();if(!Array.isArray(l)){throw new Error("Create is only supported for collections; '"+i+"' does not reference a collection");}l[-1]=E;return o(G);};C.prototype.deregisterChange=function(p,l){this.removeByPath(this.mChangeListeners,p,l);};C.prototype.drillDown=function(D,p){var m,t=this;function i(j){q.sap.log.error("Failed to drill-down into "+p+", invalid segment: "+j,t.toString(),"sap.ui.model.odata.v4.lib._Cache");return undefined;}if(!p){return D;}return p.split("/").reduce(function(v,j){if(j==="$count"){return Array.isArray(v)?v.$count:i(j);}if(v===undefined||v===null){return undefined;}if(typeof v!=="object"){return i(j);}m=b.exec(j);if(m){if(m[1]){v=v[m[1]];}if(v){v=v.$byPredicate[m[2]];}}else{v=v[j];}return v===undefined?i(j):v;},D);};C.prototype.fetchTypeFor=function(p){var i=[this.sResourcePath];return this.fetchTypes().then(function(t){p.split("/").forEach(function(j){var m=r.exec(j);if(m){i.push(m[0]);}});return t[i.join("/")];});};C.prototype.fetchTypes=function(){var p,t,i=this;function j(B,Q){if(Q&&Q.$expand){Object.keys(Q.$expand).forEach(function(n){var l=B;n.split("/").forEach(function(m){l+="/"+m;k(l);});j(l,Q.$expand[n]);});}}function k(l){p.push(i.fnFetchType(l).then(function(T){if(T.$Key){t[l]=T;}}));}if(!this.oTypePromise){p=[];t={};k(this.sResourcePath);j(this.sResourcePath,this.mQueryOptions);this.oTypePromise=Promise.all(p).then(function(){return t;});}return this.oTypePromise;};C.prototype.hasPendingChangesForPath=function(p){return Object.keys(this.mPatchRequests).some(function(R){return d(R,p);})||Object.keys(this.mPostRequests).some(function(R){return d(R,p);});};C.prototype.registerChange=function(p,l){this.addByPath(this.mChangeListeners,p,l);};C.prototype.removeByPath=function(m,p,i){var I=m[p],j;if(I){j=I.indexOf(i);if(j>=0){if(I.length===1){delete m[p];}else{I.splice(j,1);}}}};C.prototype.resetChangesForPath=function(p){var t=this;Object.keys(this.mPatchRequests).forEach(function(R){var i,j;if(d(R,p)){j=t.mPatchRequests[R];for(i=j.length-1;i>=0;i--){t.oRequestor.removePatch(j[i]);}delete t.mPatchRequests[R];}});Object.keys(this.mPostRequests).forEach(function(R){var E,i,T;if(d(R,p)){E=t.mPostRequests[R];for(i=E.length-1;i>=0;i--){T=E[i]["@$ui5.transient"];if(T){t.oRequestor.removePost(T,E[i]);}}delete t.mPostRequests[R];}});};C.prototype.setActive=function(A){this.bActive=A;if(!A){this.mChangeListeners={};}};C.prototype.setQueryOptions=function(Q){if(this.bSentReadRequest){throw new Error("Cannot set query options: Cache has already sent a read request");}this.mQueryOptions=Q;this.sQueryString=this.oRequestor.buildQueryString(Q,false,this.bSortExpandSelect);};C.prototype.toString=function(){return this.oRequestor.getServiceUrl()+this.sResourcePath+this.sQueryString;};C.prototype.update=function(G,p,v,E,i,j){var k=p.split("/"),t=this;return this.fetchValue(G,j).then(function(o){var F=_.buildPath(j,p),O,l,m,T,u=C.makeUpdateData(k,v);function n(){t.removeByPath(t.mPatchRequests,F,l);_.updateCache(t.mChangeListeners,j,o,C.makeUpdateData(k,O));}function w(){l=t.oRequestor.request("PATCH",i,G,{"If-Match":o["@odata.etag"]},u,undefined,n);t.addByPath(t.mPatchRequests,F,l);return l.then(function(x){t.removeByPath(t.mPatchRequests,F,l);_.updateCache(t.mChangeListeners,j,o,x);return x;},function(x){t.removeByPath(t.mPatchRequests,F,l);if(!x.canceled){E(x);if(G!=="$auto"&&G!=="$direct"){return w();}}throw x;});}if(!o){throw new Error("Cannot update '"+p+"': '"+j+"' does not exist");}T=o["@$ui5.transient"];if(T){if(T===true){throw new Error("No 'update' allowed while waiting for server response");}if(T.indexOf("$parked.")===0){m=T;T=T.slice(8);}if(T!==G){throw new Error("The entity will be created via group '"+T+"'. Cannot patch via group '"+G+"'");}}O=k.reduce(function(V,x){return V&&V[x];},o);_.updateCache(t.mChangeListeners,j,o,u);if(T){if(m){o["@$ui5.transient"]=T;t.oRequestor.relocate(m,o,T);}return Promise.resolve({});}i+=t.oRequestor.buildQueryString(t.mQueryOptions,true);return w();});};function h(R,i,F,Q,j){C.apply(this,arguments);this.sContext=undefined;this.aElements=[];this.aElements.$byPredicate={};this.aElements.$count=undefined;this.iLimit=Infinity;}h.prototype=Object.create(C.prototype);h.prototype.fetchValue=function(G,p,D,l){var i,o,j,t=this;if(p==="$count"){o=a.all(this.aElements);}else if(p){j=p.split("/");i=parseInt(j.shift(),10);o=this.read(i,1,G,D);}else{o=a.resolve();}return o.then(function(){t.checkActive();t.registerChange(p,l);return t.drillDown(t.aElements,p);});};h.prototype.read=function(I,l,G,D){var i,E=I+l,j=-1,L=this.aElements[-1]?-1:0,k=Math.max(I,0),t=this;if(I<L){throw new Error("Illegal index "+I+", must be >= "+L);}if(l<0){throw new Error("Illegal length "+l+", must be >= 0");}E=Math.min(E,this.iLimit);for(i=I;i<E;i++){if(this.aElements[i]!==undefined){if(j>=0){e(this,j,i,G,D);D=undefined;j=-1;}}else if(j<0){j=i;}}if(j>=0){e(this,j,E,G,D);}return a.all(this.aElements.slice(k,E)).then(function(){var R;t.checkActive();R={"@odata.context":t.sContext,value:t.aElements.slice(k,E)};R.value.$count=t.aElements.$count;if(I===-1){R.value.unshift(t.aElements[-1]);}return R;});};function P(R,i,Q){C.call(this,R,i,undefined,Q);this.oPromise=null;}P.prototype=Object.create(C.prototype);P.prototype._delete=function(){throw new Error("Unsupported");};P.prototype.create=function(){throw new Error("Unsupported");};P.prototype.fetchValue=function(G,p,D,l){var t=this;t.registerChange("",l);if(!this.oPromise){this.oPromise=a.resolve(this.oRequestor.request("GET",this.sResourcePath+this.sQueryString,G,undefined,undefined,D));this.bSentReadRequest=true;}return this.oPromise.then(function(R){t.checkActive();return R.value;});};P.prototype.update=function(){throw new Error("Unsupported");};function S(R,i,F,Q,j,p){C.apply(this,arguments);this.bPost=p;this.bPosting=false;this.oPromise=null;}S.prototype=Object.create(C.prototype);S.prototype.fetchValue=function(G,p,D,l){var R=this.sResourcePath+this.sQueryString,t=this;this.registerChange(p,l);if(!this.oPromise){if(this.bPost){throw new Error("Cannot fetch a value before the POST request");}this.oPromise=a.all([this.oRequestor.request("GET",R,G,undefined,undefined,D),this.fetchTypes()]).then(function(i){t.calculateKeyPredicates(i[0],i[1]);C.computeCount(i[0]);return i[0];});this.bSentReadRequest=true;}return this.oPromise.then(function(o){t.checkActive();if(o["$ui5.deleted"]){throw new Error("Cannot read a deleted entity");}return t.drillDown(o,p);});};S.prototype.post=function(G,D,E){var t=this;if(!this.bPost){throw new Error("POST request not allowed");}if(this.bPosting){throw new Error("Parallel POST requests not allowed");}this.oPromise=a.resolve(this.oRequestor.request("POST",this.sResourcePath+this.sQueryString,G,{"If-Match":E},D).then(function(R){t.bPosting=false;return R;},function(o){t.bPosting=false;throw o;}));this.bPosting=true;return this.oPromise;};C.create=function(R,i,F,Q,j){return new h(R,i,F,Q,j);};C.createProperty=function(R,i,Q){return new P(R,i,Q);};C.createSingle=function(R,i,F,Q,j,p){return new S(R,i,F,Q,j,p);};C.computeCount=function(R){if(R&&typeof R==="object"){Object.keys(R).forEach(function(k){var i,v=R[k];if(Array.isArray(v)){v.$count=undefined;i=R[k+"@odata.count"];if(i){s({},"",v,i);}else if(!R[k+"@odata.nextLink"]){s({},"",v,v.length);}v.forEach(C.computeCount);}else{C.computeCount(v);}});}};C.makeUpdateData=function(p,v){return p.reduceRight(function(V,i){var R={};R[i]=V;return R;},v);};return C;},false);
