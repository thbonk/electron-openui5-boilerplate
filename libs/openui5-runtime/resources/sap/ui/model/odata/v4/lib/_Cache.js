/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./_Helper","./_SyncPromise"],function(q,_,a){"use strict";function b(m,p,i,D){if(i.$count!==undefined){s(m,p,i,i.$count+D);}}function c(Q,R,D){Object.keys(Q).forEach(function(k){var v=Q[k];if(D&&k[0]==='$'){return;}switch(k){case"$expand":v=C.convertExpand(v);break;case"$apply":case"$count":case"$filter":case"$orderby":case"$search":break;case"$select":if(Array.isArray(v)){v=v.join(",");}break;default:if(k[0]==='$'){throw new Error("Unsupported system query option "+k);}}R(k,v);});}function d(p,v){return p.reduceRight(function(V,i){var R={};R[i]=V;return R;},v);}function f(A,v,j,E){var i;for(i=j;i<E;i++){A[i]=v;}}function g(i){return i.$count!==undefined?i.$count:Infinity;}function e(R,p){return p===""||R===p||R.indexOf(p+"/")===0;}function r(o,j,E,G,D){var k=E-j,p,R=o.sResourcePath+"$skip="+j+"&$top="+k;p=o.oRequestor.request("GET",R,G,undefined,undefined,D).then(function(l){var m,n,i,t=l.value.length;C.computeCount(l);o.sContext=l["@odata.context"];n=l["@odata.count"];if(n){s(o.mChangeListeners,"",o.aElements,n);}for(i=0;i<t;i++){o.aElements[j+i]=l.value[i];}if(t<k){m=Math.min(g(o.aElements),j+t);s(o.mChangeListeners,"",o.aElements,m);o.aElements.length=m;}})["catch"](function(i){f(o.aElements,undefined,j,E);throw i;});f(o.aElements,p,j,E);}function s(m,p,i,v){if(typeof v==="string"){v=parseInt(v,10);}_.updateCache(m,p,i,{$count:v});}function u(o,G,p,v,E,i,j){var B,H,O,k,l=p.split("/"),t,U=_.buildPath(i,p),m;function n(){o.removeByPath(o.mPatchRequests,U,m);_.updateCache(o.mChangeListeners,i,j,d(l,O));}if(!j){throw new Error("Cannot update '"+p+"': '"+i+"' does not exist");}t=j["@$ui5.transient"];if(t===true){throw new Error("No 'update' allowed while waiting for server response");}if(t&&t.indexOf("$parked.")===0){k=t;t=t.slice(8);}if(t&&t!==G){throw new Error("The entity will be created via group '"+t+"'. Cannot patch via group '"+G+"'");}E+=C.buildQueryString(o.mQueryOptions,true);H={"If-Match":j["@odata.etag"]};B=d(l,v);O=l.reduce(function(V,w){return V&&V[w];},j);_.updateCache(o.mChangeListeners,i,j,d(l,v));if(t){if(k){j["@$ui5.transient"]=t;o.oRequestor.relocate(k,j,t);}return Promise.resolve({});}m=o.oRequestor.request("PATCH",E,G,H,B,undefined,n);o.addByPath(o.mPatchRequests,U,m);return m.then(function(w){o.removeByPath(o.mPatchRequests,U,m);_.updateCache(o.mChangeListeners,i,j,w);return w;},function(w){o.removeByPath(o.mPatchRequests,U,m);throw w;});}function C(R,i,Q){this.bActive=true;this.mChangeListeners={};this.mPatchRequests={};this.mQueryOptions=Q;this.oRequestor=R;this.sResourcePath=i+C.buildQueryString(Q);}C.prototype.addByPath=function(m,p,i){if(i){if(!m[p]){m[p]=[i];}else if(m[p].indexOf(i)>=0){return;}else{m[p].push(i);}}};C.prototype.checkActive=function(){var E;if(!this.bActive){E=new Error("Response discarded: cache is inactive");E.canceled=true;throw E;}};C.prototype.deregisterChange=function(p,l){this.removeByPath(this.mChangeListeners,p,l);};C.prototype.drillDown=function(D,p){var t=this;function i(j){q.sap.log.error("Failed to drill-down into "+p+", invalid segment: "+j,t.toString(),"sap.ui.model.odata.v4.lib._Cache");}if(p){p.split("/").every(function(j){if(j==="$count"){if(!Array.isArray(D)){i(j);D=undefined;return false;}D=D.$count;return true;}if(!D||typeof D!=="object"){if(D!==null){i(j);}D=undefined;return false;}D=D[j];if(D===undefined){i(j);return false;}return true;});}return D;};C.prototype.hasPendingChangesForPath=function(p){return Object.keys(this.mPatchRequests).some(function(R){return e(R,p);});};C.prototype.registerChange=function(p,l){this.addByPath(this.mChangeListeners,p,l);};C.prototype.removeByPath=function(m,p,i){var I=m[p],j;if(I){j=I.indexOf(i);if(j>=0){if(I.length===1){delete m[p];}else{I.splice(j,1);}}}};C.prototype.resetChangesForPath=function(p){Object.keys(this.mPatchRequests).forEach(function(R){var i,j;if(e(R,p)){j=this.mPatchRequests[R];for(i=j.length-1;i>=0;i--){this.oRequestor.removePatch(j[i]);}delete this.mPatchRequests[R];}},this);};C.prototype.setActive=function(A){this.bActive=A;if(!A){this.mChangeListeners={};}};C.prototype.toString=function(){return this.oRequestor.getServiceUrl()+this.sResourcePath;};function h(R,i,Q){C.apply(this,arguments);this.sContext=undefined;this.aElements=[];this.aElements.$count=undefined;this.sResourcePath+=this.sResourcePath.indexOf("?")>=0?"&":"?";}h.prototype=Object.create(C.prototype);h.prototype._delete=function(G,E,p,i){var j=p.split("/"),D=j.pop(),k=j.join("/"),t=this;return this.fetchValue(G,k).then(function(o){var l,H,T;l=o[D];T=l["@$ui5.transient"];if(T===true){throw new Error("No 'delete' allowed while waiting for server response");}if(T){t.oRequestor.removePost(T,l);return Promise.resolve();}if(l["$ui5.deleting"]){throw new Error("Must not delete twice: "+E);}l["$ui5.deleting"]=true;H={"If-Match":l["@odata.etag"]};E+=C.buildQueryString(t.mQueryOptions,true);return t.oRequestor.request("DELETE",E,G,H)["catch"](function(m){if(m.status!==404){delete l["$ui5.deleting"];throw m;}}).then(function(){if(o[D]!==l){D=o.indexOf(l);}if(D==="-1"){delete o[-1];}else{o.splice(D,1);}b(t.mChangeListeners,k,o,-1);i(Number(D));});});};h.prototype.create=function(G,p,i,E,j,k){var t=this;function l(){delete t.aElements[-1];j();}function m(){E["@$ui5.transient"]=true;}function n(o){E["@$ui5.transient"]=o;return t.oRequestor.request("POST",p,o,null,E,m,l).then(function(R){delete E["@$ui5.transient"];b(t.mChangeListeners,"",t.aElements,1);_.updateCache(t.mChangeListeners,"-1",E,R);},function(v){if(v.canceled){throw v;}if(k){k(v);}return n(o==="$auto"||o==="$direct"?"$parked."+o:o);});}E=E?JSON.parse(JSON.stringify(E)):{};this.aElements[-1]=E;E["@odata.etag"]=undefined;p+=C.buildQueryString(this.mQueryOptions,true);return n(G);};h.prototype.fetchValue=function(G,p,D,l){var i,o,j,t=this;if(p==="$count"){o=a.all(this.aElements);}else if(p){j=p.split("/");i=parseInt(j.shift(),10);o=this.read(i,1,G,D);}else{o=a.resolve();}return o.then(function(){t.checkActive();t.registerChange(p,l);return t.drillDown(t.aElements,p);});};h.prototype.hasPendingChangesForPath=function(p){return!!(p===""&&this.aElements[-1]&&this.aElements[-1]["@$ui5.transient"])||C.prototype.hasPendingChangesForPath.call(this,p);};h.prototype.read=function(I,l,G,D){var i,E=I+l,j=-1,L=this.aElements[-1]?-1:0,k=Math.max(I,0),t=this;if(I<L){throw new Error("Illegal index "+I+", must be >= "+L);}if(l<0){throw new Error("Illegal length "+l+", must be >= 0");}E=Math.min(E,g(this.aElements));for(i=I;i<E;i++){if(this.aElements[i]!==undefined){if(j>=0){r(this,j,i,G,D);D=undefined;j=-1;}}else if(j<0){j=i;}}if(j>=0){r(this,j,E,G,D);D=undefined;}return a.all(this.aElements.slice(k,E)).then(function(){var R;t.checkActive();R={"@odata.context":t.sContext,value:t.aElements.slice(k,E)};R.value.$count=t.aElements.$count;if(I===-1){R.value.unshift(t.aElements[-1]);}return R;});};h.prototype.resetChangesForPath=function(p){var t;if(p===""&&this.aElements[-1]){t=this.aElements[-1]["@$ui5.transient"];if(t){this.oRequestor.removePost(t,this.aElements[-1]);}}C.prototype.resetChangesForPath.call(this,p);};h.prototype.update=function(G,p,v,E,i){return this.fetchValue(G,i).then(u.bind(null,this,G,p,v,E,i));};function P(R,i,Q){C.apply(this,arguments);this.oPromise=null;}P.prototype=Object.create(C.prototype);P.prototype.fetchValue=function(G,p,D,l){var t=this;t.registerChange("",l);if(!this.oPromise){this.oPromise=a.resolve(this.oRequestor.request("GET",this.sResourcePath,G,undefined,undefined,D));}return this.oPromise.then(function(R){t.checkActive();return R.value;});};function S(R,i,Q,p){C.apply(this,arguments);this.bPost=p;this.bPosting=false;this.oPromise=null;}S.prototype=Object.create(C.prototype);S.prototype._delete=function(G,E,p,i){var j=p.split("/"),D=j.pop(),k=j.join("/"),t=this;return this.fetchValue(G,k).then(function(v){var o=D?v[D]:v,H={"If-Match":o["@odata.etag"]};if(o["$ui5.deleting"]){throw new Error("Must not delete twice: "+E);}o["$ui5.deleting"]=true;E+=C.buildQueryString(t.mQueryOptions,true);return t.oRequestor.request("DELETE",E,G,H)["catch"](function(l){if(l.status!==404){delete o["$ui5.deleting"];throw l;}}).then(function(){if(Array.isArray(v)){if(v[D]!==o){D=v.indexOf(o);}v.splice(D,1);b(t.mChangeListeners,k,v,-1);i(Number(D));}else{if(D){v[D]=null;}else{o["$ui5.deleted"]=true;}i();}});});};S.prototype.post=function(G,D,E){var t=this;if(!this.bPost){throw new Error("POST request not allowed");}if(this.bPosting){throw new Error("Parallel POST requests not allowed");}this.oPromise=a.resolve(this.oRequestor.request("POST",this.sResourcePath,G,{"If-Match":E},D).then(function(R){t.bPosting=false;return R;},function(o){t.bPosting=false;throw o;}));this.bPosting=true;return this.oPromise;};S.prototype.fetchValue=function(G,p,D,l){var t=this,R=this.sResourcePath;this.registerChange(p,l);if(!this.oPromise){if(this.bPost){throw new Error("Cannot fetch a value before the POST request");}this.oPromise=a.resolve(this.oRequestor.request("GET",R,G,undefined,undefined,D)).then(function(o){C.computeCount(o);return o;});}return this.oPromise.then(function(o){t.checkActive();if(o["$ui5.deleted"]){throw new Error("Cannot read a deleted entity");}return t.drillDown(o,p);});};S.prototype.update=function(G,p,v,E,i){return this.fetchValue(G,i).then(u.bind(null,this,G,p,v,E,i));};C.buildQueryString=function(Q,D){return _.buildQuery(C.convertQueryOptions(Q,D));};C.convertExpand=function(E){var R=[];if(!E||typeof E!=="object"){throw new Error("$expand must be a valid object");}Object.keys(E).forEach(function(i){var v=E[i];if(v&&typeof v==="object"){R.push(C.convertExpandOptions(i,v));}else{R.push(i);}});return R.join(",");};C.convertExpandOptions=function(E,v){var i=[];c(v,function(o,O){i.push(o+'='+O);});return i.length?E+"("+i.join(";")+")":E;};C.convertQueryOptions=function(Q,D){var m={};if(!Q){return undefined;}c(Q,function(k,v){m[k]=v;},D);return m;};C.create=function(R,i,Q){return new h(R,i,Q);};C.createProperty=function(R,i,Q){return new P(R,i,Q);};C.createSingle=function(R,i,Q,p){return new S(R,i,Q,p);};C.computeCount=function(R){Object.keys(R).forEach(function(k){var i,v=R[k];if(Array.isArray(v)){v.$count=undefined;i=R[k+"@odata.count"];if(i){s({},"",v,i);}else if(!R[k+"@odata.nextLink"]){s({},"",v,v.length);}v.forEach(C.computeCount);}else if(v&&typeof v==="object"){C.computeCount(v);}});};return C;},false);
