/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./Context","./ODataParentBinding","./lib/_Cache","./lib/_GroupLock","./lib/_Helper","sap/ui/base/SyncPromise","sap/ui/model/Binding","sap/ui/model/ChangeReason","sap/ui/model/ContextBinding","sap/ui/thirdparty/jquery"],function(C,a,_,b,c,S,B,d,f,q){"use strict";var s="sap.ui.model.odata.v4.ODataContextBinding",m={AggregatedDataStateChange:true,change:true,dataReceived:true,dataRequested:true,DataStateChange:true,patchCompleted:true,patchSent:true};function g(p,r){return p.slice(0,p.indexOf("("))+r;}var O=f.extend("sap.ui.model.odata.v4.ODataContextBinding",{constructor:function(M,p,o,P){var i=p.indexOf("(...)");f.call(this,M,p);a.call(this);if(p.slice(-1)==="/"){throw new Error("Invalid path: "+p);}this.oCachePromise=S.resolve();this.sGroupId=undefined;this.bInheritExpandSelect=false;this.oOperation=undefined;this.oReadGroupLock=undefined;this.oReturnValueContext=null;this.sUpdateGroupId=undefined;if(i>=0){this.oOperation={bAction:undefined,mParameters:{},sResourcePath:undefined};if(i!==this.sPath.length-5){throw new Error("The path must not continue after a deferred operation: "+this.sPath);}}this.applyParameters(q.extend(true,{},P));this.oElementContext=this.bRelative?null:C.create(this.oModel,this,p);if(!this.oOperation&&(!this.bRelative||o&&!o.fetchValue)){this.createReadGroupLock(this.getGroupId(),true);}this.setContext(o);M.bindingCreated(this);},metadata:{publicMethods:[]}});a(O.prototype);O.prototype._delete=function(G,e){var t=this;if(this.sPath===""&&this.oContext.delete){return this.oContext._delete(G);}if(this.hasPendingChanges()){throw new Error("Cannot delete due to pending changes");}return this.deleteFromCache(G,e,"",function(){t.oElementContext.destroy();t.oElementContext=null;if(t.oReturnValueContext){t.oReturnValueContext.destroy();t.oReturnValueContext=null;}t._fireChange({reason:d.Remove});});};O.prototype._execute=function(G){var M=this.oModel.getMetaModel(),o,p,r=this.getResolvedPath(),t=this;function e(){t._fireChange({reason:d.Change});return t.refreshDependentBindings(G.getGroupId(),true);}G.setGroupId(this.getGroupId());p=M.fetchObject(M.getMetaPath(r)+"/@$ui5.overload").then(function(h){var i,I,P;if(!h){throw new Error("Unknown operation: "+r);}if(h.length!==1){throw new Error("Unsupported overloads for "+r);}if(t.bRelative&&t.oContext.getBinding){I=t.sPath.lastIndexOf("/");P=I>=0?t.sPath.slice(0,I):"";i=t.oContext.getValue.bind(t.oContext,P);}o=h[0];return t.createCacheAndRequest(G,r,o,i);}).then(function(R){var h,i;return e().then(function(){if(t.hasReturnValueContext(o)){h=c.getPrivateAnnotation(t.oContext.fetchValue().getResult(),"predicate");i=c.getPrivateAnnotation(R,"predicate");if(h===i){t.oContext.patch(R);}if(t.oReturnValueContext){t.oReturnValueContext.destroy();}t.oReturnValueContext=C.create(t.oModel,t,g(r,i));return t.oReturnValueContext;}});},function(E){var h;function i(j){if(j.target){var k=j.target.split("/");if(k.shift()===h){j.target=k.join("/");return;}}delete j.target;}if(o&&o.$IsBound){h=o.$Parameter[0].$Name;E.resourcePath=t.oContext.getPath().slice(1);if(E.error){i(E.error);if(E.error.details){E.error.details.forEach(i);}}}return e().then(function(){throw E;});}).catch(function(E){G.unlock(true);if(t.oReturnValueContext){t.oReturnValueContext.destroy();t.oReturnValueContext=null;}t.oModel.reportError("Failed to execute "+r,s,E);throw E;});return Promise.resolve(p);};O.prototype.applyParameters=function(p,e){this.checkBindingParameters(p,["$$canonicalPath","$$groupId","$$inheritExpandSelect","$$ownRequest","$$patchWithoutSideEffects","$$updateGroupId"]);this.sGroupId=p.$$groupId;this.sUpdateGroupId=p.$$updateGroupId;this.bInheritExpandSelect=p.$$inheritExpandSelect;this.mQueryOptions=this.oModel.buildQueryOptions(p,true);this.mParameters=p;if(!this.oOperation){this.fetchCache(this.oContext);if(e){this.refreshInternal(undefined,true);}else{this.checkUpdate();}}else if(this.oOperation.bAction===false){this.execute();}};O.prototype.attachEvent=function(e){if(!(e in m)){throw new Error("Unsupported event '"+e+"': v4.ODataContextBinding#attachEvent");}return f.prototype.attachEvent.apply(this,arguments);};O.prototype.computeOperationQueryOptions=function(){var p,Q=q.extend({},this.oModel.mUriParameters,this.mQueryOptions);if(this.bInheritExpandSelect){p=this.oContext.getBinding().mCacheQueryOptions;if("$select"in p){Q.$select=p.$select;}if("$expand"in p){Q.$expand=p.$expand;}}return Q;};O.prototype.createCacheAndRequest=function(G,p,o,e){var A=o.$kind==="Action",h,E=e,M=this.oModel,i=M.getMetaModel().getMetaPath(p)+"/@$ui5.overload/0/$ReturnType",j=p.slice(1),P=q.extend({},this.oOperation.mParameters),r=M.oRequestor,t=this;function k(R){if(t.hasReturnValueContext(o)){return g(j,c.getPrivateAnnotation(R,"predicate"));}return j;}if(!A&&o.$kind!=="Function"){throw new Error("Not an operation: "+p);}if(this.bInheritExpandSelect&&!this.hasReturnValueContext(o)){throw new Error("Must not set parameter $$inheritExpandSelect on binding which has "+"no return value context");}this.oOperation.bAction=A;if(A&&e){E=e();}this.mCacheQueryOptions=this.computeOperationQueryOptions();p=r.getPathAndAddQueryOptions(p,o,P,this.mCacheQueryOptions,E);h=_.createSingle(r,p,this.mCacheQueryOptions,M.bAutoExpandSelect,k,A,i,o.$ReturnType&&!o.$ReturnType.$Type.startsWith("Edm."));this.oCachePromise=S.resolve(h);return A?h.post(G,P,E):h.fetchValue(G);};O.prototype.destroy=function(){if(this.oElementContext){this.oElementContext.destroy();this.oElementContext=undefined;}if(this.oReturnValueContext){this.oReturnValueContext.destroy();this.oReturnValueContext=undefined;}this.oModel.bindingDestroyed(this);this.removeReadGroupLock();this.mCacheByResourcePath=undefined;this.oCachePromise=S.resolve();this.mCacheQueryOptions=undefined;this.oContext=undefined;this.oOperation=undefined;this.mParameters=undefined;this.mQueryOptions=undefined;a.prototype.destroy.apply(this);f.prototype.destroy.apply(this);};O.prototype.doCreateCache=function(r,Q){return _.createSingle(this.oModel.oRequestor,r,Q,this.oModel.bAutoExpandSelect);};O.prototype.doFetchQueryOptions=function(){return S.resolve(this.mQueryOptions);};O.prototype.execute=function(G){var r=this.oModel.resolve(this.sPath,this.oContext);this.checkSuspended();this.oModel.checkGroupId(G);if(!this.oOperation){throw new Error("The binding must be deferred: "+this.sPath);}if(this.bRelative){if(!r){throw new Error("Unresolved binding: "+this.sPath);}if(this.oContext.isTransient&&this.oContext.isTransient()){throw new Error("Execute for transient context not allowed: "+r);}if(this.oContext.getPath().indexOf("(...)")>=0){throw new Error("Nested deferred operation bindings not supported: "+r);}}return this._execute(this.lockGroup(G,true));};O.prototype.fetchValue=function(p,l,e){var E,G,r=this.getRootBinding(),t=this;if(r&&r.isSuspended()){E=new Error("Suspended binding provides no value");E.canceled="noDebugLog";throw E;}return this.oCachePromise.then(function(o){var D=false,R;if(o){R=t.getRelativePath(p);if(R!==undefined){if(e){G=b.$cached;}else{G=t.lockGroup(t.getGroupId(),t.oReadGroupLock);t.oReadGroupLock=undefined;}return o.fetchValue(G,R,function(){D=true;t.fireDataRequested();},l).then(function(v){if(D){t.fireDataReceived({data:{}});}return v;},function(E){G.unlock(true);if(D){t.oModel.reportError("Failed to read path "+t.sPath,s,E);t.fireDataReceived(E.canceled?{data:{}}:{error:E});}throw E;});}}if(!t.oOperation&&t.oContext&&t.oContext.fetchValue){return t.oContext.fetchValue(p,l,e);}});};O.prototype.getResolvedPath=function(){var p="",r=this.oModel.resolve(this.sPath,this.oContext),e,t=this;if(r&&r.includes("/-1")){e=r.slice(1).split("/");r="";e.forEach(function(h){var E,P;p+="/"+h;if(h==="-1"){E=t.oContext.fetchValue(p).getResult();P=c.getPrivateAnnotation(E,"predicate");if(!P){throw new Error("No key predicate known at "+p);}r+=P;}else{r+="/"+h;}});}return r;};O.prototype.hasReturnValueContext=function(M){var o=this.oModel.getMetaModel(),e;if(!(this.bRelative&&this.oContext&&this.oContext.getBinding)){return false;}e=o.getMetaPath(this.oModel.resolve(this.sPath,this.oContext)).split("/");return M.$IsBound&&M.$ReturnType&&!M.$ReturnType.$isCollection&&M.$EntitySetPath&&M.$EntitySetPath.indexOf("/")<0&&e.length===3&&o.getObject("/"+e[1]).$kind==="EntitySet";};O.prototype.refreshInternal=function(G,e){var t=this;if(this.oOperation&&this.oOperation.bAction!==false){return S.resolve();}this.createReadGroupLock(G,this.isRefreshable());return this.oCachePromise.then(function(o){var r=t.oReadGroupLock;if(!t.oElementContext){t.oElementContext=C.create(t.oModel,t,t.oModel.resolve(t.sPath,t.oContext));if(!o){t._fireChange({reason:d.Refresh});}}if(t.oOperation){t.oReadGroupLock=undefined;return t._execute(r);}if(o){t.removeCachesAndMessages();t.fetchCache(t.oContext);}return t.refreshDependentBindings(G,e);});};O.prototype.refreshReturnValueContext=function(o,G){var e,M=this.oModel;if(this.oReturnValueContext!==o){return null;}this.mCacheQueryOptions=this.computeOperationQueryOptions();e=_.createSingle(M.oRequestor,this.oReturnValueContext.getPath().slice(1),this.mCacheQueryOptions,true);this.oCachePromise=S.resolve(e);this.createReadGroupLock(G,true);return this.refreshDependentBindings(G,true);};O.prototype.requestSideEffects=function(G,p,o){var h=this.oCachePromise.getResult(),D,M=this.oModel,P=[];function i(j){P.push(j.catch(function(E){M.reportError("Failed to request side effects",s,E);throw E;}));}if(p.indexOf("")<0){try{i(h.requestSideEffects(M.lockGroup(G),p,o&&o.getPath().slice(1)));D=o?M.getDependentBindings(o):this.getDependentBindings();D.forEach(function(j){var k;if(j.oCachePromise.getResult()){k=c.stripPathPrefix(j.getPath(),p);if(k.length){i(j.requestSideEffects(G,k));}}});return S.all(P);}catch(e){if(!e.message.startsWith("Unsupported collection-valued navigation property ")){throw e;}}}return o&&this.refreshReturnValueContext(o,G)||this.refreshInternal(G,true);};O.prototype.resumeInternal=function(e){if(!this.oOperation){this.mAggregatedQueryOptions={};this.bAggregatedQueryOptionsInitial=true;this.removeCachesAndMessages();this.fetchCache(this.oContext);this.getDependentBindings().forEach(function(D){D.resumeInternal(e);});this._fireChange({reason:d.Change});}else if(this.oOperation.bAction===false){this.execute();}};O.prototype.setContext=function(o){if(this.oContext!==o){if(this.bRelative&&(this.oContext||o)){if(this.oElementContext){this.oElementContext.destroy();this.oElementContext=null;}if(this.oReturnValueContext){this.oReturnValueContext.destroy();this.oReturnValueContext=null;}this.fetchCache(o);if(o){this.oElementContext=C.create(this.oModel,this,this.oModel.resolve(this.sPath,o));}B.prototype.setContext.call(this,o);}else{this.oContext=o;}}};O.prototype.setParameter=function(p,v){if(!this.oOperation){throw new Error("The binding must be deferred: "+this.sPath);}if(!p){throw new Error("Missing parameter name");}if(v===undefined){throw new Error("Missing value for parameter: "+p);}this.oOperation.mParameters[p]=v;this.oOperation.bAction=undefined;return this;};return O;});
