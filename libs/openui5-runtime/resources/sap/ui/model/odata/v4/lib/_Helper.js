/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/util/isEmptyObject","sap/ui/thirdparty/URI"],function(L,a,U){"use strict";var r=/&/g,b=/\=/g,c=/%29/g,d=/%28/g,f=/%27/g,g=/#/g,_,h=/\([^/]*|\/-?\d+/g,j=/^-?\d+$/,k=/\+/g,l=/'/g;_={addByPath:function(m,p,i){if(i){if(!m[p]){m[p]=[i];}else if(m[p].indexOf(i)<0){m[p].push(i);}}},addChildrenWithAncestor:function(C,A,m){if(A.length){C.forEach(function(p){var s;if(A.indexOf(p)>=0){m[p]=true;return;}s=p.split("/");s.pop();while(s.length){if(A.indexOf(s.join("/"))>=0){m[p]=true;break;}s.pop();}});}},buildPath:function(){var i,p="",s;for(i=0;i<arguments.length;i++){s=arguments[i];if(s||s===0){if(p&&p!=="/"&&s[0]!=="("){p+="/";}p+=s;}}return p;},buildQuery:function(p){var K,q;if(!p){return"";}K=Object.keys(p);if(K.length===0){return"";}q=[];K.forEach(function(s){var v=p[s];if(Array.isArray(v)){v.forEach(function(i){q.push(_.encodePair(s,i));});}else{q.push(_.encodePair(s,v));}});return"?"+q.join("&");},clone:function clone(v){return v===undefined||v===Infinity||v===-Infinity||v!==v?v:JSON.parse(JSON.stringify(v));},createError:function(i,R,s){var B=i.responseText,C=i.getResponseHeader("Content-Type"),o=new Error(i.status+" "+i.statusText);o.status=i.status;o.statusText=i.statusText;o.requestUrl=R;o.resourcePath=s;if(i.status===0){o.message="Network error";return o;}if(C){C=C.split(";")[0];}if(i.status===412){o.isConcurrentModification=true;}if(C==="application/json"){try{o.error=JSON.parse(B).error;o.message=o.error.message;if(typeof o.message==="object"){o.message=o.error.message.value;}}catch(e){L.warning(e.toString(),B,"sap.ui.model.odata.v4.lib._Helper");}}else if(C==="text/plain"){o.message=B;}return o;},createGetMethod:function(F,t){return function(){var s=this[F].apply(this,arguments);if(s.isFulfilled()){return s.getResult();}else if(t){if(s.isRejected()){s.caught();throw s.getResult();}else{throw new Error("Result pending");}}};},createRequestMethod:function(F){return function(){return Promise.resolve(this[F].apply(this,arguments));};},deletePrivateAnnotation:function(o,A){var p=o["@$ui5._"];if(p){delete p[A];}},drillDown:function(D,p){return p.reduce(function(D,s){return(D&&s in D)?D[s]:undefined;},D);},encode:function(p,e){var E=encodeURI(p).replace(r,"%26").replace(g,"%23").replace(k,"%2B");if(e){E=E.replace(b,"%3D");}return E;},encodePair:function(K,v){return _.encode(K,true)+"="+_.encode(v,false);},fireChange:function(C,p,v){var e=C[p],i;if(e){for(i=0;i<e.length;i++){e[i].onChange(v);}}},fireChanges:function(C,p,v,R){Object.keys(v).forEach(function(P){var s=_.buildPath(p,P),V=v[P];if(V&&typeof V==="object"){_.fireChanges(C,s,V,R);}else{_.fireChange(C,s,R?undefined:V);}});},formatLiteral:function(v,t){if(v===undefined){throw new Error("Illegal value: undefined");}if(v===null){return"null";}switch(t){case"Edm.Binary":return"binary'"+v+"'";case"Edm.Boolean":case"Edm.Byte":case"Edm.Double":case"Edm.Int16":case"Edm.Int32":case"Edm.SByte":case"Edm.Single":return String(v);case"Edm.Date":case"Edm.DateTimeOffset":case"Edm.Decimal":case"Edm.Guid":case"Edm.Int64":case"Edm.TimeOfDay":return v;case"Edm.Duration":return"duration'"+v+"'";case"Edm.String":return"'"+v.replace(l,"''")+"'";default:throw new Error("Unsupported type: "+t);}},getKeyPredicate:function(i,m,t){var K=[],e=_.getKeyProperties(i,m,t,true);if(!e){return undefined;}K=Object.keys(e).map(function(A,I,n){var v=encodeURIComponent(e[A]);return n.length===1?v:encodeURIComponent(A)+"="+v;});return"("+K.join(",")+")";},getKeyProperties:function(i,m,t,R){var F,K={};F=t[m].$Key.some(function(v){var s,e,p,P,T,V;if(typeof v==="string"){s=e=v;}else{s=Object.keys(v)[0];e=v[s];if(!R){s=e;}}p=e.split("/");V=_.drillDown(i,p);if(V===undefined){return true;}P=p.pop();T=t[_.buildPath(m,p.join("/"))];V=_.formatLiteral(V,T[P].$Type);K[s]=V;});return F?undefined:K;},getMetaPath:function(p){return p.replace(h,"");},getPrivateAnnotation:function(o,A){var p=o["@$ui5._"];return p&&p[A];},getSelectForPath:function(q,p){if(p){p.split("/").some(function(s){if(!j.test(s)){q=q&&q.$expand&&q.$expand[s];}});}return q&&q.$select;},hasPrivateAnnotation:function(o,A){var p=o["@$ui5._"];return p?A in p:false;},intersectQueryOptions:function(C,p,F,R){var e=[],E={},m,s,S={};function n(M){if(F(M).getResult().$isCollection){throw new Error("Unsupported collection-valued navigation property "+M);}}function o(q,M){var t=M.split("/");return t.every(function(u,i){return i===0&&q||F(R+"/"+t.slice(0,i+1).join("/")).getResult().$kind==="Property";});}if(p.indexOf("")>=0){throw new Error("Unsupported empty navigation property path");}if(C.$select&&C.$select.indexOf("*")<0){_.addChildrenWithAncestor(p,C.$select,S);_.addChildrenWithAncestor(C.$select,p,S);s=Object.keys(S).filter(o.bind(null,true));}else{s=p.filter(o.bind(null,false));}if(C.$expand){e=Object.keys(C.$expand);e.forEach(function(N){var i,M=R+"/"+N,q={},t;_.addChildrenWithAncestor([N],p,q);if(!a(q)){n(M);E[N]=C.$expand[N];return;}t=_.stripPathPrefix(N,p);if(t.length){n(M);i=_.intersectQueryOptions(C.$expand[N]||{},t,F,R+"/"+N);if(i){E[N]=i;}}});}if(!s.length&&a(E)){return null;}if(!s.length){s=Object.keys(E).slice(0,1);}m=Object.assign({},C,{$select:s});if(a(E)){delete m.$expand;}else{m.$expand=E;}return m;},isSafeInteger:function(n){if(typeof n!=="number"||!isFinite(n)){return false;}n=Math.abs(n);return n<=9007199254740991&&Math.floor(n)===n;},makeAbsolute:function(u,B){return new U(u).absoluteTo(B).toString().replace(f,"'").replace(d,"(").replace(c,")");},namespace:function(n){var i=n.indexOf("/");if(i>=0){n=n.slice(0,i);}i=n.lastIndexOf(".");return i<0?"":n.slice(0,i);},parseLiteral:function(s,t,p){function e(n){if(!isFinite(n)){throw new Error(p+": Not a valid "+t+" literal: "+s);}return n;}if(s==="null"){return null;}switch(t){case"Edm.Boolean":return s==="true";case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.SByte":return e(parseInt(s));case"Edm.Date":case"Edm.DateTimeOffset":case"Edm.Decimal":case"Edm.Guid":case"Edm.Int64":case"Edm.TimeOfDay":return s;case"Edm.Double":case"Edm.Single":return s==="INF"||s==="-INF"||s==="NaN"?s:e(parseFloat(s));default:throw new Error(p+": Unsupported type: "+t);}},publicClone:function(v){var C=_.clone(v);if(C){delete C["@$ui5._"];}return C;},removeByPath:function(m,p,i){var I=m[p],e;if(I){e=I.indexOf(i);if(e>=0){if(I.length===1){delete m[p];}else{I.splice(e,1);}}}},resolveIfMatchHeader:function(H){var i=H&&H["If-Match"];if(i&&typeof i==="object"){i=i["@odata.etag"];H=Object.assign({},H);if(i===undefined){delete H["If-Match"];}else{H["If-Match"]=i;}}return H;},setPrivateAnnotation:function(o,A,v){var p=o["@$ui5._"];if(!p){p=o["@$ui5._"]={};}p[A]=v;},stripPathPrefix:function(p,P){var s=p+"/";return P.filter(function(e){return e===p||e.startsWith(s);}).map(function(e){return e.slice(s.length);});},toArray:function(e){if(e===undefined||e===null){return[];}if(Array.isArray(e)){return e;}return[e];},updateExisting:function(C,p,o,n){if(!n){return;}Object.keys(o).forEach(function(P){var s=_.buildPath(p,P),O=o[P],N;if(P in n){N=n[P];if(N&&typeof N==="object"){if(Array.isArray(N)){o[P]=N;}else if(O){_.updateExisting(C,s,O,N);}else{o[P]=N;_.fireChanges(C,s,N,false);}}else if(O&&typeof O==="object"){o[P]=N;_.fireChanges(C,s,O,true);}else{o[P]=N;if(O!==N){_.fireChange(C,s,N);}}}});},updateSelected:function(C,p,o,n,s){function e(p,P,o,n){var S=P.split("/");S.every(function(m,I){if(n[m]===null){o[m]=null;if(I<S.length-1){return false;}_.fireChange(C,_.buildPath(p,P),o[m]);}else if(typeof n[m]==="object"){o[m]=o[m]||{};}else{if(o[m]!==n[m]){o[m]=n[m];_.fireChange(C,_.buildPath(p,P),o[m]);}return false;}o=o[m];n=n[m];return true;});}function i(O,m){Object.keys(O).forEach(function(P){var q=_.buildPath(m,P),v=O[P];if(v!==null&&typeof v==="object"){i(v,q);}else{s.push(q);}});}if(!s||s.indexOf("*")>=0){s=[];i(n);}else{s=s.concat("@odata.etag","@$ui5._/predicate");}s.forEach(function(P){e(p,P,o,n);});},updateTransientPaths:function(m,p,P){var s,e=_.buildPath(p,"-1");for(s in m){if(s.startsWith(e)){m[p+P+s.slice(e.length)]=m[s];delete m[s];}}}};return _;},false);
