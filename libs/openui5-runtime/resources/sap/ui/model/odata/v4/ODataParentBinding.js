/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/model/ChangeReason","./ODataBinding","./lib/_Helper","./lib/_SyncPromise"],function(C,a,_,b){"use strict";function O(){}a(O.prototype);var c="sap.ui.model.odata.v4.ODataParentBinding";O.prototype.addToSelect=function(q,s){q.$select=q.$select||[];s.forEach(function(p){if(q.$select.indexOf(p)<0){q.$select.push(p);}});};O.prototype.changeParameters=function(p){var B=jQuery.extend(true,{},this.mParameters),d=false,k,t=this;function e(n){if(t.oModel.bAutoExpandSelect&&n in p){throw new Error("Cannot change $expand or $select parameter in "+"auto-$expand/$select mode: "+n+"="+JSON.stringify(p[n]));}}if(!p){throw new Error("Missing map of binding parameters");}e("$expand");e("$select");if(this.hasPendingChanges()){throw new Error("Cannot change parameters due to pending changes");}for(k in p){if(k.indexOf("$$")===0){throw new Error("Unsupported parameter: "+k);}if(p[k]===undefined&&B[k]!==undefined){delete B[k];d=true;}else if(B[k]!==p[k]){if(typeof p[k]==="object"){B[k]=jQuery.extend(true,{},p[k]);}else{B[k]=p[k];}d=true;}}if(d){this.applyParameters(B,C.Change);}};O.prototype.checkUpdate=function(){var t=this;function u(){t.oModel.getDependentBindings(t,true).forEach(function(d){d.checkUpdate();});}if(arguments.length>0){throw new Error("Unsupported operation: "+c+"#checkUpdate must not be"+" called with parameters");}this.oCachePromise.then(function(o){if(o&&t.bRelative&&t.oContext.fetchCanonicalPath){t.oContext.fetchCanonicalPath().then(function(s){if(o.$canonicalPath!==s){t.refreshInternal();}else{u();}})["catch"](function(e){t.oModel.reportError("Failed to update "+t,c,e);});}else{u();}});};O.prototype.createInCache=function(u,v,p,i,f){var t=this;return this.oCachePromise.then(function(o){if(o){return o.create(u,v,p,i,f,function(e){t.oModel.reportError("POST on '"+v+"' failed; will be repeated automatically","sap.ui.model.odata.v4.ODataParentBinding",e);});}return t.oContext.getBinding().createInCache(u,v,_.buildPath(t.oContext.iIndex,t.sPath,p),i,f);});};O.prototype.wrapChildQueryOptions=function(B,s,m){var e="",i,M=s.split("/"),p,P=B,q={},Q=q;if(s===""){return m;}for(i=0;i<M.length;i+=1){P=_.buildPath(P,M[i]);e=_.buildPath(e,M[i]);p=this.oModel.oMetaModel.getObject(P);if(p.$kind==="NavigationProperty"){Q.$expand={};Q=Q.$expand[e]=(i===M.length-1)?m:{};this.selectKeyProperties(Q,P);e="";}else if(p.$kind!=="Property"){return undefined;}}if(p.$kind==="Property"){if(Object.keys(m).length>0){jQuery.sap.log.error("Failed to enhance query options for "+"auto-$expand/$select as the child binding has query options, "+"but its path '"+s+"' points to a structural "+"property",JSON.stringify(m),"sap.ui.model.odata.v4.ODataParentBinding");return undefined;}this.addToSelect(Q,[e]);}if("$apply"in m){jQuery.sap.log.debug("Cannot wrap $apply into $expand: "+s,JSON.stringify(m),"sap.ui.model.odata.v4.ODataParentBinding");return undefined;}return q;};O.prototype.deleteFromCache=function(g,e,p,f){var o=this.oCachePromise.getResult();if(this.oOperation){throw new Error("Cannot delete a deferred operation");}if(!this.oCachePromise.isFulfilled()){throw new Error("DELETE request not allowed");}if(o){g=g||this.getUpdateGroupId();if(g!=="$auto"&&g!=="$direct"){throw new Error("Illegal update group ID: "+g);}return o._delete(g,e,p,f);}return this.oContext.getBinding().deleteFromCache(g,e,_.buildPath(this.oContext.iIndex,this.sPath,p),f);};O.prototype.fetchIfChildCanUseCache=function(o,s,d){var B,e,f,m=this.oModel.oMetaModel,p,t=this;function g(){var F=_.buildPath(B,f);return m.fetchObject(F).then(function(P){if(P&&P.$kind==="NavigationProperty"){return m.fetchObject(F+"/").then(function(){return P;});}return P;});}if(this.oOperation||s==="$count"||s.slice(-7)==="/$count"){return b.resolve(true);}B=m.getMetaPath(o.getPath());f=m.getMetaPath("/"+s).slice(1);p=[this.doFetchQueryOptions(this.oContext),g(),d];e=b.all(p).then(function(r){var h=r[2],w,l=r[0],P=r[1];if(!t.oOperation){t.selectKeyProperties(l,B);}if(Object.keys(t.mAggregatedQueryOptions).length===0){t.mAggregatedQueryOptions=jQuery.extend(true,{},l);}if(f===""||P&&(P.$kind==="Property"||P.$kind==="NavigationProperty")){w=t.wrapChildQueryOptions(B,f,h);if(w){return t.aggregateQueryOptions(w);}return false;}jQuery.sap.log.error("Failed to enhance query options for "+"auto-$expand/$select as the child binding's path '"+s+"' does not point to a property",JSON.stringify(P),"sap.ui.model.odata.v4.ODataParentBinding");return false;});t.aChildCanUseCachePromises.push(e);return e;};O.prototype.getQueryOptionsForPath=function(p,o){var q;if(Object.keys(this.mParameters).length){q=this.mQueryOptions;this.oModel.oMetaModel.getMetaPath("/"+p).slice(1).split("/").some(function(s){q=q.$expand&&q.$expand[s];if(!q||q===true){q={};return true;}});return jQuery.extend(true,{},q);}o=o||this.oContext;if(!this.bRelative||!o.getQueryOptionsForPath){return{};}return o.getQueryOptionsForPath(_.buildPath(this.sPath,p));};O.prototype.initialize=function(){if(!this.bRelative||this.oContext){this._fireChange({reason:C.Change});}};O.prototype.aggregateQueryOptions=function(q){var A=jQuery.extend(true,{},this.mAggregatedQueryOptions),i=!(this.oCachePromise&&this.oCachePromise.isPending());function m(d,q,I){var e,s;function f(E){if(d.$expand[E]){return m(d.$expand[E],q.$expand[E],true);}if(i){return false;}d.$expand[E]=e[E];return true;}function g(S){if(d.$select.indexOf(S)<0){if(i){return false;}d.$select.push(S);}return true;}e=q&&q.$expand;if(e){d.$expand=d.$expand||{};if(!Object.keys(e).every(f)){return false;}}s=q&&q.$select;if(s){d.$select=d.$select||[];if(!s.every(g)){return false;}}if(q&&q.$count){d.$count=true;}return Object.keys(q).concat(Object.keys(d)).every(function(n){if(n==="$count"||n==="$expand"||n==="$select"||!I&&!(n in q)){return true;}return q[n]===d[n];});}if(m(A,q)){this.mAggregatedQueryOptions=A;return true;}return false;};O.prototype.selectKeyProperties=function(q,m){var t=this.oModel.oMetaModel.getObject(m+"/");if(t.$Key){this.addToSelect(q,t.$Key);}};O.prototype.updateAggregatedQueryOptions=function(n){var A=Object.keys(n).concat(Object.keys(this.mAggregatedQueryOptions)),t=this;A.forEach(function(N){if(N==="$select"||N==="$expand"){return;}if(n[N]===undefined){delete t.mAggregatedQueryOptions[N];}else{t.mAggregatedQueryOptions[N]=n[N];}});};O.prototype.updateValue=function(g,p,v,e,E,s){var o,r;if(!this.oCachePromise.isFulfilled()){throw new Error("PATCH request not allowed");}o=this.oCachePromise.getResult();if(o){g=g||this.getUpdateGroupId();r=this.oModel.resolve(this.sPath,this.oContext);return o.update(g,p,v,e,E,s.slice(r.length+1));}return this.oContext.getBinding().updateValue(g,p,v,e,E,s);};return function(p){jQuery.extend(p,O.prototype);};},false);
