/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ODataBinding","./lib/_Helper","sap/base/Log","sap/ui/base/SyncPromise","sap/ui/model/ChangeReason","sap/ui/thirdparty/jquery"],function(a,_,L,S,C,q){"use strict";function O(){a.call(this);this.mAggregatedQueryOptions={};this.bAggregatedQueryOptionsInitial=true;this.aChildCanUseCachePromises=[];this.iPatchCounter=0;this.bPatchSuccess=true;}a(O.prototype);var c="sap.ui.model.odata.v4.ODataParentBinding";O.prototype.attachPatchCompleted=function(f,l){this.attachEvent("patchCompleted",f,l);};O.prototype.detachPatchCompleted=function(f,l){this.detachEvent("patchCompleted",f,l);};O.prototype.firePatchCompleted=function(s){if(this.iPatchCounter===0){throw new Error("Completed more PATCH requests than sent");}this.iPatchCounter-=1;this.bPatchSuccess=this.bPatchSuccess&&s;if(this.iPatchCounter===0){this.fireEvent("patchCompleted",{success:this.bPatchSuccess});this.bPatchSuccess=true;}};O.prototype.attachPatchSent=function(f,l){this.attachEvent("patchSent",f,l);};O.prototype.detachPatchSent=function(f,l){this.detachEvent("patchSent",f,l);};O.prototype.firePatchSent=function(){this.iPatchCounter+=1;if(this.iPatchCounter===1){this.fireEvent("patchSent");}};O.prototype.addToSelect=function(Q,s){Q.$select=Q.$select||[];s.forEach(function(p){if(Q.$select.indexOf(p)<0){Q.$select.push(p);}});};O.prototype.aggregateQueryOptions=function(Q,d){var A=q.extend(true,{},this.mAggregatedQueryOptions);function m(e,Q,i){var E,s;function f(h){if(e.$expand[h]){return m(e.$expand[h],Q.$expand[h],true);}if(d){return false;}e.$expand[h]=E[h];return true;}function g(h){if(e.$select.indexOf(h)<0){if(d){return false;}e.$select.push(h);}return true;}E=Q.$expand;if(E){e.$expand=e.$expand||{};if(!Object.keys(E).every(f)){return false;}}s=Q.$select;if(s){e.$select=e.$select||[];if(!s.every(g)){return false;}}if(Q.$count){e.$count=true;}return Object.keys(Q).concat(Object.keys(e)).every(function(n){if(n==="$count"||n==="$expand"||n==="$select"||!i&&!(n in Q)){return true;}return Q[n]===e[n];});}if(m(A,Q)){this.mAggregatedQueryOptions=A;return true;}return false;};O.prototype.changeParameters=function(p){var B=q.extend(true,{},this.mParameters),s,k,t=this;function d(n){if(t.oModel.bAutoExpandSelect&&n in p){throw new Error("Cannot change $expand or $select parameter in "+"auto-$expand/$select mode: "+n+"="+JSON.stringify(p[n]));}}function u(n){if(n==="$filter"||n==="$search"){s=C.Filter;}else if(n==="$orderby"&&s!==C.Filter){s=C.Sort;}else if(!s){s=C.Change;}}this.checkSuspended();if(!p){throw new Error("Missing map of binding parameters");}d("$expand");d("$select");if(this.hasPendingChanges()){throw new Error("Cannot change parameters due to pending changes");}for(k in p){if(k.indexOf("$$")===0){throw new Error("Unsupported parameter: "+k);}if(p[k]===undefined&&B[k]!==undefined){u(k);delete B[k];}else if(B[k]!==p[k]){u(k);if(typeof p[k]==="object"){B[k]=q.extend(true,{},p[k]);}else{B[k]=p[k];}}}if(s){this.applyParameters(B,s);}};O.prototype.checkUpdate=function(){var t=this;function u(){return S.all(t.getDependentBindings().map(function(d){return d.checkUpdate();}));}if(arguments.length>0){throw new Error("Unsupported operation: "+c+"#checkUpdate must not be"+" called with parameters");}return this.oCachePromise.then(function(o){if(o&&t.bRelative){return t.fetchResourcePath(t.oContext).then(function(r){if(o.$resourcePath===r){return u();}return t.refreshInternal();}).catch(function(e){t.oModel.reportError("Failed to update "+t,c,e);});}return u();});};O.prototype.createInCache=function(u,v,p,i,f){var t=this;return this.oCachePromise.then(function(o){if(o){return o.create(u,v,p,i,f,function(e){t.oModel.reportError("POST on '"+v+"' failed; will be repeated automatically","sap.ui.model.odata.v4.ODataParentBinding",e);}).then(function(d){if(o.$resourcePath){delete t.mCacheByResourcePath[o.$resourcePath];}return d;});}return t.oContext.getBinding().createInCache(u,v,_.buildPath(t.oContext.iIndex,t.sPath,p),i,f);});};O.prototype.createReadGroupLock=function(g,l,i){var G,t=this;function d(){sap.ui.getCore().addPrerenderingTask(function(){i-=1;if(i>0){Promise.resolve().then(d);}else if(t.oReadGroupLock===G){L.debug("Timeout: unlocked "+G,null,c);G.unlock(true);t.oReadGroupLock=undefined;}});}this.removeReadGroupLock();this.oReadGroupLock=G=this.lockGroup(g,l);if(l){i=2+(i||0);d();}};O.prototype.destroy=function(){this.aChildCanUseCachePromises=[];};O.prototype.deleteFromCache=function(g,e,p,f){var o=this.oCachePromise.getResult(),G;if(!this.oCachePromise.isFulfilled()){throw new Error("DELETE request not allowed");}if(o){g.setGroupId(this.getUpdateGroupId());G=g.getGroupId();if(!this.oModel.isAutoGroup(G)&&!this.oModel.isDirectGroup(G)){throw new Error("Illegal update group ID: "+G);}return o._delete(g,e,p,f);}return this.oContext.getBinding().deleteFromCache(g,e,_.buildPath(this.oContext.iIndex,this.sPath,p),f);};O.prototype.fetchIfChildCanUseCache=function(o,s,d){var B,e,f,g,F,i,m=this.oModel.getMetaModel(),p,t=this;function h(){if(i){return m.fetchObject(F.slice(0,F.lastIndexOf("/")+1));}return m.fetchObject(F).then(function(P){if(P&&P.$kind==="NavigationProperty"){return m.fetchObject(F+"/").then(function(){return P;});}return P;});}if(this.oOperation||s==="$count"||s.slice(-7)==="/$count"||s[0]==="@"||this.getRootBinding().isSuspended()){return S.resolve(true);}e=this.oCachePromise.isRejected()||this.oCachePromise.isFulfilled()&&!this.oCachePromise.getResult()||this.oCachePromise.isFulfilled()&&this.oCachePromise.getResult().bSentReadRequest;B=m.getMetaPath(o.getPath());g=m.getMetaPath("/"+s).slice(1);i=g[0]==="#";F=_.buildPath(B,g);p=[this.doFetchQueryOptions(this.oContext),h(),d];f=S.all(p).then(function(r){var j=r[2],w,l=r[0],P=r[1];if(t.bAggregatedQueryOptionsInitial){t.selectKeyProperties(l,B);t.mAggregatedQueryOptions=q.extend(true,{},l);t.bAggregatedQueryOptionsInitial=false;}if(i){w={"$select":[g.slice(1)]};return t.aggregateQueryOptions(w,e);}if(g===""||P&&(P.$kind==="Property"||P.$kind==="NavigationProperty")){w=t.wrapChildQueryOptions(B,g,j);if(w){return t.aggregateQueryOptions(w,e);}return false;}if(g==="value"){return t.aggregateQueryOptions(j,e);}L.error("Failed to enhance query options for auto-$expand/$select as the path '"+F+"' does not point to a property",JSON.stringify(P),"sap.ui.model.odata.v4.ODataParentBinding");return false;});this.aChildCanUseCachePromises.push(f);this.oCachePromise=S.all([this.oCachePromise,f]).then(function(r){var j=r[0];if(j&&!j.bSentReadRequest){j.setQueryOptions(q.extend(true,{},t.oModel.mUriParameters,t.mAggregatedQueryOptions));}return j;}).catch(function(E){t.oModel.reportError("Failed to update cache for binding "+t,c,E);});return f;};O.prototype.getQueryOptionsForPath=function(p,o){var Q;if(Object.keys(this.mParameters).length){Q=this.mQueryOptions;this.oModel.getMetaModel().getMetaPath("/"+p).slice(1).split("/").some(function(s){Q=Q.$expand&&Q.$expand[s];if(!Q||Q===true){Q={};return true;}});return q.extend(true,{},Q);}o=o||this.oContext;if(!this.bRelative||!o.getQueryOptionsForPath){return{};}return o.getQueryOptionsForPath(_.buildPath(this.sPath,p));};O.prototype.initialize=function(){if((!this.bRelative||this.oContext)&&!this.getRootBinding().isSuspended()){this._fireChange({reason:C.Change});}};O.prototype.isPatchWithoutSideEffects=function(){return!!this.mParameters.$$patchWithoutSideEffects;};O.prototype.refreshDependentBindings=function(g,d){return S.all(this.getDependentBindings().map(function(D){return D.refreshInternal(g,d);}));};O.prototype.removeReadGroupLock=function(){if(this.oReadGroupLock){this.oReadGroupLock.unlock(true);this.oReadGroupLock=undefined;}};O.prototype.resume=function(){var t=this;if(this.oOperation){throw new Error("Cannot resume an operation binding: "+this);}if(this.bRelative&&(!this.oContext||this.oContext.fetchValue)){throw new Error("Cannot resume a relative binding: "+this);}if(!this.bSuspended){throw new Error("Cannot resume a not suspended binding: "+this);}this.bSuspended=false;this.createReadGroupLock(this.getGroupId(),true,1);sap.ui.getCore().addPrerenderingTask(function(){t.resumeInternal(true);});};O.prototype.selectKeyProperties=function(Q,m){var t=this.oModel.getMetaModel().getObject(m+"/");if(t&&t.$Key){this.addToSelect(Q,t.$Key.map(function(k){if(typeof k==="object"){return k[Object.keys(k)[0]];}return k;}));}};O.prototype.suspend=function(){if(this.oOperation){throw new Error("Cannot suspend an operation binding: "+this);}if(this.bRelative&&(!this.oContext||this.oContext.fetchValue)){throw new Error("Cannot suspend a relative binding: "+this);}if(this.bSuspended){throw new Error("Cannot suspend a suspended binding: "+this);}if(this.hasPendingChanges()){throw new Error("Cannot suspend a binding with pending changes: "+this);}this.bSuspended=true;if(this.oReadGroupLock){this.oReadGroupLock.unlock(true);this.oReadGroupLock=undefined;}};O.prototype.updateAggregatedQueryOptions=function(n){var A=Object.keys(n),t=this;if(this.mAggregatedQueryOptions){A=A.concat(Object.keys(this.mAggregatedQueryOptions));A.forEach(function(N){if(N==="$select"||N==="$expand"){return;}if(n[N]===undefined){delete t.mAggregatedQueryOptions[N];}else{t.mAggregatedQueryOptions[N]=n[N];}});}};O.prototype.wrapChildQueryOptions=function(B,s,m){var e="",i,M=s.split("/"),p,P=B,Q={},d=Q;if(s===""){return m;}for(i=0;i<M.length;i+=1){P=_.buildPath(P,M[i]);e=_.buildPath(e,M[i]);p=this.oModel.getMetaModel().getObject(P);if(p.$kind==="NavigationProperty"){d.$expand={};d=d.$expand[e]=(i===M.length-1)?m:{};this.selectKeyProperties(d,P);e="";}else if(p.$kind!=="Property"){return undefined;}}if(p.$kind==="Property"){if(Object.keys(m).length>0){L.error("Failed to enhance query options for "+"auto-$expand/$select as the child binding has query options, "+"but its path '"+s+"' points to a structural "+"property",JSON.stringify(m),"sap.ui.model.odata.v4.ODataParentBinding");return undefined;}this.addToSelect(d,[e]);}if("$apply"in m){L.debug("Cannot wrap $apply into $expand: "+s,JSON.stringify(m),"sap.ui.model.odata.v4.ODataParentBinding");return undefined;}return Q;};function b(p){if(this){O.apply(this,arguments);}else{q.extend(p,O.prototype);}}b.prototype.destroy=O.prototype.destroy;return b;},false);
