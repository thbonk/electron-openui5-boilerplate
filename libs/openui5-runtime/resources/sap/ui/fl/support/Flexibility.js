/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/support/Plugin","sap/ui/core/support/Support","sap/ui/model/json/JSONModel","sap/ui/fl/Utils"],function(q,P,S,J,U){"use strict";var F=P.extend("sap.ui.fl.support.Flexibility",{constructor:function(s){P.apply(this,["sapUiSupportFlexibility","Flexibility",s]);this._oStub=s;if(this.runsAsToolPlugin()){this._aEventIds=[this.getId()+"SetChanges"];}else{this._aEventIds=[this.getId()+"GetChanges"];}}});F.prototype.init=function(s){P.prototype.init.apply(this,arguments);if(s.isToolStub()){this.addStylesheet("sap/ui/fl/support/flexibility");this.oModel=new J();this._renderToolPlugin();}else{this.onsapUiSupportFlexibilityGetChanges();}};F.prototype._renderToolPlugin=function(){var t=this;var _=function(){var r=sap.ui.getCore().createRenderManager();r.write("<div class='sapUiSupportToolbar'>");r.write("<a href='#' id='"+t.getId()+"-Refresh' class='sapUiSupportLink'>Refresh</a>");t.$().on("click",'#'+t.getId()+"-Refresh",q.proxy(t._onRefreshChanges,t));r.write("</div>");r.write("<div id='"+t.getId()+"-FlexCacheArea' class='sapUiSizeCompact' />");r.flush(t.$().get(0));r.destroy();};var a=function(){t.oView=sap.ui.view({viewName:"sap.ui.fl.support.Flexibility",type:sap.ui.core.mvc.ViewType.XML});t.oView.placeAt(t.getId()+"-FlexCacheArea");t.oView.setModel(t.oModel,"flex");};_();a();this._onRefreshChanges();};F.prototype._onRefreshChanges=function(){S.getStub().sendEvent(this.getId()+"GetChanges",{});};F.prototype.onsapUiSupportFlexibilityGetChanges=function(){var t=this;if(sap.ui.fl&&sap.ui.fl.Cache){var c=sap.ui.fl.Cache.getEntries();var r=[];var p=[];var C;var a;C=Object.keys(c);C.sort();C.forEach(function(f){a=Object.keys(c[f]);a.sort(function(A,s){var n=function(d){if(d===U.DEFAULT_APP_VERSION){return"000000000";}var e=d.split(".");var g="";e.forEach(function(h){g+=("000"+h).substring(h.length);});return g;};var N=n(A);var b=n(s);if(N<b){return-1;}if(N>b){return 1;}return 0;});a.forEach(function(A){var e=c[f][A];if(A===U.DEFAULT_APP_VERSION){A="Version independent";}var b=e.file.changes.changes.slice(0);var d=e.file.changes.contexts.slice(0);if(d.length>0){var o=sap.ui.fl.context.ContextManager.getActiveContexts(d).then(function(g){d.forEach(function(h){h.isActive=g.indexOf(h.id)!==-1;});b.forEach(function(h){h.isActive=!h.context||g.indexOf(h.context)!==-1;});});r.push({reference:f+" - "+A,changes:b,contexts:d});p.push(o);}else{b.forEach(function(g){g.isActive=!g.context;});r.push({reference:f+" - "+A,changes:b,contexts:d});}});});Promise.all(p).then(function(){t._oStub.sendEvent(t.getId()+"SetChanges",r);});}else{t._oStub.sendEvent(t.getId()+"SetChanges",{});}};F.prototype.onsapUiSupportFlexibilitySetChanges=function(e){var c=e.getParameters();this.oModel.setData(c);};F.prototype.exit=function(s){P.prototype.exit.apply(this,arguments);};return F;});
