/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['./PlanningCalendarHeader','./SegmentedButtonItem',"./SinglePlanningCalendarWeekView",'./SinglePlanningCalendarGrid','./SinglePlanningCalendarRenderer','sap/base/Log','sap/ui/core/Control','sap/ui/core/Locale','sap/ui/core/LocaleData','sap/ui/core/InvisibleText','sap/ui/core/date/UniversalDate','sap/ui/core/format/DateFormat','sap/ui/unified/calendar/CalendarDate','sap/ui/unified/calendar/CalendarUtils','sap/ui/unified/DateRange'],function(P,S,a,b,c,L,C,d,e,I,U,D,f,g,h){"use strict";var j=C.extend("sap.m.SinglePlanningCalendar",{metadata:{library:"sap.m",properties:{title:{type:"string",group:"Appearance",defaultValue:""},startDate:{type:"object",group:"Data"}},aggregations:{actions:{type:"sap.ui.core.Control",multiple:true,singularName:"action",forwarding:{getter:"_getHeader",aggregation:"actions"}},appointments:{type:"sap.m.CalendarAppointment",multiple:true,singularName:"appointment",forwarding:{getter:"_getGrid",aggregation:"appointments"}},views:{type:"sap.m.SinglePlanningCalendarView",multiple:true,singularName:"view"},_header:{type:"sap.m.PlanningCalendarHeader",multiple:false,visibility:"hidden"},_grid:{type:"sap.m.SinglePlanningCalendarGrid",multiple:false,visibility:"hidden"}},associations:{selectedView:{type:"sap.m.SinglePlanningCalendarView",multiple:false}},events:{appointmentSelect:{parameters:{appointment:{type:"sap.m.CalendarAppointment"}}},headerDateSelect:{parameters:{date:{type:"object"}}},startDateChange:{parameters:{date:{type:"object"}}}}}});j.prototype.init=function(){var o=this.getId();this._oRB=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._oDefaultView=new a({key:"DEFAULT_INNER_WEEK_VIEW_CREATED_FROM_CONTROL",title:""});this.setAssociation("selectedView",this._oDefaultView);this.setAggregation("_header",this._createHeader());this.setAggregation("_grid",new b(o+"-Grid"));this._attachHeaderEvents();this._attachGridEvents();this.setStartDate(new Date());};j.prototype.exit=function(){if(this._oDefaultView){this._oDefaultView.destroy();this._oDefaultView=null;}};j.prototype.setTitle=function(t){this._getHeader().setTitle(t);return this.setProperty("title",t,true);};j.prototype.setStartDate=function(o){this.setProperty("startDate",o,true);this._alignColumns();return this;};j.prototype.addView=function(v){var V;if(!v){return this;}if(this._isViewKeyExisting(v.getKey())){L.error("There is an existing view with the same key.",this);return;}this.addAggregation("views",v);V=this._getHeader()._getOrCreateViewSwitch();V.addItem(new S({key:v.getKey(),text:v.getTitle()}));if(this._getSelectedView().getKey()===this._oDefaultView.getKey()){this.setAssociation("selectedView",v);}this._alignView();return this;};j.prototype.insertView=function(v,p){var V;if(!v){return this;}if(this._isViewKeyExisting(v.getKey())){L.error("There is an existing view with the same key.",this);return;}this.insertAggregation("views",v,p);V=this._getHeader()._getOrCreateViewSwitch();V.insertItem(new S({key:v.getKey(),text:v.getTitle()}),p);if(this._getSelectedView().getKey()===this._oDefaultView.getKey()){this.setAssociation("selectedView",v);}this._alignView();return this;};j.prototype.removeView=function(v){if(!v){return this;}var V=this._getHeader()._getOrCreateViewSwitch(),o=V.getItems(),k=this._getSelectedView(),l=v.getKey(),m,i;for(i=0;i<o.length;i++){m=o[i];if(m.getKey()===l){V.removeItem(m);break;}}this.removeAggregation("views",v);if(l===k.getKey()){this.setAssociation("selectedView",this.getViews()[0]||this._oDefaultView);}this._alignView();return this;};j.prototype.removeAllViews=function(){var v=this._getHeader()._getOrCreateViewSwitch();v.removeAllItems();this.setAssociation("selectedView",this._oDefaultView);this._alignView();return this.removeAllAggregation("views");};j.prototype.destroyViews=function(){var v=this._getHeader()._getOrCreateViewSwitch();v.destroyItems();this.setAssociation("selectedView",this._oDefaultView);this._alignView();return this.destroyAggregation("views");};j.prototype._alignView=function(){this._switchViewButtonVisibility();this._alignColumns();return this;};j.prototype._createHeader=function(){var H=new P(this.getId()+"-Header");H.getAggregation("_actionsToolbar").addAriaLabelledBy(I.getStaticId("sap.m","SPC_ACTIONS_TOOLBAR"));H.getAggregation("_navigationToolbar").addAriaLabelledBy(I.getStaticId("sap.m","SPC_NAVIGATION_TOOLBAR"));return H;};j.prototype._isViewKeyExisting=function(k){return this.getViews().some(function(v){return v.getKey()===k;});};j.prototype._getSelectedView=function(){var s,v=this.getViews(),k=sap.ui.getCore().byId(this.getAssociation("selectedView")).getKey();for(var i=0;i<v.length;i++){if(k===v[i].getKey()){s=v[i];break;}}return s||this._oDefaultView;};j.prototype._switchViewButtonVisibility=function(){var s=this._getHeader()._getOrCreateViewSwitch(),v=s.getItems().length>1;s.setProperty("visible",v);return this;};j.prototype._attachHeaderEvents=function(){var H=this._getHeader();H.attachEvent("pressPrevious",this._handlePressArrow,this);H.attachEvent("pressToday",this._handlePressToday,this);H.attachEvent("pressNext",this._handlePressArrow,this);H.attachEvent("dateSelect",this._handleCalendarPickerDateSelect,this);H._getOrCreateViewSwitch().attachEvent("selectionChange",this._handleViewSwitchChange,this);return this;};j.prototype._attachGridEvents=function(){var G=this._getGrid();G._getColumnHeaders().attachEvent("select",function(E){this.fireHeaderDateSelect({date:E.getSource().getDate()});},this);G.attachEvent("appointmentSelect",function(E){this.fireAppointmentSelect({appointment:E.getParameter("appointment")});},this);return this;};j.prototype._handlePressArrow=function(E){this._applyArrowsLogic(E.getId()==="pressPrevious");};j.prototype._handlePressToday=function(){var s=this._getSelectedView().calculateStartDate(new Date());this.setStartDate(s);this.fireStartDateChange({date:s});};j.prototype._handleViewSwitchChange=function(E){this.setAssociation("selectedView",E.getParameter("item"));this._alignColumns();};j.prototype._handleCalendarPickerDateSelect=function(){var s=this._getHeader().getStartDate();s=this._getSelectedView().calculateStartDate(new Date(s.getTime()));this.setStartDate(s);this.fireStartDateChange({date:s});};j.prototype._updateCalendarPickerSelection=function(){var r=this._getFirstAndLastRangeDate(),s;s=new h({startDate:r.oStartDate.toLocalJSDate(),endDate:r.oEndDate.toLocalJSDate()});this._getHeader().getAggregation("_calendarPicker").removeAllSelectedDates();this._getHeader().getAggregation("_calendarPicker").addSelectedDate(s);};j.prototype._formatPickerText=function(){var r=this._getFirstAndLastRangeDate(),s=r.oStartDate.toLocalJSDate(),E=r.oEndDate.toLocalJSDate(),l=D.getDateInstance({style:"long"}),R=l.format(s);if(s.getTime()!==E.getTime()){R+=" - "+l.format(E);}return R;};j.prototype._applyArrowsLogic=function(B){var o=f.fromLocalJSDate(this.getStartDate()||new Date()),n=this._getSelectedView().getScrollEntityCount(),s;if(B){n*=-1;}o.setDate(o.getDate()+n);s=o.toLocalJSDate();this.setStartDate(s);this.fireStartDateChange({date:s});};j.prototype._getFirstAndLastRangeDate=function(){var s=this._getSelectedView(),o=this._getHeader().getStartDate()||new Date(),i=s.getEntityCount()-1,k,l;k=f.fromLocalJSDate(s.calculateStartDate(new Date(o.getTime())));l=new f(k);l.setDate(k.getDate()+i);return{oStartDate:k,oEndDate:l};};j.prototype._alignColumns=function(){var H=this._getHeader(),G=this._getGrid(),v=this._getSelectedView(),o=this.getStartDate()||new Date(),V=v.calculateStartDate(new Date(o.getTime())),i=f.fromLocalJSDate(V);H.setStartDate(V);H.setPickerText(this._formatPickerText(i));this._updateCalendarPickerSelection();G.setStartDate(V);G._setColumns(v.getEntityCount());this._setColumnHeaderVisibility();};j.prototype._setColumnHeaderVisibility=function(){var v=!this._getSelectedView().isA("sap.m.SinglePlanningCalendarDayView");this._getGrid()._getColumnHeaders().setVisible(v);};j.prototype._getHeader=function(){return this.getAggregation("_header");};j.prototype._getGrid=function(){return this.getAggregation("_grid");};return j;});
