/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2018 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['./SinglePlanningCalendarUtilities','sap/ui/core/Control','sap/ui/core/LocaleData','sap/ui/core/Locale','sap/ui/core/InvisibleText','sap/ui/core/format/DateFormat','sap/ui/core/date/UniversalDate','sap/ui/unified/library','sap/ui/unified/calendar/DatesRow','sap/ui/unified/calendar/CalendarDate','sap/ui/unified/calendar/CalendarUtils','sap/ui/events/KeyCodes','./SinglePlanningCalendarGridRenderer'],function(S,C,L,a,I,D,U,u,b,c,d,K,e){"use strict";var R=48,B=25,H=3600000/2,O=60*1000;var f=C.extend("sap.m.SinglePlanningCalendarGrid",{metadata:{library:"sap.m",properties:{startDate:{type:"object",group:"Data"}},aggregations:{appointments:{type:"sap.m.CalendarAppointment",multiple:true,singularName:"appointment"},_columnHeaders:{type:"sap.ui.unified.calendar.DatesRow",multiple:false,visibility:"hidden"}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{appointmentSelect:{parameters:{appointment:{type:"sap.m.CalendarAppointment"}}}}}});f.prototype.init=function(){var s=new Date(),o=new b(this.getId()+"-columnHeaders",{showDayNamesLine:false,showWeekNumbers:false,startDate:s}).addStyleClass("sapMSinglePCColumnHeader"),i=(60-s.getSeconds())*1000;this.setAggregation("_columnHeaders",o);this.setStartDate(s);this._setColumns(7);this._oUnifiedRB=sap.ui.getCore().getLibraryResourceBundle("sap.ui.unified");this._oFormatAria=D.getDateTimeInstance({pattern:"EEEE dd/MM/YYYY 'at' HH:mm:ss a"});setTimeout(this._updateRowHeaderAndNowMarker.bind(this),i);};f.prototype.onBeforeRendering=function(){var A=this._createAppointmentsMap(this.getAppointments()),o=c.fromLocalJSDate(this.getStartDate()),i=this._getColumns();this._oVisibleAppointments=this._calculateVisibleAppointments(A.appointments,this.getStartDate(),i);this._oAppointmentsToRender=this._calculateAppointmentsLevelsAndWidth(this._oVisibleAppointments);this._aVisibleBlockers=this._calculateVisibleBlockers(A.blockers,o,i);this._oBlockersToRender=this._calculateBlockersLevelsAndWidth(this._aVisibleBlockers);};f.prototype.onkeydown=function(E){var A;if(E.which===K.SPACE||E.which===K.ENTER){A=sap.ui.getCore().byId(E.target.id);if(A&&A.isA("sap.m.CalendarAppointment")){this.fireAppointmentSelect({appointment:A});}E.preventDefault();}};f.prototype.setStartDate=function(s){this.getAggregation("_columnHeaders").setStartDate(s);return this.setProperty("startDate",s);};f.prototype.ontap=function(E){var A=sap.ui.getCore().byId(E.target.parentElement.id);if(A&&A.isA("sap.m.CalendarAppointment")){this.fireAppointmentSelect({appointment:A});}};f.prototype._getVisibleStartHour=function(){return 0;};f.prototype._getVisibleEndHour=function(){return 23;};f.prototype._isVisibleHour=function(){return true;};f.prototype._isOutsideVisibleHours=function(){return false;};f.prototype._shouldHideRowHeader=function(r){var i=new Date().getHours(),g=d._areCurrentMinutesLessThan(15)&&i===r,h=d._areCurrentMinutesMoreThan(45)&&i===r-1;return g||h;};f.prototype._formatDayAsString=function(o){var r=""+o.getYear(),m=o.getMonth(),s=o.getDate();if(m<10){r+="0";}r+=m;if(s<10){r+="0";}r+=s;return r;};f.prototype._formatTimeAsString=function(o){var p=this._getHoursPattern()+":mm",F=D.getDateTimeInstance({pattern:p},new a(this._getCoreLocaleId()));return F.format(o);};f.prototype._addAMPM=function(o){var A=this._getAMPMFormat();return" "+A.format(o);};f.prototype._calculateTopPosition=function(o){var h=o.getHours()-this._getVisibleStartHour(),m=o.getMinutes(),r=this._getRowHeight();return(r*h)+(r/60)*m;};f.prototype._calculateBottomPosition=function(o){var h=this._getVisibleEndHour()+1-o.getHours(),m=o.getMinutes(),r=this._getRowHeight();return(r*h)-(r/60)*m;};f.prototype._updateRowHeaderAndNowMarker=function(){var o=new Date();this._updateNowMarker(o);this._updateRowHeaders(o);setTimeout(this._updateRowHeaderAndNowMarker.bind(this),O);};f.prototype._updateNowMarker=function(o){var $=this.$("nowMarker"),g=this.$("nowMarkerText"),h=this.$("nowMarkerAMPM"),i=this._isOutsideVisibleHours(o.getHours());$.toggleClass("sapMSinglePCNowMarkerHidden",i);$.css("top",this._calculateTopPosition(o)+"px");g.text(this._formatTimeAsString(o));h.text(this._addAMPM(o));g.append(h);};f.prototype._updateRowHeaders=function(o){var $=this.$(),i=o.getHours(),n=i+1;$.find(".sapMSinglePCRowHeader").removeClass("sapMSinglePCRowHeaderHidden");if(this._shouldHideRowHeader(i)){$.find(".sapMSinglePCRowHeader"+i).addClass("sapMSinglePCRowHeaderHidden");}else if(this._shouldHideRowHeader(n)){$.find(".sapMSinglePCRowHeader"+n).addClass("sapMSinglePCRowHeaderHidden");}};f.prototype._createAppointmentsMap=function(A){var t=this;return A.reduce(function(m,o){var g=o.getStartDate(),h=o.getEndDate(),i=o.getFullDay(),j,k,s;if(!g||!h){return m;}if(!i){j=c.fromLocalJSDate(g);k=c.fromLocalJSDate(h);while(j.isSameOrBefore(k)){s=t._formatDayAsString(j);if(!m.appointments[s]){m.appointments[s]=[];}m.appointments[s].push(o);j.setDate(j.getDate()+1);}}else{m.blockers.push(o);}return m;},{appointments:{},blockers:[]});};f.prototype._calculateVisibleAppointments=function(A,s,g){var v={},o,h,j;for(var i=0;i<g;i++){o=new c(s.getFullYear(),s.getMonth(),s.getDate()+i);h=this._formatDayAsString(o);j=this._isAppointmentFitInVisibleHours(o);if(A[h]){v[h]=A[h].filter(j,this).sort(this._sortAppointmentsByStartHourCallBack);}}return v;};f.prototype._isAppointmentFitInVisibleHours=function(o){return function(A){var i=A.getStartDate().getTime(),g=A.getEndDate().getTime(),h=(new U(o.getYear(),o.getMonth(),o.getDate(),this._getVisibleStartHour())).getTime(),j=(new U(o.getYear(),o.getMonth(),o.getDate(),this._getVisibleEndHour(),59,59)).getTime();var k=i<h&&g>j,s=i>=h&&i<j,E=g>h&&g<=j;return k||s||E;};};f.prototype._calculateAppointmentsLevelsAndWidth=function(v){var t=this;return Object.keys(v).reduce(function(A,s){var m=0,o=new S.list(),g=v[s];g.forEach(function(h){var i=new S.node(h),j=h.getStartDate().getTime();if(o.getSize()===0){o.add(i);return;}o.getIterator().forEach(function(k){var l=true,n=k.getData(),p=n.getStartDate().getTime(),q=n.getEndDate().getTime(),r=q-p;if(r<H){q=q+(H-r);}if(j>=p&&j<q){i.level++;m=Math.max(m,i.level);}if(k.next&&k.next.level===i.level){l=false;}if(j>=q&&l){this.interrupt();}});o.insertAfterLevel(i.level,i);});A[s]={oAppointmentsList:t._calculateAppointmentsWidth(o),iMaxLevel:m};return A;},{});};f.prototype._calculateAppointmentsWidth=function(A){A.getIterator().forEach(function(o){var g=o.getData(),l=o.level,i=o.level,h=g.getStartDate().getTime(),j=g.getEndDate().getTime(),k=j-h;if(k<H){j=j+(H-k);}new S.iterator(A).forEach(function(m){var n=m.getData(),p=m.level,q=n.getStartDate().getTime(),r=n.getEndDate().getTime(),s=r-q;if(s<H){r=r+(H-s);}if(i>=p){return;}if(h>=q&&h<r||j>q&&j<r||h<=q&&j>=r){o.width=p-i;this.interrupt();return;}if(l<p){l=p;o.width++;}});});return A;};f.prototype._calculateVisibleBlockers=function(g,o,i){var h=new c(o.getYear(),o.getMonth(),o.getDate()+i),j=this._isBlockerVisible(o,h);return g.filter(j).sort(this._sortAppointmentsByStartHourCallBack);};f.prototype._isBlockerVisible=function(v,V){return function(A){var o=c.fromLocalJSDate(A.getStartDate()),g=c.fromLocalJSDate(A.getEndDate());var i=o.isBefore(v)&&g.isAfter(V),s=o.isSameOrAfter(v)&&o.isBefore(V),E=d._isBetween(g,v,V,true);return i||s||E;};};f.prototype._calculateBlockersLevelsAndWidth=function(v){var m=0,o=new S.list();v.forEach(function(g){var h=new S.node(g),i=c.fromLocalJSDate(g.getStartDate()),j=c.fromLocalJSDate(g.getEndDate());h.width=d._daysBetween(j,i);if(o.getSize()===0){o.add(h);return;}o.getIterator().forEach(function(k){var s=true,l=k.getData(),n=c.fromLocalJSDate(l.getStartDate()),p=c.fromLocalJSDate(l.getEndDate());if(i.isSameOrAfter(n)&&i.isBefore(p)){h.level++;m=Math.max(m,h.level);}if(k.next&&k.next.level===h.level){s=false;}if(i.isSameOrAfter(p)&&s){this.interrupt();}});o.insertAfterLevel(h.level,h);},this);return{oBlockersList:o,iMaxlevel:m};};f.prototype._sortAppointmentsByStartHourCallBack=function(A,o){return A.getStartDate().getTime()-o.getStartDate().getTime()||o.getEndDate().getTime()-A.getEndDate().getTime();};f.prototype._getVisibleAppointments=function(){return this._oVisibleAppointments;};f.prototype._getAppointmentsToRender=function(){return this._oAppointmentsToRender;};f.prototype._getVisibleBlockers=function(){return this._aVisibleBlockers;};f.prototype._getBlockersToRender=function(){return this._oBlockersToRender;};f.prototype._setColumns=function(i){this._iColumns=i;this.getAggregation("_columnHeaders").setDays(i);};f.prototype._getColumns=function(){return this._iColumns;};f.prototype._getRowHeight=function(){return R;};f.prototype._getBlockerRowHeight=function(){return B;};f.prototype._getCoreLocaleId=function(){if(!this._sLocale){this._sLocale=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().toString();}return this._sLocale;};f.prototype._getCoreLocaleData=function(){var l,o;if(!this._oLocaleData){l=this._getCoreLocaleId();o=new a(l);this._oLocaleData=L.getInstance(o);}return this._oLocaleData;};f.prototype._hasAMPM=function(){var l=this._getCoreLocaleData();return l.getTimePattern("short").search("a")>=0;};f.prototype._getHoursFormat=function(){var l=this._getCoreLocaleId();if(!this._oHoursFormat||this._oHoursFormat.oLocale.toString()!==l){var o=new a(l),p=this._getHoursPattern();this._oHoursFormat=D.getTimeInstance({pattern:p},o);}return this._oHoursFormat;};f.prototype._getHoursPattern=function(){return this._hasAMPM()?"h":"H";};f.prototype._getAMPMFormat=function(){var l=this._getCoreLocaleId(),o=new a(l);if(!this._oAMPMFormat||this._oAMPMFormat.oLocale.toString()!==l){this._oAMPMFormat=D.getTimeInstance({pattern:"a"},o);}return this._oAMPMFormat;};f.prototype._getColumnHeaders=function(){return this.getAggregation("_columnHeaders");};f.prototype._getAppointmentStartEndInfo=function(A){var s=this._oUnifiedRB.getText("CALENDAR_START_TIME"),E=this._oUnifiedRB.getText("CALENDAR_END_TIME"),F=this._oFormatAria.format(A.getStartDate()),g=this._oFormatAria.format(A.getEndDate());return s+": "+F+"; "+E+": "+g;};f.prototype.enhanceAccessibilityState=function(o,A){if(o.getId()===this._getColumnHeaders().getId()){A.labelledby=I.getStaticId("sap.m","PLANNINGCALENDAR_DAYS");}};return f;});
