/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2017 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','./InputBase','./MaskInput','./MaskInputRule','./ResponsivePopover','sap/ui/core/EnabledPropagator','sap/ui/core/IconPool','sap/ui/model/type/Time','sap/ui/model/odata/type/Time','./TimePickerSliders'],function(q,I,M,a,R,E,b,T,c,d){"use strict";var e=M.extend("sap.m.TimePicker",{metadata:{library:"sap.m",properties:{displayFormat:{type:"string",group:"Appearance",defaultValue:null},valueFormat:{type:"string",group:"Data",defaultValue:null},localeId:{type:"string",group:"Data"},dateValue:{type:"object",group:"Data",defaultValue:null},title:{type:"string",group:"Misc",defaultValue:null},minutesStep:{type:"int",group:"Misc",defaultValue:1},secondsStep:{type:"int",group:"Misc",defaultValue:1}},aggregations:{_picker:{type:"sap.m.ResponsivePopover",multiple:false,visibility:"hidden"}}}});b.insertFontFaceStyle();E.call(e.prototype,true);var f={Short:"short",Medium:"medium",Long:"long"},g={Hour:"hour",Minute:"minute",Second:"second"},P='-';e.prototype.init=function(){M.prototype.init.apply(this,arguments);this.setDisplayFormat(j());this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._bValid=false;this._sUsedDisplayPattern=null;this._sUsedValuePattern=null;this._oDisplayFormat=null;this._sValueFormat=null;this._oPopoverKeydownEventDelegate=null;this._rPlaceholderRegEx=new RegExp(P,'g');this._sLastChangeValue=null;};e.prototype.exit=function(){if(this._oTimeSemanticMaskHelper){this._oTimeSemanticMaskHelper.destroy();}M.prototype.exit.apply(this,arguments);this._removePickerEvents();this._oResourceBundle=null;this._bValid=false;this._sUsedDisplayPattern=null;this._oDisplayFormat=null;this._oPopoverKeydownEventDelegate=null;this._sUsedValuePattern=null;this._sValueFormat=null;this._sLastChangeValue=null;};e.prototype.onBeforeRendering=function(){M.prototype.onBeforeRendering.apply(this,arguments);};e.prototype.ontap=function(o){var i,p;if(!(this.getEditable()&&this.getEnabled())){return;}i=q(o.target).hasClass("sapUiIcon");p=this._getPicker()&&this._getPicker().isOpen();if(!p&&i){this._openPicker();}else if(i&&!sap.ui.Device.system.phone){this._closePicker();}};e.prototype.onfocusin=function(o){var p=this._getPicker();var i=q(o.target).hasClass("sapUiIcon");M.prototype.onfocusin.apply(this,arguments);if(p&&p.isOpen()&&!i){this._closePicker();}};e.prototype.oninput=function(o){M.prototype.oninput.apply(this,arguments);};e.prototype.onfocusout=function(o){M.prototype.onfocusout.apply(this,arguments);};e.prototype.onBeforeOpen=function(){var s=this._getSliders();s.setTimeValues(this.getDateValue());s.collapseAll();this.$().addClass("sapMTPInputActive");};e.prototype.onAfterOpen=function(){var s=this._getSliders();if(s){s._initFocus();this._handleAriaOnExpandCollapse();}};e.prototype.onAfterClose=function(){this.$().removeClass("sapMTPInputActive");this._handleAriaOnExpandCollapse();};e.prototype._handleInputChange=function(v){var D;v=v||this._$input.val();this._bValid=true;if(v!==""){D=this._parseValue(v,true);if(!D){this._bValid=false;}else{v=this._formatValue(D);}}if(this.isActive()&&(this._$input.val()!==v)){this.updateDomValue(v);if(this.bShowLabelAsPlaceholder){this.$("placeholder").css("display",v?"none":"inline");}}if(D){v=this._formatValue(D,true);}this.setProperty("value",v,true);if(this._bValid){this.setProperty("dateValue",D,true);}this.fireChangeEvent(v,{valid:this._bValid});return true;};e.prototype.onChange=function(o){var v=o?o.value:null;if(this.getEditable()&&this.getEnabled()){return this._handleInputChange(v);}return false;};e.prototype.setMinutesStep=function(s){var S=this._getSliders();if(S){S.setMinutesStep(s);}return this.setProperty("minutesStep",s,true);};e.prototype.setSecondsStep=function(s){var S=this._getSliders();if(S){S.setSecondsStep(s);}return this.setProperty("secondsStep",s,true);};e.prototype.setTitle=function(t){var s=this._getSliders();if(s){s.setLabelText(t);}this.setProperty("title",t,true);return this;};e.prototype.setValueFormat=function(v){var V=this.getValue(),D;this.setProperty("valueFormat",v,true);if(V){D=this._parseValue(V);if(!D){this._bValid=false;q.sap.log.warning("Value can not be converted to a valid date",this);}else{this._bValid=true;this.setProperty("dateValue",D,true);V=this._formatValue(D);if(this.isActive()){this._synchronizeInput(V);}else{this.setProperty("value",V,true);this._sLastChangeValue=V;}}}return this;};e.prototype.setDisplayFormat=function(D){var o,i;this.setProperty("displayFormat",D,true);this._initMask();i=this.getDateValue();if(!i){return this;}o=this._formatValue(i);if(this.isActive()){this._synchronizeInput(o);}return this;};e.prototype.setValue=function(v){var D,o;v=this.validateProperty('value',v);this._initMask();M.prototype.setValue.call(this,v);this._sLastChangeValue=v;this._bValid=true;if(v){D=this._parseValue(v);if(!D){this._bValid=false;q.sap.log.warning("Value can not be converted to a valid date",this);}}if(this._bValid){this.setProperty("dateValue",D,true);}if(D){o=this._formatValue(D);}else{o=v;}if(this.isActive()){this._synchronizeInput(o);}return this;};e.prototype.setDateValue=function(D){var v;if(D&&!(D instanceof Date)){throw new Error("Date must be a JavaScript date object; "+this);}if(q.sap.equal(this.getDateValue(),D)){return this;}this._bValid=true;this.setProperty("dateValue",D,true);v=this._formatValue(D,true);this.setProperty("value",v,true);this._sLastChangeValue=v;if(this.isActive()){v=this._formatValue(D);if(this._$input.val()!==v){this.updateDomValue(v);}}return this;};e.prototype.setLocaleId=function(l){var C=this.getValue();this.setProperty("localeId",l,true);this._initMask();this._oDisplayFormat=null;this._sValueFormat=null;if(C){this.setValue(C);}return this;};e.prototype.getPlaceholder=function(){var p=this.getProperty("placeholder");if(!p){p=this._getFormat();}return p;};e.prototype._getFormat=function(){var F=this._getDisplayFormatPattern();if(!F){F=f.Medium;}if(Object.keys(f).indexOf(F)!==-1){F=j();}return F;};e.prototype.onsappageup=function(o){this._increaseTime(1,g.Hour);o.preventDefault();};e.prototype.onsappageupmodifiers=function(o){if(!(o.ctrlKey||o.metaKey||o.altKey)&&o.shiftKey){this._increaseTime(1,g.Minute);}if(!o.altKey&&o.shiftKey&&(o.ctrlKey||o.metaKey)){this._increaseTime(1,g.Second);}o.preventDefault();};e.prototype.onsappagedown=function(o){this._increaseTime(-1,g.Hour);o.preventDefault();};e.prototype.onsappagedownmodifiers=function(o){if(!(o.ctrlKey||o.metaKey||o.altKey)&&o.shiftKey){this._increaseTime(-1,g.Minute);}if(!o.altKey&&o.shiftKey&&(o.ctrlKey||o.metaKey)){this._increaseTime(-1,g.Second);}o.preventDefault();};e.prototype.onkeydown=function(o){var k=q.sap.KeyCodes,K=o.which||o.keyCode,A=o.altKey,p;if(K===k.F4||(A&&(K===k.ARROW_UP||K===k.ARROW_DOWN))){p=this._getPicker()&&this._getPicker().isOpen();if(!p){this._openPicker();}else{this._closePicker();}o.preventDefault();}else{M.prototype.onkeydown.call(this,o);}};e.prototype._getPicker=function(){return this.getAggregation("_picker");};e.prototype._removePickerEvents=function(){var p,o=this._getPicker();if(o){p=o.getAggregation("_popup");if(typeof this._oPopoverKeydownEventDelegate==='function'){p.removeEventDelegate(this._oPopoverKeydownEventDelegate);}}};e.prototype._openPicker=function(){var p=this._getPicker(),s;if(!p){p=this._createPicker(this._getDisplayFormatPattern());}p.open();s=this._getSliders();q.sap.delayedCall(0,s,s.updateSlidersValues);return p;};e.prototype._closePicker=function(){var p=this._getPicker();if(p){p.close();}else{q.sap.log.warning("There is no picker to close.");}return p;};e.prototype._synchronizeInput=function(v){if((this._$input.val()!==v)){this.updateDomValue(v);}};e.prototype._createPicker=function(F){var t=this,p,o,r,O,C,s;r=sap.ui.getCore().getLibraryResourceBundle("sap.m");O=r.getText("TIMEPICKER_SET");C=r.getText("TIMEPICKER_CANCEL");s=this.getTitle();o=new R(t.getId()+"-RP",{showCloseButton:false,showHeader:false,horizontalScrolling:false,verticalScrolling:false,placement:sap.m.PlacementType.VerticalPreferedBottom,beginButton:new sap.m.Button({text:O,press:q.proxy(this._handleOkPress,this)}),endButton:new sap.m.Button({text:C,press:q.proxy(this._handleCancelPress,this)}),content:[new d(this.getId()+"-sliders",{format:F,labelText:s?s:"",invokedBy:t.getId(),minutesStep:this.getMinutesStep(),secondsStep:this.getSecondsStep()})],contentHeight:e._PICKER_CONTENT_HEIGHT});p=o.getAggregation("_popup");if(p.setShowArrow){p.setShowArrow(false);}p.oPopup.setAutoCloseAreas([this.getDomRef("icon")]);o.addStyleClass(this.getRenderer().CSS_CLASS+"DropDown").attachBeforeOpen(this.onBeforeOpen,this).attachAfterOpen(this.onAfterOpen,this).attachAfterClose(this.onAfterClose,this);o.open=function(){return this.openBy(t);};if(sap.ui.Device.system.desktop){this._oPopoverKeydownEventDelegate={onkeydown:function(i){var k=q.sap.KeyCodes,K=i.which||i.keyCode,A=i.altKey;if((A&&(K===k.ARROW_UP||K===k.ARROW_DOWN))||K===k.F4){this._handleOkPress(i);this.focus();i.preventDefault();}}};p.addEventDelegate(this._oPopoverKeydownEventDelegate,this);p._afterAdjustPositionAndArrowHook=function(){t._getSliders()._onOrientationChanged();};}this.setAggregation("_picker",o,true);return o;};e.prototype._getSliders=function(){var p=this._getPicker();if(!p){return null;}return p.getContent()[0];};e.prototype._handleOkPress=function(o){var D=this._getSliders().getTimeValues(),v=this._formatValue(D);this.updateDomValue(v);this._handleInputChange();this._closePicker();};e.prototype._handleCancelPress=function(o){this._closePicker();};e.prototype._parseValue=function(v,D){var F=this._getFormatter(D);if(D){v=this._oTimeSemanticMaskHelper.stripValueOfLeadingSpaces(v);v=v.replace(this._rPlaceholderRegEx,'');}return F.parse(v);};e.prototype._formatValue=function(D,v){var V="",F;if(D){F=this._getFormatter(!v);V=F.format(D);if(!v&&this._oTimeSemanticMaskHelper){V=this._oTimeSemanticMaskHelper.formatValueWithLeadingTrailingSpaces(V);}}return V;};e.prototype._handleAriaOnExpandCollapse=function(){this.getFocusDomRef().setAttribute("aria-expanded",this._getPicker().isOpen());};e.prototype._increaseTime=function(n,u){var o=this.getDateValue(),D,m;if(o&&this.getEditable()&&this.getEnabled()){D=new Date(o.getTime());switch(u){case g.Hour:D.setHours(D.getHours()+n);m=60*60*1000;break;case g.Minute:D.setMinutes(D.getMinutes()+n);m=60*1000;break;case g.Second:m=1000;D.setSeconds(D.getSeconds()+n);}if(n<0&&D.getTime()-o.getTime()!==n*m){D=new Date(o.getTime()+n*m);}this.setDateValue(D);this.fireChangeEvent(this.getValue(),{valid:true});}};e.prototype._getFormatter=function(D){var p=this._getBoundValueTypePattern(),r=false,F,B=this.getBinding("value");if(B&&B.oType&&B.oType.oOutputFormat){r=!!B.oType.oOutputFormat.oFormatOptions.relative;}if(!p){if(D){p=(this.getDisplayFormat()||f.Medium);}else{p=(this.getValueFormat()||f.Medium);}}if(D){if(p===this._sUsedDisplayPattern){F=this._oDisplayFormat;}}else{if(p===this._sUsedValuePattern){F=this._sValueFormat;}}if(F){return F;}if(p===f.Short||p===f.Medium||p===f.Long){F=sap.ui.core.format.DateFormat.getTimeInstance({style:p,strictParsing:true,relative:r},new sap.ui.core.Locale(this.getLocaleId()));}else{F=sap.ui.core.format.DateFormat.getTimeInstance({pattern:p,strictParsing:true,relative:r},new sap.ui.core.Locale(this.getLocaleId()));}if(D){this._sUsedDisplayPattern=p;this._oDisplayFormat=F;}else{this._sUsedValuePattern=p;this._sValueFormat=F;}return F;};e.prototype._initMask=function(){if(this._oTimeSemanticMaskHelper){this._oTimeSemanticMaskHelper.destroy();}this._oTimeSemanticMaskHelper=new h(this);};e.prototype.fireChangeEvent=function(v,p){if(v){v=v.trim();}if(v!==this._sLastChangeValue){this._sLastChangeValue=v;I.prototype.fireChangeEvent.call(this,v,p);}};var h=function(t){var D=t._getDisplayFormatPattern(),m=D,A,l=t.getLocaleId()||sap.ui.getCore().getConfiguration().getFormatLocale(),L=new sap.ui.core.Locale(l),i;t.setProperty("localeId",l,true);this._oTimePicker=t;this.aOriginalAmPmValues=sap.ui.core.LocaleData.getInstance(L).getDayPeriods("abbreviated");this.aAmPmValues=this.aOriginalAmPmValues.slice(0);this.iAmPmValueMaxLength=Math.max(this.aAmPmValues[0].length,this.aAmPmValues[1].length);for(i=0;i<this.aAmPmValues.length;i++){while(this.aAmPmValues[i].length<this.iAmPmValueMaxLength){this.aAmPmValues[i]+=" ";}}this.b24H=D.indexOf("H")!==-1;this.bLeadingZero=D.indexOf("HH")!==-1||D.indexOf("hh")!==-1;this.sLeadingChar=this.bLeadingZero?"0":" ";this.sAlternativeLeadingChar=this.bLeadingZero?" ":"0";this.sLeadingRegexChar=this.bLeadingZero?"0":"\\s";t.setPlaceholderSymbol(P);m=m.replace(/hh/ig,"h").replace(/h/ig,"h9");if(this.b24H){A="["+this.sLeadingRegexChar+"012]";}else{A="["+this.sLeadingRegexChar+"1]";}this._maskRuleHours=new a({maskFormatSymbol:"h",regex:A});t.addRule(this._maskRuleHours);this.iHourNumber1Index=m.indexOf("h9");this.iHourNumber2Index=this.iHourNumber1Index!==-1?this.iHourNumber1Index+1:-1;this.iMinuteNumber1Index=m.indexOf("mm");m=m.replace(/mm/g,"59");this.iSecondNumber1Index=m.indexOf("ss");m=m.replace(/ss/g,"59");this._maskRuleMinSec=new a({maskFormatSymbol:"5",regex:"[0-5]"});t.addRule(this._maskRuleMinSec);this.aAllowedHours=r.call(this,this.b24H,this.sLeadingChar);this.aAllowedMinutesAndSeconds=u.call(this);this.iAmPmChar1Index=m.indexOf("a");this.iAfterAmPmValueIndex=-1;if(this.iAmPmChar1Index!==-1){this.iAfterAmPmValueIndex=this.iAmPmChar1Index+this.iAmPmValueMaxLength;var C=this.iAmPmValueMaxLength-"a".length;this.shiftIndexes(C);var k=65;var s="";var n="";var o="";for(i=0;i<this.iAmPmValueMaxLength;i++){n="[";if(this.aAmPmValues[0][i]){n+=this.aAmPmValues[0][i];}else{n+="\\s";}if(this.aAmPmValues[1][i]!==this.aAmPmValues[0][i]){if(this.aAmPmValues[1][i]){n+=this.aAmPmValues[1][i];}else{n+="\\s";}}n+="]";o=String.fromCharCode(k++);s+=o;this._maskRuleChars=new a({maskFormatSymbol:o,regex:n});t.addRule(this._maskRuleChars);}m=m.replace(/a/g,s);}t.setMask(m);function p(S,v,w){var x=[],y,i;for(i=S;i<=v;i++){y=i.toString();if(i<10){y=w+y;}x.push(y);}return x;}function r(v,w){var S=v?0:1,x=v?23:12;return p(S,x,w);}function u(){return p(0,59,"0");}};h.prototype.replaceChar=function(C,p,s){var A=p-this.iAmPmChar1Index,k,l,m,S,n,o,i;if(p===this.iHourNumber1Index&&this.sAlternativeLeadingChar===C){if(this.aAllowedHours.indexOf(this.sLeadingChar+C)!==-1){return this.sLeadingChar+C;}else{return this.sLeadingChar;}}else if(p===this.iHourNumber1Index&&!this._oTimePicker._isCharAllowed(C,p)&&this.aAllowedHours.indexOf(this.sLeadingChar+C)!==-1){return this.sLeadingChar+C;}else if(p===this.iHourNumber2Index&&this.aAllowedHours.indexOf(s[this.iHourNumber1Index]+C)===-1){return"";}else if((p===this.iMinuteNumber1Index||p===this.iSecondNumber1Index)&&!this._oTimePicker._isCharAllowed(C,p)&&this.aAllowedMinutesAndSeconds.indexOf("0"+C)!==-1){return"0"+C;}else if(A>=0&&p<this.iAfterAmPmValueIndex){k=s.slice(this.iAmPmChar1Index,p);l=this.aAmPmValues[0].slice(0,A);m=this.aAmPmValues[1].slice(0,A);n=this.aAmPmValues[0].slice(A,this.iAfterAmPmValueIndex);o=this.aAmPmValues[1].slice(A,this.iAfterAmPmValueIndex);S=(l===m);var r="";for(i=A;i<this.iAmPmValueMaxLength;i++){if(this.aAmPmValues[0][i]===this.aAmPmValues[1][i]){r+=this.aAmPmValues[0][i];}else{break;}}if(i===this.iAmPmValueMaxLength||i!==A){return r;}else{if(!S){if(k===l){return n;}else if(k===m){return o;}else{return C;}}else{if(this.aAmPmValues[0][A].toLowerCase()===C.toLowerCase()&&this.aAmPmValues[0]===k+n){return n;}else if(this.aAmPmValues[1][A].toLowerCase()===C.toLowerCase()&&this.aAmPmValues[1]===k+o){return o;}else{return C;}}}}else{return C;}};h.prototype.formatValueWithLeadingTrailingSpaces=function(v){var m=this._oTimePicker.getMask().length;if(this.aOriginalAmPmValues[0]!==this.aAmPmValues[0]){v=v.replace(this.aOriginalAmPmValues[0],this.aAmPmValues[0]);}if(this.aOriginalAmPmValues[1]!==this.aAmPmValues[1]){v=v.replace(this.aOriginalAmPmValues[1],this.aAmPmValues[1]);}while(m>v.length){v=[v.slice(0,this.iHourNumber1Index)," ",v.slice(this.iHourNumber1Index)].join('');}return v;};h.prototype.stripValueOfLeadingSpaces=function(v){if(v[this.iHourNumber1Index]===" "){v=[v.slice(0,this.iHourNumber1Index),v.slice(this.iHourNumber1Index+1)].join('');}return v;};h.prototype.shiftIndexes=function(s){if(this.iAmPmChar1Index<this.iHourNumber1Index){this.iHourNumber1Index+=s;this.iHourNumber2Index+=s;}if(this.iAmPmChar1Index<this.iMinuteNumber1Index){this.iMinuteNumber1Index+=s;}if(this.iAmPmChar1Index<this.iSecondNumber1Index){this.iSecondNumber1Index+=s;}};h.prototype.destroy=function(){if(this._maskRuleHours){this._maskRuleHours.destroy();this._maskRuleHours=null;}if(this._maskRuleMinSec){this._maskRuleMinSec.destroy();this._maskRuleMinSec=null;}if(this._maskRuleChars){this._maskRuleChars.destroy();this._maskRuleChars=null;}};e.prototype._feedReplaceChar=function(C,p,s){return this._oTimeSemanticMaskHelper.replaceChar(C,p,s);};e.prototype.getAccessibilityInfo=function(){var r=this.getRenderer();var i=M.prototype.getAccessibilityInfo.apply(this,arguments);var v=this.getValue()||"";if(this._bValid){var D=this.getDateValue();if(D){v=this._formatValue(D);}}i.role="combobox";i.type=sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("ACC_CTR_TYPE_TIMEINPUT");i.description=[v,r.getLabelledByAnnouncement(this),r.getDescribedByAnnouncement(this)].join(" ").trim();return i;};function j(){var l=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale(),L=sap.ui.core.LocaleData.getInstance(l);return L.getTimePattern(f.Medium);}e.prototype._getDisplayFormatPattern=function(){return this._getBoundValueTypePattern()||this.getDisplayFormat();};e.prototype._getBoundValueTypePattern=function(){var B=this.getBinding("value"),o=B&&B.getType&&B.getType();if(o instanceof T){return o.getOutputPattern();}if(o instanceof c&&o.oFormat){return o.oFormat.oFormatOptions.pattern;}return undefined;};e._PICKER_CONTENT_HEIGHT="25rem";return e;},true);
